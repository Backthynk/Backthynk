function t(){const t=document.documentElement.classList.toggle("dark");localStorage.setItem("darkMode",t),"function"==typeof updateActivityHeatmapColors&&updateActivityHeatmapColors()}"true"===localStorage.getItem("darkMode")?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark"),document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("theme-toggle-btn");e&&e.addEventListener("click",t)});const e={success:{categoryDeleted:"deleted successfully!",postMoved:"Post successfully moved to",settingsSaved:"Settings saved successfully!"},error:{categoryNameEmpty:"Category name cannot be empty",categoryNameTooLong:"Category name must be {0} characters or less",categoryNameInvalidChars:"Category name can only contain letters, numbers, and single spaces",categoryDescTooLong:"Description cannot exceed {0} characters",noCategorySelected:"No category selected",pleaseSelectCategory:"Please select a category first",contentRequired:"Content is required",contentTooLong:"Content exceeds maximum length of {0} characters",contentExceedsMax:"Content exceeds maximum length",maxFilesExceeded:"Maximum {0} files allowed per post",fileSizeExceeded:'File "{0}" exceeds maximum file size of {1}MB',failedToLoadSettings:"Failed to load settings: {0}",failedToSaveSettings:"Failed to save settings: {0}",failedToDeleteCategory:"Failed to delete category: {0}",failedToDeletePost:"Failed to delete post: {0}",selectCategoryToMove:"Please select a category to move the post to."},validation:{fileSizeValidation:"Maximum file size must be between {0}MB and {1}MB ({2}GB)",contentLengthValidation:"Maximum content length must be between {0} and {1} characters",filesPerPostValidation:"Maximum files per post must be between {0} and {1}"},info:{savingSettings:"Saving settings...",settingsResetInfo:"Settings reset to defaults (not saved yet). Storage path is not changed as it requires server restart.",resetSettingsConfirm:"Are you sure you want to reset all settings to their default values?",loadingMorePosts:"Loading more posts...",noActivityData:"No activity data available"},confirm:{unsavedContent:"You have unsaved content. Are you sure you want to close?",deleteCategory:"Are you sure you want to delete",undoWarning:"\n\nThis action cannot be undone."},fileUpload:{dragDropText:"Or drag and drop files here (max {0} files)"}};window.AppConstants={APP_NAME:"Backthynk",APP_TAGLINE:"Personal Micro Blog",APP_DESCRIPTION:"Personal micro blog platform",RESERVED_ROUTES:["api","static","uploads","settings"],ALL_CATEGORIES_ID:0,MAX_CATEGORY_DEPTH:2,DEFAULT_SETTINGS:{maxFileSizeMB:100,maxContentLength:15e3,maxFilesPerPost:20,activityEnabled:!0,fileStatsEnabled:!0,retroactivePostingEnabled:!1,retroactivePostingTimeFormat:"24h"},VALIDATION_LIMITS:{minFileSizeMB:1,maxFileSizeMB:10240,minContentLength:100,maxContentLength:5e4,minFilesPerPost:1,maxFilesPerPost:50,maxCategoryNameLength:30,maxCategoryDescriptionLength:280,maxSiteTitleLength:100,maxSiteDescriptionLength:160},ERROR_MESSAGES:e.validation,USER_MESSAGES:e,UI_CONFIG:{defaultPostLimit:20,maxPostLimit:100,defaultOffset:0,virtualScrollBuffer:5,defaultItemHeight:200,postsVirtualScrollHeight:250,heatmapSquaresPerRow:10,currentActivityPeriod:0,defaultPostsPerPage:20,infiniteScrollThreshold:1e3,virtualScrollThreshold:50,categoryBatchLimit:100,maxFilenameDisplay:200,maxUrlDisplayLength:30,defaultImageIndex:0,debounceDelay:500,successMessageDelay:1500,scrollThreshold:50,settingsTransitionDelay:100,fileSizeUnit:1024,minutesInMs:6e4,hoursInMs:36e5,daysInMs:864e5,weekInDays:7},ACTIVITY_LEVELS:{none:0,low:1,medium:2,high:3,veryHigh:4},ACTIVITY_THRESHOLDS:{low:1,medium:3,high:5},ACTIVITY_CLASSES:["bg-gray-100","bg-green-200","bg-green-300","bg-green-400","bg-green-500"],ACTIVITY_CLASSES_DARK:["dark:bg-gray-700","dark:bg-[#0e4429]","dark:bg-[#006d32]","dark:bg-[#26a641]","dark:bg-[#39d353]"],UI_TEXT:{post:"post",posts:"posts",day:"day",days:"days",on:"on",less:"Less",more:"More",all:"All",categories:"Categories",allCategories:"All Categories",settings:"Settings",now:"now",ago:"ago",minutesAgo:"m ago",hoursAgo:"h ago",daysAgo:"d ago",bytes:"Bytes",kb:"KB",mb:"MB",gb:"GB",zeroBytes:"0 Bytes",save:"Save",cancel:"Cancel",delete:"Delete",edit:"Edit",create:"Create",update:"Update",loading:"Loading",error:"Error",failed:"Failed",success:"Success",next:"Next",previous:"Previous",file:"file",files:"files",upload:"Upload",download:"Download",content:"Content",attachments:"Attachments",createNewPost:"Create New Post",fileUploadSettings:"File Upload Settings",contentSettings:"Content Settings",performanceSettings:"Performance Settings",activityTracking:"Activity Tracking",fileStatistics:"Category Detailed",noPostsYet:"No posts yet. Create your first post!",noCategoriesYet:"No categories yet. Create your first category!",noFilesSelected:"No files selected",chooseFiles:"Choose Files",ellipsis:"...",colon:":",dash:"-"},LOCALE_SETTINGS:{default:"en-US"},DATE_FORMAT:{monthStyle:"short",timezone:"UTC",format12h:"MM/DD/YYYY HH:MM AM/PM",format24h:"DD/MM/YYYY HH:MM"},TIME_FORMAT:{am:"AM",pm:"PM"},STORAGE_KEYS:{lastCategory:"lastSelectedCategory",expandedCategories:"expandedCategories",recursiveStates:"recursiveToggleStates",categorySortPref:"categorySortPreference"},FILE_EXTENSIONS:{code:[".js",".py",".java",".cpp",".c",".cs",".php",".rb",".go",".rs",".ts",".jsx",".tsx",".vue",".swift",".kt",".scala",".sh",".bat",".ps1",".r",".m",".h",".hpp",".css",".scss",".sass",".less",".html",".xml",".json",".yaml",".yml",".toml",".ini",".cfg",".conf",".sql"],archive:[".zip",".rar",".7z",".tar",".gz",".bz2",".xz",".tgz"],document:[".pdf",".doc",".docx",".xls",".xlsx",".ppt",".pptx",".txt",".rtf",".odt",".ods",".odp"],image:[".jpg",".jpeg",".png",".gif",".webp",".bmp",".svg",".ico",".tiff",".tif"],video:[".mp4",".webm",".avi",".mov",".mkv",".flv",".wmv",".m4v"],audio:[".mp3",".wav",".ogg",".m4a",".flac",".aac",".wma"]},DEFAULT_ALLOWED_EXTENSIONS:"jpg, jpeg, png, gif, webp, pdf, doc, docx, xls, xlsx, txt, zip, mp4, mov, avi",FILE_LANGUAGE_MAP:{js:"JavaScript",py:"Python",java:"Java",cpp:"C++",c:"C",cs:"C#",go:"Go",rs:"Rust"},VIDEO_FORMAT_MAP:{mp4:"MP4",webm:"WEBM",avi:"AVI",mov:"MOV",mkv:"MKV",flv:"FLV",wmv:"WMV",m4v:"M4V"},AUDIO_FORMAT_MAP:{mp3:"MP3",wav:"WAV",ogg:"OGG",m4a:"M4A",flac:"FLAC",aac:"AAC",wma:"WMA"},FILE_ICON_MAP:{code:{extensions:["js","ts","jsx","tsx","vue","react","html","htm","xml","py","python","c","cpp","cc","h","hpp","cs","csharp","php","go","rs","rust","swift","kt","kotlin","dart","m","mm","scala","clj","clojure","hs","haskell","lua","perl","pl"],icon:"fa-code"},palette:{extensions:["css","scss","sass","less"],icon:"fa-palette"},coffee:{extensions:["java","jar"],icon:"fa-coffee"},gem:{extensions:["rb","ruby"],icon:"fa-gem"},chartLine:{extensions:["r"],icon:"fa-chart-line"},terminal:{extensions:["sh","bash","zsh","fish","bat","cmd","ps1","powershell"],icon:"fa-terminal"},pdf:{extensions:["pdf"],icon:"fa-file-pdf"},word:{extensions:["doc","docx"],icon:"fa-file-word"},excel:{extensions:["xls","xlsx"],icon:"fa-file-excel"},powerpoint:{extensions:["ppt","pptx"],icon:"fa-file-powerpoint"},text:{extensions:["txt","text","rtf","odt","ods","odp","md","markdown","rst"],icon:"fa-file-alt"},image:{extensions:["jpg","jpeg","png","gif","bmp","svg","webp","ico","tiff","tif"],icon:"fa-image"},audio:{extensions:["mp3","wav","flac","aac","ogg","wma","m4a"],icon:"fa-file-audio"},video:{extensions:["mp4","avi","mkv","mov","wmv","flv","webm","m4v"],icon:"fa-file-video"},archive:{extensions:["zip","rar","7z","tar","gz","bz2","xz"],icon:"fa-file-archive"},config:{extensions:["json","xml","yaml","yml","toml","ini","cfg","conf"],icon:"fa-cog"},table:{extensions:["csv","tsv"],icon:"fa-table"},database:{extensions:["sql","db","sqlite"],icon:"fa-database"}},MIN_RETROACTIVE_POST_TIMESTAMP:9466848e5};const n=new class{constructor(){this.routes=new Map,this.currentRoute=null,this.currentCategoryPath=null,window.addEventListener("popstate",t=>{this.handleRoute(window.location.pathname,!1)})}addRoute(t,e){this.routes.set(t,e)}navigate(t,e=!0){e&&window.history.pushState({},"",t),this.handleRoute(t,!1)}handleRoute(t,e=!0){const n="/"===t?"/":t.replace(/\/$/,"");if(this.routes.has(n)){this.currentRoute=n,this.currentCategoryPath=null;this.routes.get(n)()}else this.isCategoryPath(n)?(this.currentRoute="category",this.currentCategoryPath=n,this.handleCategoryRoute(n)):(this.currentRoute="/",this.currentCategoryPath=null,this.routes.has("/")&&this.routes.get("/")())}init(){this.isCategoryPath(window.location.pathname)||this.handleRoute(window.location.pathname,!1)}getCurrentRoute(){return this.currentRoute}getCurrentCategoryPath(){return this.currentCategoryPath}isCategoryPath(t){if("/"===t)return!1;for(const e of window.AppConstants.RESERVED_ROUTES)if(t==="/"+e)return!1;return/^\/[a-zA-Z0-9\s\/%]+$/.test(t)&&!t.includes("//")}async handleCategoryRoute(t){if(void 0===a||!a||0===a.length)return void setTimeout(()=>this.handleCategoryRoute(t),100);const e=this.findCategoryByPath(t);e?await this.showCategoryPage(e):this.navigate("/",!0)}findCategoryByPath(t){const e=t.split("/").filter(t=>t.length>0);if(0===e.length)return null;let n=null,o=a.filter(t=>!t.parent_id);for(let t=0;t<e.length;t++){const i=e[t],s=decodeURIComponent(i);if(n=o.find(t=>t.name.toLowerCase()===s.toLowerCase()),!n)return null;o=a.filter(t=>t.parent_id===n.id)}return n}buildCategoryPath(t){const e=[];let n=t;for(;n;)e.unshift(encodeURIComponent(n.name)),n=n.parent_id?a.find(t=>t.id===n.parent_id):null;return"/"+e.join("/")}async showCategoryPage(t){const e=document.querySelector(".container"),n=document.getElementById("settings-page");e&&(e.style.display="block"),n&&n.classList.add("hidden"),z(t,!1);const o=await T();o?.siteTitle||window.AppConstants.APP_NAME;if(t&&t.id){const e=q(t.id);document.title=`${e}`}}navigateToCategory(t){if(!t)return void this.navigate("/");const e=this.buildCategoryPath(t);this.navigate(e)}checkCachedCategoryRedirect(){if("/"!==window.location.pathname)return!1;const t=localStorage.getItem(window.AppConstants.STORAGE_KEYS.lastCategory);if(t&&a&&a.length>0){const e=a.find(e=>e.id===parseInt(t));if(e){const t=this.buildCategoryPath(e);return this.navigate(t,!0),!0}}return!1}};async function o(){const t=document.querySelector(".container"),e=document.getElementById("settings-page");t&&(t.style.display="none"),e&&e.classList.remove("hidden");try{await Yt(),qt();const t=await T(),e=t?.siteTitle||window.AppConstants.APP_NAME;document.title=`${e} - Settings`}catch(t){console.error("Failed to load settings:",t),x(w(window.AppConstants.USER_MESSAGES.error.failedToLoadSettings,t.message))}}n.addRoute("/",async function(){const t=document.querySelector(".container"),e=document.getElementById("settings-page");t&&(t.style.display="block"),e&&e.classList.add("hidden");const n=await T(),o=n?.siteTitle||window.AppConstants.APP_NAME;document.title=`${o}`,void 0!==i&&i&&i.id!==window.AppConstants?.ALL_CATEGORIES_ID&&V()}),n.addRoute("/settings",o),document.addEventListener("DOMContentLoaded",function(){n.init()}),window.router=n;let i=null,a=[],s=new Set,r=new Map,d=new Map,l=0,c=[],m=window.AppConstants.UI_CONFIG.defaultImageIndex,u=window.AppConstants.UI_CONFIG.currentActivityPeriod,p=!0,g=!0;function y(){localStorage.setItem(window.AppConstants.STORAGE_KEYS.expandedCategories,JSON.stringify([...s]))}async function f(){try{const t=window.currentSettings||await T();p=void 0!==t.activityEnabled?t.activityEnabled:window.AppConstants.DEFAULT_SETTINGS.activityEnabled}catch(t){console.warn("Failed to check activity status, using default:",t),p=window.AppConstants.DEFAULT_SETTINGS.activityEnabled}!function(){const t=document.getElementById("activity-container");t&&(t.style.display=p?"":"none")}()}async function h(){try{const t=window.currentSettings||await T();g=void 0!==t.fileStatsEnabled?t.fileStatsEnabled:window.AppConstants.DEFAULT_SETTINGS.fileStatsEnabled}catch(t){console.warn("Failed to check file stats status, using default:",t),g=window.AppConstants.DEFAULT_SETTINGS.fileStatsEnabled}}function w(t,...e){return t.replace(/{(\d+)}/g,(t,n)=>void 0!==e[n]?e[n]:t)}function v(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}function E(t){if(0===t)return window.AppConstants.UI_TEXT.zeroBytes;const e=window.AppConstants.UI_CONFIG.fileSizeUnit,n=[window.AppConstants.UI_TEXT.bytes,window.AppConstants.UI_TEXT.kb,window.AppConstants.UI_TEXT.mb,window.AppConstants.UI_TEXT.gb],o=Math.floor(Math.log(t)/Math.log(e));return parseFloat((t/Math.pow(e,o)).toFixed(2))+" "+n[o]}function x(t){window.showError&&window.showError!==x?window.showError(t):alert(t)}function I(t,e,n=null){return new Promise(o=>{const i=document.getElementById("confirmation-modal"),a=document.getElementById("confirmation-title"),s=document.getElementById("confirmation-message"),r=document.getElementById("confirmation-details"),d=document.getElementById("confirmation-confirm"),l=document.getElementById("confirmation-cancel");a.textContent=t;const c=e.replace(/\*\*(.*?)\*\*/g,'<strong class="font-bold text-black">$1</strong>');s.innerHTML=c.replace(/\n/g,"<br>"),n?(r.innerHTML=n,r.style.display="block"):(r.innerHTML="",r.style.display="none"),i.classList.remove("hidden"),document.body.style.overflow="hidden";const m=()=>{g(),o(!0)},u=()=>{g(),o(!1)},p=t=>{"Escape"===t.key&&(g(),o(!1))},g=()=>{i.classList.add("hidden"),document.body.style.overflow="",d.removeEventListener("click",m),l.removeEventListener("click",u),document.removeEventListener("keydown",p)};d.addEventListener("click",m),l.addEventListener("click",u),document.addEventListener("keydown",p)})}function S(t){const e=[];let n=t;n=n.replace(/(https?:\/\/[^\s<>"]+)/g,t=>{const n=`__URL_PLACEHOLDER_${e.length}__`,o=function(t,e=window.AppConstants.UI_CONFIG.maxUrlDisplayLength){try{const n=new URL(t);let o=n.hostname;if(n.port&&!("http:"===n.protocol&&"80"===n.port||"https:"===n.protocol&&"443"===n.port)&&(o+=":"+n.port),"/"!==n.pathname&&o.length<e-5){const t=n.pathname.substring(0,e-o.length-3);o+=t,n.pathname.length>t.length&&(o+="...")}return o.length>e&&(o=o.substring(0,e-3)+"..."),o}catch(n){return t.length>e?t.substring(0,e-3)+window.AppConstants.UI_TEXT.ellipsis:t}}(t);return e.push(`<a href="${v(t)}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 font-semibold hover:underline transition-colors">${v(o)}</a>`),n});n=n.replace(/\b([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})\b/g,t=>{const n=`__URL_PLACEHOLDER_${e.length}__`;return e.push(`<a href="mailto:${v(t)}" class="text-blue-600 hover:text-blue-800 font-semibold hover:underline transition-colors">${v(t)}</a>`),n});n=n.replace(/\b(?<![@\/])(?:www\.)?([a-zA-Z0-9][-a-zA-Z0-9]{0,62}\.)+[a-zA-Z]{2,}\b(?!["\s]*@)/g,t=>{const n=`__URL_PLACEHOLDER_${e.length}__`,o=(t.startsWith("www."),`https://${t}`);return e.push(`<a href="${v(o)}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 font-semibold hover:underline transition-colors">${v(t)}</a>`),n});let o=v(n);return e.forEach((t,e)=>{o=o.replace(`__URL_PLACEHOLDER_${e}__`,t)}),o}function b(t){const e=t.toLowerCase();for(const t of Object.values(window.AppConstants.FILE_ICON_MAP))if(t.extensions.includes(e))return t.icon;return"fa-file"}window.alertSystem=new class{constructor(){this.timeout=null,this.isActive=!1,this.container=null,this.initializeContainer()}initializeContainer(){this.container=document.createElement("div"),this.container.className="alert-container",this.container.innerHTML='\n<div class="alert-dropdown">\n<span class="alert-text"></span>\n</div>\n',document.body.appendChild(this.container),this.addStyles()}addStyles(){}show(t,e="success"){return new Promise(n=>{this.clearTimeout(),this.isActive?this.hideImmediate().then(()=>{setTimeout(()=>this.displayMessage(t,e,n),50)}):this.displayMessage(t,e,n)})}displayMessage(t,e,n){const o=this.container.querySelector(".alert-dropdown"),i=o.querySelector(".alert-text");o.className="alert-dropdown",o.classList.add(e),i.textContent=t,this.isActive=!0,o.offsetHeight,requestAnimationFrame(()=>{o.classList.add("show");const t="success"===e?2e3:4e3;this.timeout=setTimeout(()=>{this.hide().then(n)},t)})}hide(){return new Promise(t=>{if(!this.isActive)return void t();const e=this.container.querySelector(".alert-dropdown");e.classList.remove("show"),e.classList.add("hide"),setTimeout(()=>{this.isActive=!1,e.classList.remove("hide"),t()},250)})}hideImmediate(){return new Promise(t=>{if(!this.isActive)return void t();const e=this.container.querySelector(".alert-dropdown");e.classList.remove("show"),e.classList.add("hide"),setTimeout(()=>{this.isActive=!1,e.classList.remove("hide"),t()},100)})}clearTimeout(){this.timeout&&(clearTimeout(this.timeout),this.timeout=null)}},window.showSuccess=t=>window.alertSystem.show(t,"success"),window.showError=t=>window.alertSystem.show(t,"error"),window.showWarning=t=>window.alertSystem.show(t,"warning"),window.showInfo=t=>window.alertSystem.show(t,"info");let A=null,C=null;async function T(t=!1){if(A&&!t)return A;if(C&&!t)return await C;C=async function(){try{const t=await fetch("/api/settings");return t.ok?await t.json():{...window.AppConstants.DEFAULT_SETTINGS}}catch(t){return console.error("Failed to load settings, using defaults:",t),{...window.AppConstants.DEFAULT_SETTINGS}}}();try{return A=await C,A}finally{C=null}}function L(){A=null,C=null}async function _(t,e={}){const n=await fetch(`/api${t}`,{headers:{"Content-Type":"application/json",...e.headers},...e});if(!n.ok){const t=await n.text();throw new Error(t)}const o=await n.text();if(!o||""===o.trim())return null;try{return JSON.parse(o)||null}catch(t){return console.error("Failed to parse JSON response:",t),null}}async function k(t=!1){try{if(a=await _("/categories"),a&&Array.isArray(a)||(a=[]),Y(),t||(G(),de()),void 0!==n)"/"!==window.location.pathname&&n.isCategoryPath&&n.isCategoryPath(window.location.pathname)?n.handleRoute(window.location.pathname,!1):n.checkCachedCategoryRedirect&&(n.checkCachedCategoryRedirect()||await V());else{const t=localStorage.getItem(window.AppConstants.STORAGE_KEYS.lastCategory);if(t){const e=a.find(e=>e.id==t);e?z(e):await V()}else await V()}}catch(t){console.error("Failed to fetch categories:",t),a=[],G(),de()}}async function M(t,e=window.AppConstants.UI_CONFIG.defaultPostLimit,n=window.AppConstants.UI_CONFIG.defaultOffset,o=!1,i=!1){try{const a=new URLSearchParams({limit:e.toString(),offset:n.toString()});o&&a.set("with_meta","true"),i&&a.set("recursive","true");return await _(`/categories/${t}/posts?${a.toString()}`)||{posts:[],has_more:!1}}catch(t){return console.error("Failed to fetch posts:",t),{posts:[],has_more:!1}}}async function B(t,e=!1){try{if(!(await T()).fileStatsEnabled)return{file_count:0,total_size:0,last_updated:0};const n=new URLSearchParams({recursive:e.toString()}),o=await _(`/category-stats/${t}?${n.toString()}`);return{file_count:o.file_count||0,total_size:o.total_size||0,last_updated:o.last_updated||0}}catch(t){return console.error("Failed to fetch category stats:",t),{file_count:0,total_size:0,last_updated:0}}}async function $(t,e){try{const n=new FormData;n.append("post_id",t),n.append("file",e);const o=await fetch("/api/upload",{method:"POST",body:n});if(!o.ok)throw new Error(await o.text());return o.json()}catch(t){throw console.error("Failed to load file:",t),t}}async function P(t){try{const e=await fetch("/api/settings",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok){const t=await e.text();throw new Error(t||`HTTP error! status: ${e.status}`)}const n=await e.json();return L(),n}catch(t){throw console.error("Failed to save settings:",t),t}}let F=null,D=!1;async function N(){if(D)return;if(!p||!i)return void(document.getElementById("activity-container").style.display="none");D=!0;const t=document.getElementById("activity-container");t.style.display="",t.innerHTML='\n<div class="text-center text-gray-500 dark:text-gray-400 py-16">\n<i class="fas fa-spinner fa-spin text-4xl mb-4"></i>\n<p>Loading activity...</p>\n</div>\n';try{const t=await async function(t,e=!1,n=0){return await async function(t,e,n){try{const o=(window.currentSettings||await T()).activityPeriodMonths||4,i=new URLSearchParams({recursive:e.toString(),period:n.toString(),period_months:o.toString()}),a=await fetch(`/api/activity/${t}?${i}`,{headers:{"Content-Type":"application/json"}});if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);return await a.json()}catch(t){throw console.error("Failed to fetch activity data:",t),t}}(t,e,n)}(i.id,i.recursiveMode||!1,u);if(!t)return void(document.getElementById("activity-container").style.display="none");document.getElementById("activity-container").style.display="",F=t,O(t)}catch(t){console.error("Failed to generate activity heatmap:",t);const e=30*((window.currentSettings||await T()).activityPeriodMonths||4),n=new Date,o=n.toISOString().split("T")[0],i={days:[],start_date:new Date(n.getTime()-24*e*60*60*1e3).toISOString().split("T")[0],end_date:o,stats:{total_posts:0,active_days:0,max_day_activity:0},max_periods:0};F=i,O(i)}finally{D=!1}}function O(t){const e=document.getElementById("activity-container");e.querySelector("#activity-category-breadcrumb")||(e.innerHTML='\n\x3c!-- Category Breadcrumb --\x3e\n<div id="activity-category-breadcrumb" class="mb-4">\n\x3c!-- Breadcrumb will be generated dynamically --\x3e\n</div>\n\n\x3c!-- Centered Date Range with Navigation --\x3e\n<div class="flex items-center justify-center mb-4">\n<button id="activity-prev" class="p-1 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 disabled:opacity-30 mr-3" onclick="changeActivityPeriod(-1)">\n<i class="fas fa-chevron-left text-xs"></i>\n</button>\n<span id="activity-period" class="text-sm text-gray-600 dark:text-gray-400"></span>\n<button id="activity-next" class="p-1 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 disabled:opacity-30 ml-3" onclick="changeActivityPeriod(1)">\n<i class="fas fa-chevron-right text-xs"></i>\n</button>\n</div>\n\n\x3c!-- Heatmap with months on left, heatmap centered --\x3e\n<div class="relative mb-6">\n<div class="flex justify-center">\n<div id="activity-heatmap" class="min-h-16">\n\x3c!-- Heatmap will be generated here --\x3e\n</div>\n</div>\n</div>\n\n\x3c!-- Legend and Summary --\x3e\n<div class="flex items-center justify-between text-xs mt-6">\n<div id="activity-legend" class="flex flex-col space-y-1">\n\x3c!-- Legend will be generated dynamically --\x3e\n</div>\n<span id="activity-summary" class="text-gray-500 dark:text-gray-400"></span>\n</div>\n'),function(){const t=document.getElementById("activity-category-breadcrumb");if(!t)return;if(!i||i.id===window.AppConstants.ALL_CATEGORIES_ID)return void(t.innerHTML=`<span class="text-xs font-semibold text-gray-700 dark:text-gray-300">${window.AppConstants.UI_TEXT.allCategories}</span>`);const e=[];let n=i;for(;n;)e.unshift(n),n=n.parent_id&&a?a.find(t=>t.id===n.parent_id):null;const o=e.map((t,n)=>n===e.length-1?`<span class="text-xs font-semibold text-gray-700 dark:text-gray-300">${t.name}</span>`:`<span class="text-xs font-medium text-gray-600 dark:text-gray-400">${t.name}</span>`).join(' <span class="text-gray-400 dark:text-gray-500 mx-1">></span> ');t.innerHTML=o}();const n={};t.days&&Array.isArray(t.days)&&t.days.forEach(t=>{n[t.date]=t.count});t.start_date,t.end_date;document.getElementById("activity-period").textContent=function(t,e){if(!t||!e)return"No activity period";const n=new Date(t+"T00:00:00Z"),o=new Date(e+"T00:00:00Z");if(isNaN(n.getTime())||isNaN(o.getTime()))return"No activity period";const i=n.toLocaleDateString(window.AppConstants.LOCALE_SETTINGS.default,{month:"short",year:"numeric",timeZone:"UTC"}),a=o.toLocaleDateString(window.AppConstants.LOCALE_SETTINGS.default,{month:"short",year:"numeric",timeZone:"UTC"});return`${i} – ${a}`}(t.start_date,t.end_date);const o=function(t,e,n){const o=[];if(!t||!e)return o;const i=new Date(t+"T00:00:00Z"),a=new Date(e+"T00:00:00Z");if(isNaN(i.getTime())||isNaN(a.getTime()))return o;for(;i<=a;){const t=i.toISOString().split("T")[0],e=n[t]||0,a=R(e);o.push({date:t,count:e,intensity:a,month:i.getUTCMonth(),day:i.getUTCDate()}),i.setUTCDate(i.getUTCDate()+1)}return o}(t.start_date,t.end_date,n);!function(t,e,n){const o=window.AppConstants.UI_CONFIG.heatmapSquaresPerRow,i=Math.ceil(t.length/o);if(0===t.length)return void(document.getElementById("activity-heatmap").innerHTML='<div class="text-center text-gray-500 dark:text-gray-400 py-4"><p>${window.AppConstants.USER_MESSAGES.info.noActivityData}</p></div>');if(!e||!n)return void(document.getElementById("activity-heatmap").innerHTML='<div class="text-center text-gray-500 dark:text-gray-400 py-4"><p>${window.AppConstants.USER_MESSAGES.info.noActivityData}</p></div>');const a=new Date(e+"T00:00:00Z"),s=new Date(n+"T00:00:00Z");if(isNaN(a.getTime())||isNaN(s.getTime()))return void(document.getElementById("activity-heatmap").innerHTML='<div class="text-center text-gray-500 dark:text-gray-400 py-4"><p>${window.AppConstants.USER_MESSAGES.info.noActivityData}</p></div>');const r=new Set,d=new Date(a);for(;d<=s;){const t=d.toLocaleDateString(window.AppConstants.LOCALE_SETTINGS.default,{month:window.AppConstants.DATE_FORMAT.monthStyle,timeZone:window.AppConstants.DATE_FORMAT.timezone});r.add(t),d.setUTCMonth(d.getUTCMonth()+1),d.setUTCDate(1)}const l=Array.from(r);let c='<div class="space-y-1">';const m=Math.round(30/window.AppConstants.UI_CONFIG.heatmapSquaresPerRow);for(let e=0;e<i;e++){const n=e*o,i=Math.min(n+o,t.length);let a="";if(e%m===0){const t=Math.floor(e/m);t<l.length&&(a=l[t])}c+='<div class="flex items-center relative">',a&&(c+=`<div class="absolute -left-10 w-8 text-xs text-gray-400 dark:text-gray-500 text-right">${a}</div>`),c+='<div class="flex gap-1">';for(let e=n;e<i;e++)if(e<t.length){const n=t[e],o=U(n.intensity),i=new Date(n.date+"T00:00:00Z").toLocaleDateString(window.AppConstants.LOCALE_SETTINGS.default,{weekday:"long",month:"long",day:"numeric",year:"numeric",timeZone:"UTC"});c+=`<div class="heatmap-square ${o} rounded-sm cursor-pointer heatmap-cell hover:ring-1 hover:ring-gray-300 dark:hover:ring-gray-600 transition-all"\ndata-date="${n.date}"\ndata-count="${n.count}"\ndata-day="${i}">\n</div>`}c+="</div></div>"}c+="</div>",document.getElementById("activity-heatmap").innerHTML=c}(o,t.start_date,t.end_date);const s=1===t.stats.total_posts?window.AppConstants.UI_TEXT.post:window.AppConstants.UI_TEXT.posts,r=1===t.stats.active_days?window.AppConstants.UI_TEXT.day:window.AppConstants.UI_TEXT.days;document.getElementById("activity-summary").textContent=`${t.stats.total_posts} ${s} ${window.AppConstants.UI_TEXT.on} ${t.stats.active_days} ${r}`,document.getElementById("activity-next").disabled=u>=0;const d=void 0!==t.max_periods?t.max_periods:24;document.getElementById("activity-prev").disabled=u<=-d,function(){const t=document.getElementById("activity-legend");if(!t)return;const e=window.AppConstants.ACTIVITY_CLASSES[1],n=window.AppConstants.ACTIVITY_CLASSES_DARK[1],o=window.AppConstants.ACTIVITY_CLASSES[window.AppConstants.ACTIVITY_CLASSES.length-1],i=window.AppConstants.ACTIVITY_CLASSES_DARK[window.AppConstants.ACTIVITY_CLASSES_DARK.length-1];t.innerHTML=`\n<div class="flex items-center space-x-2">\n<div class="w-2 h-2 ${e} ${n} rounded-sm"></div>\n<span class="text-gray-400 dark:text-gray-500">${window.AppConstants.UI_TEXT.less}</span>\n</div>\n<div class="flex items-center space-x-2">\n<div class="w-2 h-2 ${o} ${i} rounded-sm"></div>\n<span class="text-gray-400 dark:text-gray-500">${window.AppConstants.UI_TEXT.more}</span>\n</div>\n`}(),function(){const t=document.querySelectorAll(".heatmap-cell");let e=null;t.forEach(t=>{t.addEventListener("mouseenter",t=>{const n=t.target.getAttribute("data-count"),o=t.target.getAttribute("data-day");e=document.createElement("div"),e.className="absolute bg-gray-900 text-white text-xs px-3 py-2 rounded shadow-lg pointer-events-none z-50 max-w-xs";const i="1"===n?window.AppConstants.UI_TEXT.post:window.AppConstants.UI_TEXT.posts;e.innerHTML=`\n<div class="font-medium">${n} ${i}</div>\n<div class="text-gray-300">${o}</div>\n`,document.body.appendChild(e);const a=t.target.getBoundingClientRect(),s=e.getBoundingClientRect();let r=a.right+10;r+s.width>window.innerWidth&&(r=a.left-s.width-10),e.style.left=`${r}px`,e.style.top=a.top+window.scrollY-s.height-5+"px"}),t.addEventListener("mouseleave",()=>{e&&(document.body.removeChild(e),e=null)})})}()}function R(t){return 0===t?window.AppConstants.ACTIVITY_LEVELS.none:t===window.AppConstants.ACTIVITY_THRESHOLDS.low?window.AppConstants.ACTIVITY_LEVELS.low:t<=window.AppConstants.ACTIVITY_THRESHOLDS.medium?window.AppConstants.ACTIVITY_LEVELS.medium:t<=window.AppConstants.ACTIVITY_THRESHOLDS.high?window.AppConstants.ACTIVITY_LEVELS.high:window.AppConstants.ACTIVITY_LEVELS.veryHigh}function U(t){return`${window.AppConstants.ACTIVITY_CLASSES[t]||window.AppConstants.ACTIVITY_CLASSES[0]} ${window.AppConstants.ACTIVITY_CLASSES_DARK[t]||window.AppConstants.ACTIVITY_CLASSES_DARK[0]}`}function G(){const t=document.getElementById("categories-tree");t.innerHTML="";const e=a.filter(t=>!t.parent_id);if(0===e.length)return t.innerHTML=`\n<div class="text-center text-gray-500 dark:text-gray-400 py-8">\n<i class="fas fa-folder-plus text-4xl mb-4"></i>\n<p>${window.AppConstants.UI_TEXT.noCategoriesYet}</p>\n</div>\n`,void W();J(e).forEach(e=>{const n=H(e);t.appendChild(n)}),W()}function H(t,e=0){const o=document.createElement("div");o.className="category-item mb-1";const r=a.some(e=>e.parent_id===t.id),d=s.has(t.id),l=d,c=document.createElement("div");c.className="flex items-center group";let m="";m=r?`\n<button class="expand-btn flex-shrink-0 w-5 h-5 flex items-center justify-center text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-all duration-200 mr-1" style="margin-left: ${14*e}px;">\n<i class="fas fa-chevron-${d?"down":"right"} text-xs"></i>\n</button>\n`:`<div class="w-5 h-5 mr-1" style="margin-left: ${14*e}px;"></div>`;const u=document.createElement("button"),p=i?.id===t.id;u.className="category-btn flex-1 text-left px-2 py-1.5 rounded-md transition-all duration-200 min-w-0 group-hover:bg-gray-50 dark:group-hover:bg-gray-700 "+(p?"bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-400 border-l-2 border-blue-500 dark:border-blue-400 font-medium":"text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-gray-100"),u.dataset.categoryId=t.id,u.innerHTML=`\n<div class="flex items-center min-w-0">\n<i class="fas fa-folder${p?"-open":""} mr-2 flex-shrink-0 text-xs ${p?"text-blue-500 dark:text-blue-400":"text-gray-400 dark:text-gray-500"}"></i>\n<span class="text-sm truncate" title="${t.name}">${t.name}</span>\n</div>\n`,c.innerHTML=m,c.appendChild(u),o.appendChild(c);const g=c.querySelector(".expand-btn");if(g&&g.addEventListener("click",e=>{e.stopPropagation(),function(t){s.has(t)?s.delete(t):s.add(t);y(),G()}(t.id)}),u.addEventListener("click",e=>{e.stopPropagation(),i&&i.id===t.id?void 0!==n&&n.navigate?n.navigate("/"):z(t,!0):void 0!==n&&n.navigateToCategory?n.navigateToCategory(t):z(t,!0)}),r&&l){J(a.filter(e=>e.parent_id===t.id)).forEach(t=>{const n=H(t,e+1);o.appendChild(n)})}return o}function z(t,e=!1){if(e&&i&&i.id===t.id)return void V();_t=!1;const n=document.getElementById("posts-container");var o;n&&(n.innerHTML='\n<div class="text-center text-gray-500 dark:text-gray-400 py-8">\n<i class="fas fa-spinner fa-spin text-4xl mb-4"></i>\n<p>Loading posts...</p>\n</div>\n'),i=t,i.recursiveMode=(o=t.id,JSON.parse(localStorage.getItem(window.AppConstants.STORAGE_KEYS.recursiveStates)||"{}")[o]||!1),function(t){localStorage.setItem(window.AppConstants.STORAGE_KEYS.lastCategory,t)}(t.id),document.getElementById("new-post-btn").style.display="block",document.getElementById("settings-btn").style.display="none",document.getElementById("theme-toggle-btn").style.display="none",document.getElementById("category-actions-dropdown").style.display="block",function(t){const e=a.find(e=>e.id===t);if(!e)return;function n(t){if(t.parent_id){const e=a.find(e=>e.id===t.parent_id);e&&(s.add(e.id),n(e))}}n(e),y()}(t.id),G(),function(t){setTimeout(()=>{const e=document.querySelector(`[data-category-id="${t}"]`);if(e){const t=document.getElementById("categories-tree"),n=t?.closest(".overflow-auto, .overflow-y-auto, .overflow-scroll, .overflow-y-scroll")||t?.parentElement;if(n){const t=n.getBoundingClientRect(),o=e.getBoundingClientRect(),i=o.top<t.top,a=o.bottom>t.bottom;(i||a)&&e.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})}else e.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})}},100)}(t.id),Nt(),Bt(t.id,i.recursiveMode),u=0,window.scrollTo(0,0),g&&B(t.id,i.recursiveMode).then(t=>{Nt(t)}).catch(t=>{console.error("Failed to fetch file stats:",t)}),N()}function V(){_t=!1;const t=document.getElementById("posts-container");t&&(t.innerHTML='\n<div class="text-center text-gray-500 dark:text-gray-400 py-8">\n<i class="fas fa-spinner fa-spin text-4xl mb-4"></i>\n<p>Loading posts...</p>\n</div>\n'),i={id:window.AppConstants.ALL_CATEGORIES_ID,name:window.AppConstants.UI_TEXT.allCategories,recursiveMode:!1},localStorage.removeItem(window.AppConstants.STORAGE_KEYS.lastCategory),G(),document.getElementById("new-post-btn").style.display="none",document.getElementById("settings-btn").style.display="block",document.getElementById("theme-toggle-btn").style.display="block",document.getElementById("category-actions-dropdown").style.display="none",Ot(),Bt(0,!1),u=0,window.scrollTo(0,0),g&&B(0,!1).then(t=>{Ot(t)}).catch(t=>{console.error("Failed to fetch file stats:",t)}),N()}function j(t){i&&i.id===t.id&&(i.recursiveMode=!i.recursiveMode,function(t,e){const n=JSON.parse(localStorage.getItem(window.AppConstants.STORAGE_KEYS.recursiveStates)||"{}");n[t]=e,localStorage.setItem(window.AppConstants.STORAGE_KEYS.recursiveStates,JSON.stringify(n))}(t.id,i.recursiveMode),window.scrollTo(0,0),G(),Nt(),Bt(t.id,i.recursiveMode),g&&B(t.id,i.recursiveMode).then(t=>{Nt(t)}).catch(t=>{console.error("Failed to fetch file stats:",t)}),N())}function Y(){const t=JSON.parse(localStorage.getItem(window.AppConstants.STORAGE_KEYS.recursiveStates)||"{}"),e=new Set(a.map(t=>t.id.toString())),n={};for(const[o,i]of Object.entries(t))e.has(o)&&(n[o]=i);localStorage.setItem(window.AppConstants.STORAGE_KEYS.recursiveStates,JSON.stringify(n))}function q(t){const e=a.find(e=>e.id===t);if(!e)return"";const n=[];let o=e;for(;o;)n.unshift(o.name),o=o.parent_id?a.find(t=>t.id===o.parent_id):null;return n.join(" > ")}async function X(t){const e=[],n=a.filter(e=>e.parent_id===t);for(const t of n){e.push(t);const n=await X(t.id);e.push(...n)}return e}async function Z(t){const e=t.recursive_post_count||0,n=await X(t.id),o=n.length;let a=`${window.AppConstants.USER_MESSAGES.confirm.deleteCategory} "${t.name}"?`;o>0&&(a+=`\n\nThis will also delete **${o}** subcategory(ies)`),e>0&&(a+=` and **${e}** post(s)`,a+="."),a+=window.AppConstants.USER_MESSAGES.confirm.undoWarning;let s="";n.length>0&&(s+='<div class="mb-4"><h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Subcategories to be deleted:</h4>',s+='<div class="bg-gray-50 dark:bg-gray-800 rounded p-3 max-h-32 overflow-y-auto"><ul class="text-sm text-gray-600 dark:text-gray-400 space-y-1">',n.forEach(t=>{const e=q(t.id);s+=`<li>• ${e}</li>`}),s+="</ul></div></div>");if(await I("Delete Category",a,s))try{await async function(t){try{await _(`/categories/${t}`,{method:"DELETE"})}catch(t){throw console.error("Failed to delete category:",t),t}}(t.id),function(t){const e=JSON.parse(localStorage.getItem(window.AppConstants.STORAGE_KEYS.recursiveStates)||"{}");delete e[t],localStorage.setItem(window.AppConstants.STORAGE_KEYS.recursiveStates,JSON.stringify(e))}(t.id),await k(),showSuccess(`Category "${t.name}" ${window.AppConstants.USER_MESSAGES.success.categoryDeleted}`),Y(),i&&i.id===t.id&&(i=null,localStorage.removeItem(window.AppConstants.STORAGE_KEYS.lastCategory),document.getElementById("timeline-title").textContent="",document.getElementById("new-post-btn").style.display="none",document.getElementById("settings-btn").style.display="block",document.getElementById("theme-toggle-btn").style.display="block",document.getElementById("recursive-toggle-btn").style.display="none",document.getElementById("category-actions-dropdown").style.display="none",document.getElementById("posts-container").innerHTML="")}catch(t){x(w(window.AppConstants.USER_MESSAGES.error.failedToDeleteCategory,t.message))}}function K(){const t=localStorage.getItem(window.AppConstants.STORAGE_KEYS.categorySortPref);return t?JSON.parse(t):{field:"name",ascending:!0}}function J(t){const e=K(),n=[...t];return n.sort((t,n)=>{let o,i;switch(e.field){case"name":o=t.name.toLowerCase(),i=n.name.toLowerCase();break;case"posts":o=t.recursive_post_count||0,i=n.recursive_post_count||0;break;case"created":o=t.created||0,i=n.created||0;break;default:return 0}let a=0;return o<i?a=-1:o>i&&(a=1),e.ascending?a:-a}),n}function W(){const t=document.getElementById("category-sort-footer");if(!t)return;let e=a.filter(t=>!t.parent_id).length>=2;if(!e)for(const t of a)if(s.has(t.id)){if(a.filter(e=>e.parent_id===t.id).length>=2){e=!0;break}}t.style.display=e?"block":"none"}function Q(){const t=document.getElementById("category-sort-footer");if(!t)return;const e=t.querySelectorAll(".sort-option");K();tt(),e.forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.sort,n=K();let o=!0;n.field===e&&(o=!n.ascending),function(t,e){const n={field:t,ascending:e};localStorage.setItem(window.AppConstants.STORAGE_KEYS.categorySortPref,JSON.stringify(n))}(e,o),tt(),G()})})}function tt(){const t=document.getElementById("category-sort-footer");if(!t)return;const e=t.querySelectorAll(".sort-option"),n=K();e.forEach(t=>{const e=t.dataset.sort,o=n.field===e,i=t.querySelector(".sort-icon");if(o?(t.classList.remove("text-gray-600"),t.classList.add("text-blue-600","font-medium")):(t.classList.remove("text-blue-600","font-medium"),t.classList.add("text-gray-600")),i&&o){const t=i.dataset.asc,e=i.dataset.desc;i.className=`fas ${n.ascending?t:e} ml-1 sort-icon`}})}function et(){const t=document.getElementById("file-preview-container");if(t.innerHTML="",0===r.size)return;Array.from(r.entries()).forEach(([e,n])=>{const o=document.createElement("div");o.className="flex items-center justify-between bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded p-3";let i="";if(n.type.startsWith("image/")){i=`<img src="${URL.createObjectURL(n)}" class="w-12 h-12 object-cover rounded mr-3">`}else i='<div class="w-12 h-12 bg-gray-200 dark:bg-gray-700 rounded mr-3 flex items-center justify-center">\n<i class="fas fa-file text-gray-500 dark:text-gray-400"></i>\n</div>';o.innerHTML=`\n<div class="flex items-center">\n${i}\n<div>\n<p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate" style="max-width: ${window.AppConstants.UI_CONFIG.maxFilenameDisplay}px;">${n.name}</p>\n<p class="text-xs text-gray-500 dark:text-gray-400">${E(n.size)}</p>\n</div>\n</div>\n<button type="button" onclick="removeFileFromSelection(${e})" class="text-red-600 hover:text-red-800 p-1">\n<i class="fas fa-times"></i>\n</button>\n`,t.appendChild(o)})}async function nt(t){const e=window.currentSettings||await T();if(d.size>=e.maxFilesPerPost)return x(w(window.AppConstants.USER_MESSAGES.error.maxFilesExceeded,e.maxFilesPerPost)),!1;const n=e.maxFileSizeMB*window.AppConstants.UI_CONFIG.fileSizeUnit*window.AppConstants.UI_CONFIG.fileSizeUnit;if(t.size>n)return x(w(window.AppConstants.USER_MESSAGES.error.fileSizeExceeded,t.name,e.maxFileSizeMB)),!1;const o=++l;return d.set(o,t),ot(),!0}function ot(){const t=document.getElementById("modal-file-preview-container"),e=document.getElementById("modal-file-preview-list");if(0===d.size&&(!window.modalPastedFiles||0===window.modalPastedFiles.length))return t.style.display="none",void at();t.style.display="block",e.innerHTML="";Array.from(d.entries()).forEach(([t,n])=>{const o=it(t,n,"file");e.appendChild(o)}),window.modalPastedFiles&&window.modalPastedFiles.length>0&&window.modalPastedFiles.forEach((t,n)=>{const o=it(n,t,"pasted");e.appendChild(o)}),at(),function(){const t=document.getElementById("modal-file-preview-list"),e=document.getElementById("modal-file-prev"),n=document.getElementById("modal-file-next"),o=document.getElementById("modal-file-counter");if(!(t&&e&&n&&o))return;const i=d.size+(window.modalPastedFiles?window.modalPastedFiles.length:0);if(0===i)return o.textContent="0 / 0",e.disabled=!0,void(n.disabled=!0);function a(){const o=t.scrollLeft>0,i=t.scrollLeft<t.scrollWidth-t.clientWidth;e.disabled=!o,n.disabled=!i}o.textContent=`${i} / ${i}`,t.removeEventListener("scroll",t.updateButtonVisibility),t.updateButtonVisibility=a,t.addEventListener("scroll",a),a()}()}function it(t,e,n){const o=document.createElement("div"),i=E(e.size),a=`${e.name} • ${i}`,s=e.type.startsWith("image/"),r="pasted"===n?`removeModalPastedFile(${t})`:`removeModalFileFromSelection(${t})`,d=e.name.split(".").pop()||"FILE";if(o.className="flex flex-col flex-shrink-0",s){const t=URL.createObjectURL(e);o.innerHTML=`\n<div class="relative w-20 h-20 group cursor-pointer" onclick="openModalImagePreview('${e.name}', '${t}'); event.stopPropagation();" title="${a}">\n<img src="${t}"\nalt="${e.name}"\nclass="w-full h-full object-cover rounded-lg border hover:opacity-90 transition-opacity"\nonload="window.URL.revokeObjectURL(this.src)">\n<div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 hover:opacity-100 transition-opacity rounded-lg pointer-events-none">\n<div class="absolute bottom-0 left-0 right-0 p-1">\n<p class="text-white text-xs truncate leading-tight">${e.name}</p>\n<p class="text-white/80 text-xs">${i}</p>\n</div>\n</div>\n</div>\n<button type="button" onclick="${r}; event.stopPropagation();"\nclass="text-xs text-red-600 hover:text-red-800 mt-1 block text-center">\nDelete\n</button>\n`}else{const t=b(d);o.innerHTML=`\n<div class="relative w-20 h-20 group cursor-pointer" title="${a}">\n<div class="w-full h-full bg-gray-100 dark:bg-gray-800 border dark:border-gray-700 rounded-lg flex flex-col items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">\n<i class="fas ${t} text-2xl text-gray-600 dark:text-gray-400 mb-1"></i>\n<span class="text-xs text-gray-500 dark:text-gray-400 font-medium">${d.toUpperCase()}</span>\n</div>\n<div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 hover:opacity-100 transition-opacity rounded-lg pointer-events-none">\n<div class="absolute bottom-0 left-0 right-0 p-1">\n<p class="text-white text-xs truncate leading-tight">${e.name}</p>\n<p class="text-white/80 text-xs">${i}</p>\n</div>\n</div>\n</div>\n<button type="button" onclick="${r}; event.stopPropagation();"\nclass="text-xs text-red-600 hover:text-red-800 mt-1 block text-center">\nDelete\n</button>\n`}return s&&o.addEventListener("click",function(t){if(!t.target.closest("button")){const t=URL.createObjectURL(e);rt(e.name,t)}}),o}function at(){const t=document.getElementById("modal-file-size-display");let e=0,n=0;if(d.forEach(t=>{e+=t.size,n++}),window.modalPastedFiles&&window.modalPastedFiles.length>0&&window.modalPastedFiles.forEach(t=>{e+=t.size,n++}),0===n)t.style.display="none";else{t.style.display="block";const o=E(e);t.innerHTML=`<i class="fas fa-paperclip text-xs mr-1"></i>${n} file${n>1?"s":""} • ${o}`}}function st(){ot()}function rt(t,e){window.currentImageGallery=[{url:e,filename:t}],window.currentImageIndex=0;document.getElementById("image-viewer-modal").classList.remove("hidden"),document.body.style.overflow="hidden";const n=document.getElementById("viewer-image"),o=document.getElementById("viewer-filename"),i=document.getElementById("viewer-counter");n.src=e,o.textContent=t,i.textContent="",document.getElementById("viewer-prev").style.display="none",document.getElementById("viewer-next").style.display="none"}function dt(){const t=document.getElementById("viewer-image"),e=document.getElementById("viewer-filename"),n=document.getElementById("viewer-counter"),o=c[m];t.src=o.url,e.textContent=o.filename,c.length>1?n.textContent=`${m+1} / ${c.length}`:n.textContent=""}function lt(){document.getElementById("image-viewer-modal").classList.add("hidden"),document.body.style.overflow=""}function ct(t){c.length<=1||(m="prev"===t?m>0?m-1:c.length-1:m<c.length-1?m+1:0,dt())}window.changeActivityPeriod=async function(t){const e=u+t;if(F){const t=void 0!==F.max_periods?F.max_periods:24;if(e>0||e<-t)return}else if(e>0||e<-24)return;u=e;const n=document.getElementById("activity-heatmap");n&&(n.innerHTML='\n<div class="text-center text-gray-500 dark:text-gray-400 py-8">\n<i class="fas fa-spinner fa-spin text-2xl mb-2"></i>\n<p class="text-sm">Loading...</p>\n</div>\n'),await N()},window.navigateToCategory=function(t){const e=a.find(e=>e.id===t);e&&(void 0!==n&&n.navigateToCategory?n.navigateToCategory(e):z(e))},window.navigateToAllCategories=function(){void 0!==n&&n.navigate?n.navigate("/"):V()},window.removeFileFromSelection=function(t){r.delete(t),et()},window.removePastedFile=function(t){window.pastedFiles&&window.pastedFiles.length>t&&(window.pastedFiles.splice(t,1),function(){const t=document.getElementById("pasted-files-display");if(t.innerHTML="",window.pastedFiles&&window.pastedFiles.length>0){const e=document.createElement("div");e.className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",e.textContent="Pasted Images:",t.appendChild(e),window.pastedFiles.forEach((e,n)=>{const o=document.createElement("div");o.className="flex items-center justify-between bg-blue-50 border border-blue-200 rounded p-2 mb-1",o.innerHTML=`\n<span class="text-sm text-blue-700">\n<i class="fas fa-image mr-2"></i>${e.name}\n</span>\n<button type="button" onclick="removePastedFile(${n})" class="text-red-600 hover:text-red-800">\n<i class="fas fa-times"></i>\n</button>\n`,t.appendChild(o)})}}())},window.removeModalFileFromSelection=function(t){d.delete(t),ot()},window.scrollModalAttachments=function(t){const e=document.getElementById("modal-file-preview-list");if(!e)return;e.scrollBy({left:200*t,behavior:"smooth"})},window.openModalImagePreview=rt,window.openImageGallery=function(t=0){const e=event.target.closest("[data-images]"),n=e.getAttribute("data-images");if(n)c=JSON.parse(n);else{const t=e.querySelector("img");c=[{url:t.src,filename:t.alt}]}m=t,document.getElementById("image-viewer-modal").classList.remove("hidden"),document.body.style.overflow="hidden",dt();const o=document.getElementById("viewer-prev"),i=document.getElementById("viewer-next");o.style.display=c.length>1?"block":"none",i.style.display=c.length>1?"block":"none"};let mt=[];const ut=/https?:\/\/[^\s]+/g,pt=/(?:^|\s)((?:[a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}(?:\/[^\s]*)?)/g;function gt(t){const e=new Set,n=t.match(ut);let o;n&&n.forEach(t=>e.add(t));const i=new RegExp(pt);for(;null!==(o=i.exec(t));){const n=o[1],i=o.index+o[0].indexOf(n);t.substring(Math.max(0,i-8),i).match(/https?:\/\/$/)||e.add("https://"+n)}return Array.from(e)}async function yt(t){return await async function(t){try{const e=await fetch("/api/link-preview",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:t})});if(!e.ok){const t=await e.text();throw new Error(t)}return e.json().catch(()=>({}))}catch(t){throw console.error("Failed to fetch link preview:",t),t}}(t)}function ft(){const t=document.getElementById("link-preview-container");if(t){if(0===mt.length)return t.innerHTML="",void(t.style.display="none");t.style.display="block";try{t.innerHTML=`\n<label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Link Previews</label>\n<div class="space-y-3">\n${mt.map(t=>function(t){const e=t.image_url&&""!==t.image_url.trim();return`\n<div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden hover:border-gray-300 dark:hover:border-gray-600 transition-colors" data-preview-id="${t.id}">\n<div class="flex">\n${e?`\n<div class="flex-shrink-0 w-24 h-24">\n<img src="${v(t.image_url)}"\nalt=""\nclass="w-full h-full object-cover"\nonerror="this.parentElement.style.display='none'">\n</div>\n`:""}\n<div class="flex-1 p-3 min-w-0">\n<div class="flex items-start justify-between">\n<div class="flex-1 min-w-0">\n<h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 line-clamp-2 mb-1">\n${v(t.title)}\n</h4>\n${t.description?`\n<p class="text-xs text-gray-600 dark:text-gray-400 line-clamp-2 mb-2">\n${v(t.description)}\n</p>\n`:""}\n<div class="flex items-center text-xs text-gray-500 dark:text-gray-400">\n<i class="fas fa-link mr-1"></i>\n<span class="truncate">\n${t.site_name?v(t.site_name):new URL(t.url).hostname}\n</span>\n</div>\n</div>\n<button type="button"\nonclick="removeLinkPreview(${t.id})"\nclass="ml-2 p-1 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 rounded">\n<i class="fas fa-times text-xs"></i>\n</button>\n</div>\n</div>\n</div>\n</div>\n`}(t)).join("")}\n</div>\n`}catch(t){}}}function ht(t,e){return t&&0!==t.length?`\n<div class="mb-4 mt-4">\n<div class="flex items-center justify-between mb-2">\n<label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Link Previews</label>\n<div class="flex items-center space-x-2">\n<button type="button" class="post-link-prev p-1 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 disabled:opacity-30" disabled onclick="navigatePostLinkPreview(${e}, -1)">\n<i class="fas fa-chevron-left text-xs"></i>\n</button>\n<span class="post-link-counter text-xs text-gray-500 dark:text-gray-400">1 / ${t.length}</span>\n<button type="button" class="post-link-next p-1 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 disabled:opacity-30" ${1===t.length?"disabled":""} onclick="navigatePostLinkPreview(${e}, 1)">\n<i class="fas fa-chevron-right text-xs"></i>\n</button>\n</div>\n</div>\n<div class="relative overflow-hidden">\n<div class="flex transition-transform duration-300 ease-in-out" data-post-link-list>\n${t.map(t=>function(t){const e=t.image_url&&""!==t.image_url.trim();return`\n<a href="${v(t.url)}"\ntarget="_blank"\nrel="noopener noreferrer"\nclass="block border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden hover:border-gray-300 dark:hover:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-800 transition-all flex-shrink-0 w-full">\n<div class="flex">\n${e?`\n<div class="flex-shrink-0 w-32 h-24">\n<img src="${v(t.image_url)}"\nalt=""\nclass="w-full h-full object-cover"\nonerror="this.parentElement.style.display='none'">\n</div>\n`:""}\n<div class="flex-1 p-4 min-w-0">\n<h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 line-clamp-2 mb-2">\n${v(t.title)}\n</h4>\n${t.description?`\n<p class="text-xs text-gray-600 dark:text-gray-400 line-clamp-3 mb-2">\n${v(t.description)}\n</p>\n`:""}\n<div class="flex items-center text-xs text-gray-500 dark:text-gray-400">\n<i class="fas fa-external-link-alt mr-1"></i>\n<span class="truncate">\n${t.site_name?v(t.site_name):new URL(t.url).hostname}\n</span>\n</div>\n</div>\n</div>\n</a>\n`}(t)).join("")}\n</div>\n</div>\n</div>\n`:""}window.removeLinkPreview=function(t){mt=mt.filter(e=>e.id!==t),ft()};const wt={};window.navigatePostLinkPreview=function(t,e){const n=document.querySelector(`[data-post-id="${t}"]`);if(!n)return;const o=n.querySelector("[data-post-link-list]"),i=n.querySelector(".post-link-counter"),a=n.querySelector(".post-link-prev"),s=n.querySelector(".post-link-next");if(!o||!i)return;const r=o.children.length;if(0===r)return;wt[t]||(wt[t]={currentIndex:0});const d=wt[t];-1===e&&d.currentIndex>0?d.currentIndex--:1===e&&d.currentIndex<r-1&&d.currentIndex++;const l=100*-d.currentIndex;o.style.transform=`translateX(${l}%)`,i.textContent=`${d.currentIndex+1} / ${r}`,a&&(a.disabled=0===d.currentIndex),s&&(s.disabled=d.currentIndex===r-1)};let vt=[],Et=0,xt=0;function It(){const t=document.getElementById("modal-link-preview-container"),e=document.getElementById("modal-link-preview-list"),n=document.getElementById("modal-link-counter"),o=document.getElementById("modal-link-prev"),i=document.getElementById("modal-link-next");if(t&&e)if(0!==vt.length){t.style.display="block";try{e.innerHTML=vt.map(t=>function(t){const e=t.image_url&&""!==t.image_url.trim();return`\n<div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden hover:border-gray-300 dark:hover:border-gray-600 transition-colors flex-shrink-0 w-full" data-preview-id="${t.id}">\n<div class="flex">\n${e?`\n<div class="flex-shrink-0 w-24 h-24">\n<img src="${v(t.image_url)}"\nalt=""\nclass="w-full h-full object-cover"\nonerror="this.parentElement.style.display='none'">\n</div>\n`:""}\n<div class="flex-1 p-3 min-w-0">\n<div class="flex items-start justify-between">\n<div class="flex-1 min-w-0">\n<h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 line-clamp-2 mb-1">\n${v(t.title)}\n</h4>\n${t.description?`\n<p class="text-xs text-gray-600 dark:text-gray-400 line-clamp-2 mb-2">\n${v(t.description)}\n</p>\n`:""}\n<div class="flex items-center text-xs text-gray-500 dark:text-gray-400">\n<i class="fas fa-link mr-1"></i>\n<span class="truncate">\n${t.site_name?v(t.site_name):new URL(t.url).hostname}\n</span>\n</div>\n</div>\n<button type="button"\nonclick="removeModalLinkPreview(${t.id})"\nclass="ml-2 p-1 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 rounded">\n<i class="fas fa-times text-xs"></i>\n</button>\n</div>\n</div>\n</div>\n</div>\n`}(t)).join(""),n.textContent=`${xt+1} / ${vt.length}`,o.disabled=0===xt,i.disabled=xt===vt.length-1;const t=100*-xt;e.style.transform=`translateX(${t}%)`}catch(t){}}else t.style.display="none"}function St(t){"prev"===t&&xt>0?xt--:"next"===t&&xt<vt.length-1&&xt++,It()}async function bt(t){const e=gt(t);if(0===e.length)return vt=[],void It();const n=vt.map(t=>t.url),o=e.filter(t=>!n.includes(t));vt=vt.filter(t=>e.includes(t.url));for(const t of o)try{const e=await yt(t);e.error||vt.push({id:++Et,url:e.url,title:e.title||t,description:e.description||"",image_url:e.image_url||"",site_name:e.site_name||""})}catch(t){}It()}function At(){return vt.map(t=>({url:t.url,title:t.title,description:t.description,image_url:t.image_url,site_name:t.site_name}))}window.removeModalLinkPreview=function(t){vt=vt.filter(e=>e.id!==t),xt>=vt.length&&vt.length>0?xt=vt.length-1:0===vt.length&&(xt=0),It()};let Ct=[],Tt=0,Lt=!0,_t=!1,kt=null;const Mt=window.AppConstants.UI_CONFIG.virtualScrollThreshold;async function Bt(t,e=!1,n=!0){if(!_t)try{_t=!0,n&&(Ct=[],Tt=0,Lt=!0);const o=await M(t,window.AppConstants.UI_CONFIG.defaultPostsPerPage,Tt,!1,e);let i=o.posts||o;i&&Array.isArray(i)||(i=[]),Ct=n?i:[...Ct,...i],Lt=o&&void 0!==o.has_more?o.has_more:i.length===window.AppConstants.UI_CONFIG.defaultPostsPerPage,Tt+=i.length,$t(Ct,n),n&&function(t,e=!1){document.getElementById("posts-container");window.removeEventListener("scroll",window.infiniteScrollHandler),window.infiniteScrollHandler=()=>{if(!Lt||_t)return;window.innerHeight+window.scrollY>=document.documentElement.offsetHeight-window.AppConstants.UI_CONFIG.infiniteScrollThreshold&&async function(t,e=!1){if(!Lt||_t)return;await Bt(t,e,!1)}(t,e)},window.addEventListener("scroll",window.infiniteScrollHandler)}(t,e)}catch(t){console.error("Failed to fetch posts:",t),n&&$t([])}finally{_t=!1}}function $t(t,e=!0){const n=document.getElementById("posts-container");if(t&&Array.isArray(t)||(t=[]),e){if(kt&&(kt.destroy(),kt=null),0===t.length)return void(n.innerHTML=`\n<div class="text-center text-gray-500 dark:text-gray-400 py-8">\n<i class="fas fa-inbox text-4xl mb-4"></i>\n<p>${window.AppConstants.UI_TEXT.noPostsYet}</p>\n</div>\n`);if(t.length>Mt)return kt||(kt=new ue(n)),void kt.setItems(t);n.innerHTML=""}if(kt&&t.length>Mt)if(e)kt.setItems(t);else{const e=t.slice(Ct.length-(t.length-Ct.length));kt.addItems(e)}else{if(e)t.forEach(t=>{const e=Pt(t);n.appendChild(e)});else{const e=new Set(Array.from(n.querySelectorAll("[data-post-id]")).map(t=>parseInt(t.dataset.postId)));t.forEach(t=>{if(!e.has(t.id)){const e=Pt(t);n.appendChild(e)}})}!Lt||_t||kt||function(t){const e=t.querySelector(".loading-indicator");e&&e.remove();if(Lt){const e=document.createElement("div");e.className="loading-indicator text-center py-4",e.innerHTML=`\n<div class="text-gray-500 dark:text-gray-400">\n<i class="fas fa-spinner fa-spin mr-2"></i>\n${window.AppConstants.USER_MESSAGES.info.loadingMorePosts}\n</div>\n`,t.appendChild(e)}}(n)}}function Pt(t){const e=document.createElement("div");e.className="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-6 hover:shadow-md transition-shadow group max-w-full",e.setAttribute("data-post-id",t.id);const n=t.attachments?t.attachments.filter(t=>t.file_type.startsWith("image/")):[],o=t.attachments?t.attachments.filter(t=>!t.file_type.startsWith("image/")):[],a=n.length+o.length,s=t.link_previews||[],r=!i||i.id===window.AppConstants.ALL_CATEGORIES_ID||i&&i.recursiveMode&&t.category_id!==i.id,d=r?q(t.category_id):"",l=`\n<div class="flex items-center justify-between mb-4">\n<div class="flex items-center space-x-2">\n${r?`<span class="text-xs font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 px-2 py-1 rounded cursor-pointer hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors" onclick="navigateToCategoryFromPost(${t.category_id})">${d}</span>`:""}\n<span class="relative group/time text-sm text-gray-600 dark:text-gray-400 font-sans cursor-default">\n${function(t){const e=new Date(t),n=new Date,o=n-e,i=Math.floor(o/window.AppConstants.UI_CONFIG.daysInMs),a=Math.floor(o/window.AppConstants.UI_CONFIG.hoursInMs),s=Math.floor(o/window.AppConstants.UI_CONFIG.minutesInMs);return s<1?"now":s<60?`${s}m`:a<24?`${a}h`:i<7?1===i?"1d":`${i}d`:e.getFullYear()===n.getFullYear()?e.toLocaleDateString(window.AppConstants.LOCALE_SETTINGS.default,{month:"short",day:"numeric"}):e.toLocaleDateString(window.AppConstants.LOCALE_SETTINGS.default,{month:"short",day:"numeric",year:"numeric"})}(t.created)}\n<div class="absolute left-0 top-full mt-1 px-2 py-1 bg-gray-900 text-white text-xs rounded-md shadow-lg opacity-0 group-hover/time:opacity-100 transition-opacity duration-200 pointer-events-none z-50 whitespace-nowrap">\n${function(t){const e=new Date(t),n=e.toLocaleTimeString(window.AppConstants.LOCALE_SETTINGS.default).match(/AM|PM/i)?{hour:"numeric",minute:"2-digit",hour12:!0}:{hour:"2-digit",minute:"2-digit",hour12:!1};return`${e.toLocaleTimeString(window.AppConstants.LOCALE_SETTINGS.default,n)} - ${e.toLocaleDateString(window.AppConstants.LOCALE_SETTINGS.default,{month:"short",day:"numeric",year:"numeric"})}`}(t.created)}\n</div>\n</span>\n</div>\n<div class="relative opacity-0 group-hover:opacity-100 transition-all">\n<button onclick="togglePostActionMenu(${t.id})" class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 p-1 rounded transition-all">\n<i class="fas fa-ellipsis-h text-sm"></i>\n</button>\n<div id="post-action-menu-${t.id}" class="absolute right-0 top-full mt-1 w-32 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-md shadow-lg z-50 hidden">\n<div class="py-1">\n<button onclick="showMoveModal(${t.id})" class="flex items-center w-full px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">\n<i class="fas fa-exchange-alt text-xs mr-2"></i>\nMove\n</button>\n<button onclick="confirmDeletePost(${t.id})" class="flex items-center w-full px-3 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">\n<i class="fas fa-trash-alt text-xs mr-2"></i>\nDelete\n</button>\n</div>\n</div>\n</div>\n</div>\n`,c=t.content.match(/https?:\/\/\S+/g),m=c&&1===c.length&&t.content.trim()===c[0]&&s.length>0,u=document.createElement("div");u.className="mb-4 post-content font-content text-gray-900 dark:text-gray-100",m&&(u.style.display="none");const p=null!==document.getElementById("markdown-css");let g=t.content;p?u.innerHTML=`<div class="markdown-body text-gray-900 dark:text-gray-100">${g}</div>`:(g=S(t.content),u.innerHTML=`<div class="text-gray-900 dark:text-gray-100">${g}</div>`);const y=u.innerHTML,f=a>0?"":ht(s,t.id);let h="";if(a>0){h='<div class="border-t pt-3 mt-4">';const t=[...n,...o],e=n.map(t=>({url:"/uploads/"+t.file_path,filename:t.filename}));h+=`\n<div>\n<div class="flex items-center justify-between mb-2">\n<h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Attachments</h4>\n<div class="flex items-center space-x-2">\n<button type="button" class="post-attachment-prev p-1 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 disabled:opacity-30" disabled onclick="scrollAttachments(this, -1)">\n<i class="fas fa-chevron-left text-xs"></i>\n</button>\n<span class="post-attachment-counter text-xs text-gray-500 dark:text-gray-400">${a} / ${a}</span>\n<button type="button" class="post-attachment-next p-1 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 disabled:opacity-30" disabled onclick="scrollAttachments(this, 1)">\n<i class="fas fa-chevron-right text-xs"></i>\n</button>\n</div>\n</div>\n<div class="relative overflow-hidden">\n<div class="flex items-center space-x-3 overflow-x-auto pb-2 scroll-smooth" data-attachment-container>\n${t.map((t,o)=>{const i=t.file_type.startsWith("image/"),a=t.filename.split(".").pop().toLowerCase(),s=t.file_size?E(t.file_size):"",r=`${t.filename}${s?" • "+s:""}`;if(i){return`\n<div class="relative flex-shrink-0 w-20 h-20 group cursor-pointer" onclick="openImageGallery(${n.findIndex(e=>e.filename===t.filename)})" data-images='${JSON.stringify(e)}' title="${r}">\n<img src="/uploads/${t.file_path}"\nalt="${t.filename}"\nclass="w-full h-full object-cover rounded-lg border hover:opacity-90 transition-opacity">\n<div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/60 to-transparent p-1 rounded-b-lg opacity-0 hover:opacity-100 transition-opacity">\n<p class="text-white text-xs truncate leading-tight">${t.filename}</p>\n${s?`<p class="text-white/80 text-xs">${s}</p>`:""}\n</div>\n</div>\n`}return`\n<div class="relative flex-shrink-0 w-20 h-20 group cursor-pointer" onclick="window.open('/uploads/${t.file_path}', '_blank')" title="${r}">\n<div class="w-full h-full bg-gray-100 dark:bg-gray-800 border dark:border-gray-700 rounded-lg flex flex-col items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">\n<i class="fas ${b(a)} text-2xl text-gray-600 dark:text-gray-400 mb-1"></i>\n<span class="text-xs text-gray-500 dark:text-gray-400 font-medium">${a.toUpperCase()}</span>\n</div>\n<div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/60 to-transparent p-1 rounded-b-lg opacity-0 hover:opacity-100 transition-opacity">\n<p class="text-white text-xs truncate leading-tight">${t.filename}</p>\n${s?`<p class="text-white/80 text-xs">${s}</p>`:""}\n</div>\n</div>\n`}).join("")}\n</div>\n</div>\n</div>\n`,h+="</div>"}return e.innerHTML=l+y+f+h,a>0&&setTimeout(()=>function(t){const e=t.querySelector("[data-attachment-container]"),n=t.querySelector(".post-attachment-prev"),o=t.querySelector(".post-attachment-next");if(!e||!n||!o)return;function i(){const t=e.scrollLeft>0,i=e.scrollLeft<e.scrollWidth-e.clientWidth;n.disabled=!t,o.disabled=!i}e.addEventListener("scroll",i),i()}(e),0),e}window.togglePostActionMenu=function(t){document.querySelectorAll('[id^="post-action-menu-"]').forEach(e=>{e.id!==`post-action-menu-${t}`&&e.classList.add("hidden")});const e=document.getElementById(`post-action-menu-${t}`);e&&e.classList.toggle("hidden")},document.addEventListener("click",function(t){t.target.closest('[id^="post-action-menu-"]')||t.target.closest('button[onclick*="togglePostActionMenu"]')||document.querySelectorAll('[id^="post-action-menu-"]').forEach(t=>{t.classList.add("hidden")})});let Ft=null;function Dt(){document.getElementById("move-modal").classList.add("hidden"),document.getElementById("move-category").value="",Ft=null}function Nt(t){if(!i)return;if(i.id===window.AppConstants.ALL_CATEGORIES_ID)return void Ot();const e=a.find(t=>t.id===i.id);if(e){const t=i.recursiveMode;i={...e},i.recursiveMode=t}const n=i.recursiveMode?i.recursive_post_count||0:i.post_count||0;let o=`${n} post${1!==n?"s":""}`;g&&t&&t.file_count>0&&(o+=` • ${t.file_count} file${1!==t.file_count?"s":""} • ${E(t.total_size)}`);const s=function(t){const e=a.find(e=>e.id===t);if(!e)return"";const n=[];let o=e;for(;o;)n.unshift({id:o.id,name:o.name}),o=o.parent_id?a.find(t=>t.id===o.parent_id):null;if(window.innerWidth<=768){const t=n[n.length-1];return n.length>1?`<span class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 cursor-pointer transition-colors" onclick="navigateToCategory(${n[n.length-2].id})">...</span> <span class="text-gray-400 dark:text-gray-500">></span> <span class="text-gray-900 dark:text-gray-100">${t.name}</span>`:`<span class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 cursor-pointer transition-colors" onclick="navigateToAllCategories()">...</span> <span class="text-gray-400 dark:text-gray-500">></span> <span class="text-gray-900 dark:text-gray-100">${t.name}</span>`}return n.map((t,e)=>e===n.length-1?`<span class="text-gray-900 dark:text-gray-100">${t.name}</span>`:`<span class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 cursor-pointer transition-colors" onclick="navigateToCategory(${t.id})">${t.name}</span>`).join(' <span class="text-gray-400 dark:text-gray-500">></span> ')}(i.id),r=i.created?new Date(i.created).toLocaleDateString(window.AppConstants.LOCALE_SETTINGS.default,{year:"numeric",month:"long",day:"numeric"}):"Date unavailable";i.description&&i.description.trim()&&i.description;document.getElementById("timeline-title").innerHTML=`\n<div class="group relative">\n<h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">${s}</h2>\n<p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5 relative">\n<span class="transition-opacity group-hover:opacity-0">${o}</span>\n<span class="absolute top-0 left-0 opacity-0 group-hover:opacity-100 transition-opacity">${r}</span>\n</p>\n${i.description&&i.description.trim()?`\n<div class="absolute left-0 top-full mt-1 px-3 py-2 bg-gray-900 text-white text-sm rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50 max-w-md">\n${i.description.trim().replace(/</g,"&lt;").replace(/>/g,"&gt;")}\n</div>\n`:""}\n</div>\n`,function(){if(!i)return document.getElementById("recursive-toggle-btn").style.display="none",document.getElementById("category-actions-dropdown").style.display="none",void(document.getElementById("settings-btn").style.display="block");const t=a.some(t=>t.parent_id===i.id),e=document.getElementById("recursive-toggle-btn");t?(e.style.display="block",i.recursiveMode?e.className="flex items-center justify-center h-8 px-3 text-sm font-medium text-white bg-blue-600 border border-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors":e.className="flex items-center justify-center h-8 px-3 text-sm font-medium text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 dark:focus:ring-gray-400 focus:border-gray-500 transition-colors"):e.style.display="none";document.getElementById("category-actions-dropdown").style.display="block",document.getElementById("settings-btn").style.display="none"}()}function Ot(t){const e=a.reduce((t,e)=>e.parent_id?t:t+(e.recursive_post_count||e.post_count||0),0),n=a.reduce((t,e)=>!t||e.created<t.created?e:t,null),o=n?new Date(n.created).toLocaleDateString(window.AppConstants.LOCALE_SETTINGS.default,{year:"numeric",month:"long",day:"numeric"}):"Date unavailable";let i=`${e} post${1!==e?"s":""}`;g&&t&&t.file_count>0&&(i+=` • ${t.file_count} file${1!==t.file_count?"s":""} • ${E(t.total_size)}`),document.getElementById("timeline-title").innerHTML=`\n<div class="group">\n<h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">${window.AppConstants.UI_TEXT.allCategories}</h2>\n<p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5 relative">\n<span class="transition-opacity group-hover:opacity-0">${i}</span>\n<span class="absolute top-0 left-0 opacity-0 group-hover:opacity-100 transition-opacity">${o}</span>\n</p>\n</div>\n`,document.getElementById("recursive-toggle-btn").style.display="none",document.getElementById("category-actions-dropdown").style.display="none",document.getElementById("settings-btn").style.display="block"}function Rt(t,e){const n=a.find(e=>e.id===t);return!(!n||!n.parent_id)&&(n.parent_id===e||Rt(n.parent_id,e))}function Ut(t,e){const n=a.find(e=>e.id===t);n&&(n.post_count=(n.post_count||0)+e,n.recursive_post_count=(n.recursive_post_count||0)+e);let o=n;const s=[t];for(;o&&o.parent_id;){const t=a.find(t=>t.id===o.parent_id);if(!t)break;t.recursive_post_count=(t.recursive_post_count||0)+e,s.push(t.id),o=t}i&&s.includes(i.id)&&(i.id===t?(i.post_count=(i.post_count||0)+e,i.recursive_post_count=(i.recursive_post_count||0)+e):i.recursive_post_count=(i.recursive_post_count||0)+e),G()}window.showMoveModal=function(t){Ft=t;const e=Ct.find(e=>e.id===t);if(!e)return;const n=a.find(t=>t.id===e.category_id)?q(e.category_id):"Unknown Category";document.getElementById("current-category-display").textContent=n,function(t){const e=document.getElementById("move-category");e.innerHTML='<option value="">Select a category...</option>',a.forEach(n=>{if(n.id!==t){const t=q(n.id),o=document.createElement("option");o.value=n.id,o.textContent=t,e.appendChild(o)}})}(e.category_id),document.getElementById("move-modal").classList.remove("hidden"),document.querySelectorAll('[id^="post-action-menu-"]').forEach(t=>{t.classList.add("hidden")})},document.getElementById("cancel-move").addEventListener("click",Dt),document.getElementById("move-form").addEventListener("submit",async function(t){if(t.preventDefault(),!Ft)return;const e=parseInt(document.getElementById("move-category").value);if(e)try{const t=Ct.find(t=>t.id===Ft),n=t?t.category_id:null;await async function(t,e){try{return await _(`/posts/${t}/move`,{method:"PUT",body:JSON.stringify({category_id:e})})}catch(t){throw console.error("Failed to move post:",t),t}}(Ft,e),n&&Ut(n,-1),Ut(e,1);const o=a.find(t=>t.id===e),s=o?o.name:"selected category";showSuccess(`${window.AppConstants.USER_MESSAGES.success.postMoved} ${s}`);let r=!1;if(i&&i.id!==window.AppConstants.ALL_CATEGORIES_ID)if(i.recursiveMode){if(a.find(t=>t.id===e)){const t=Rt(e,i.id);r=!(e===i.id||t)}else r=!0}else r=e!==i.id;if(r)Ct=Ct.filter(t=>t.id!==Ft),kt&&kt.removeItem(Ft);else{const t=Ct.findIndex(t=>t.id===Ft);-1!==t&&(Ct[t].category_id=e)}$t(Ct,!0),i&&Nt(),setTimeout(N,100),Dt()}catch(t){x(`Failed to move post: ${t.message}`)}else x(window.AppConstants.USER_MESSAGES.error.selectCategoryToMove)}),window.confirmDeletePost=async function(t){const e=Ct.find(e=>e.id===t),n=e&&e.attachments?e.attachments:[];let o="Are you sure you want to delete this post?";n.length>0&&(o+=`\n\nThis will also delete **${n.length}** attached file(s).`),o+="\n\nThis action cannot be undone.";let i="";if(n.length>0&&(i+='<div class="mb-4"><h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Files to be deleted:</h4>',i+='<div class="bg-gray-50 dark:bg-gray-800 rounded p-3 max-h-32 overflow-y-auto"><ul class="text-sm text-gray-600 dark:text-gray-400 space-y-1">',n.forEach(t=>{i+=`<li class="flex justify-between items-center">\n<span>• ${t.filename}</span>\n<span class="text-xs text-gray-400 dark:text-gray-500">${E(t.file_size)}</span>\n</li>`}),i+="</ul></div></div>"),await I("Delete Post",o,i))try{await async function(t){try{await _(`/posts/${t}`,{method:"DELETE"})}catch(t){throw console.error("Failed to delete post:",t),t}}(t),showSuccess(""),e&&e.category_id&&Ut(e.category_id,-1),Nt(),setTimeout(N,100),Ct=Ct.filter(e=>e.id!==t),kt?kt.removeItem(t):$t(Ct,!0)}catch(t){console.error(t),x(w(window.AppConstants.USER_MESSAGES.error.failedToDeletePost,t.message))}},window.navigateToCategoryFromPost=function(t){const e=a.find(e=>e.id===t);e&&z(e)},window.scrollAttachments=function(t,e){const n=t.closest("div").parentNode.querySelector("[data-attachment-container]");if(!n)return;n.scrollBy({left:200*e,behavior:"smooth"})};let Gt={},Ht={};function zt(){const t=document.getElementById("retroactivePostingEnabled").checked,e=document.getElementById("retroactivePostingTimeFormatContainer");e&&(e.style.display=t?"block":"none")}async function Vt(){window.router.navigate("/settings"),o()}function jt(){window.router?void 0!==a&&a&&0!==a.length?n.handleCategoryRoute("/"):(window.router.navigate("/"),ye()):(document.getElementById("settings-page").classList.add("hidden"),document.querySelector(".container").style.display="block",function(){const t=document.getElementById("settings-status");t.classList.add("hidden"),t.innerHTML=""}())}async function Yt(){try{Gt=await T(),Ht={...Gt}}catch(t){throw console.error("Error loading settings:",t),t}}function qt(){document.getElementById("maxContentLength").value=Gt.maxContentLength||window.AppConstants.DEFAULT_SETTINGS.maxContentLength,document.getElementById("siteTitle").value=Gt.siteTitle||window.AppConstants.APP_NAME,document.getElementById("siteDescription").value=Gt.siteDescription||window.AppConstants.APP_DESCRIPTION,document.getElementById("activityEnabled").checked=void 0!==Gt.activityEnabled?Gt.activityEnabled:window.AppConstants.DEFAULT_SETTINGS.activityEnabled,document.getElementById("fileStatsEnabled").checked=void 0!==Gt.fileStatsEnabled?Gt.fileStatsEnabled:window.AppConstants.DEFAULT_SETTINGS.fileStatsEnabled,document.getElementById("retroactivePostingEnabled").checked=void 0!==Gt.retroactivePostingEnabled&&Gt.retroactivePostingEnabled,document.getElementById("fileUploadEnabled").checked=void 0===Gt.fileUploadEnabled||Gt.fileUploadEnabled,document.getElementById("maxFileSizeMB").value=Gt.maxFileSizeMB||window.AppConstants.DEFAULT_SETTINGS.maxFileSizeMB,document.getElementById("maxFilesPerPost").value=Gt.maxFilesPerPost||window.AppConstants.DEFAULT_SETTINGS.maxFilesPerPost,Gt.allowedFileExtensions&&Array.isArray(Gt.allowedFileExtensions)?document.getElementById("allowedFileExtensions").value=Gt.allowedFileExtensions.join(", "):document.getElementById("allowedFileExtensions").value=window.AppConstants.DEFAULT_ALLOWED_EXTENSIONS;const t=Gt.retroactivePostingTimeFormat||window.AppConstants.DEFAULT_SETTINGS.retroactivePostingTimeFormat;document.getElementById("retroactivePostingTimeFormat").value=t,Wt(),zt(),Jt()}async function P(){const t=function(){const t=document.getElementById("allowedFileExtensions").value.split(",").map(t=>t.trim().toLowerCase()).filter(t=>t.length>0);return{maxContentLength:parseInt(document.getElementById("maxContentLength").value),siteTitle:document.getElementById("siteTitle").value.trim(),siteDescription:document.getElementById("siteDescription").value.trim(),activityEnabled:document.getElementById("activityEnabled").checked,fileStatsEnabled:document.getElementById("fileStatsEnabled").checked,retroactivePostingEnabled:document.getElementById("retroactivePostingEnabled").checked,retroactivePostingTimeFormat:document.getElementById("retroactivePostingTimeFormat").value,fileUploadEnabled:document.getElementById("fileUploadEnabled").checked,maxFileSizeMB:parseInt(document.getElementById("maxFileSizeMB").value),maxFilesPerPost:parseInt(document.getElementById("maxFilesPerPost").value),allowedFileExtensions:t}}(),e=function(t){const e=[];return(t.maxFileSizeMB<window.AppConstants.VALIDATION_LIMITS.minFileSizeMB||t.maxFileSizeMB>window.AppConstants.VALIDATION_LIMITS.maxFileSizeMB)&&e.push(w(window.AppConstants.USER_MESSAGES.validation.fileSizeValidation,window.AppConstants.VALIDATION_LIMITS.minFileSizeMB,window.AppConstants.VALIDATION_LIMITS.maxFileSizeMB,window.AppConstants.VALIDATION_LIMITS.maxFileSizeMB/1024)),(t.maxContentLength<window.AppConstants.VALIDATION_LIMITS.minContentLength||t.maxContentLength>window.AppConstants.VALIDATION_LIMITS.maxContentLength)&&e.push(w(window.AppConstants.USER_MESSAGES.validation.contentLengthValidation,window.AppConstants.VALIDATION_LIMITS.minContentLength,window.AppConstants.VALIDATION_LIMITS.maxContentLength)),(t.maxFilesPerPost<window.AppConstants.VALIDATION_LIMITS.minFilesPerPost||t.maxFilesPerPost>window.AppConstants.VALIDATION_LIMITS.maxFilesPerPost)&&e.push(w(window.AppConstants.USER_MESSAGES.validation.filesPerPostValidation,window.AppConstants.VALIDATION_LIMITS.minFilesPerPost,window.AppConstants.VALIDATION_LIMITS.maxFilesPerPost)),(!t.siteTitle||0===t.siteTitle.length||t.siteTitle.length>window.AppConstants.VALIDATION_LIMITS.maxSiteTitleLength)&&e.push(`Site title must be between 1 and ${window.AppConstants.VALIDATION_LIMITS.maxSiteTitleLength} characters`),t.siteDescription.length>window.AppConstants.VALIDATION_LIMITS.maxSiteDescriptionLength&&e.push(`Site description must not exceed ${window.AppConstants.VALIDATION_LIMITS.maxSiteDescriptionLength} characters`),e}(t);if(e.length>0)Kt(e.join("<br>"),"error");else try{Kt(window.AppConstants.USER_MESSAGES.info.savingSettings,"info");const e=await fetch("/api/settings",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok){const t=await e.text();throw new Error(t||`HTTP error! status: ${e.status}`)}const n=await e.json();L(),Gt=n,Ht={...n},async function(){"function"==typeof refreshCharacterCounter&&await refreshCharacterCounter();await ge()}(),await f(),await h(),n.siteTitle&&function(t){const e=window.router?.getCurrentRoute();"/settings"===e?document.title=`${t} - Settings`:"/"!==e&&e||(document.title=`${t} - Personal Micro Blog`)}(n.siteTitle),showSuccess(window.AppConstants.USER_MESSAGES.success.settingsSaved),setTimeout(()=>{window.router?window.router.navigate("/"):jt()},window.AppConstants.UI_CONFIG.successMessageDelay)}catch(t){console.error("Error saving settings:",t),x(w(window.AppConstants.USER_MESSAGES.error.failedToSaveSettings,t.message))}}function Xt(){qt(),window.router?window.router.navigate("/"):jt()}function Zt(){confirm(window.AppConstants.USER_MESSAGES.info.resetSettingsConfirm)&&(document.getElementById("maxFileSizeMB").value=window.AppConstants.DEFAULT_SETTINGS.maxFileSizeMB,document.getElementById("maxContentLength").value=window.AppConstants.DEFAULT_SETTINGS.maxContentLength,document.getElementById("maxFilesPerPost").value=window.AppConstants.DEFAULT_SETTINGS.maxFilesPerPost,Kt(window.AppConstants.USER_MESSAGES.info.settingsResetInfo,"info"))}function Kt(t,e="info"){const n=document.getElementById("settings-status");switch(n.classList.remove("hidden"),n.classList.remove("text-green-600","text-red-600","text-blue-600","text-gray-600"),e){case"success":n.classList.add("text-green-600");break;case"error":n.classList.add("text-red-600");break;case"info":n.classList.add("text-blue-600");break;default:n.classList.add("text-gray-600")}n.innerHTML=t}function Jt(){const t=document.getElementById("fileUploadEnabled").checked,e=document.getElementById("fileUploadDetails");e.style.display=t?"block":"none"}function Wt(){const t=document.getElementById("siteDescription"),e=document.getElementById("site-description-counter");t&&e&&(e.textContent=t.value.length)}function Qt(){const t=document.getElementById("timeline-header");if(!t)return;const e=window.scrollY>window.AppConstants.UI_CONFIG.scrollThreshold;e&&!t.classList.contains("scrolled")?(t.classList.add("scrolled"),document.body.classList.add("header-scrolled")):!e&&t.classList.contains("scrolled")&&(t.classList.remove("scrolled"),document.body.classList.remove("header-scrolled"))}async function te(){if(!i)return void x(window.AppConstants.USER_MESSAGES.error.pleaseSelectCategory);document.getElementById("create-post-modal").classList.remove("hidden"),document.body.style.overflow="hidden";const t=function(t){if(!t||t.id===window.AppConstants.ALL_CATEGORIES_ID)return window.AppConstants.UI_TEXT.allCategories;const e=[];let n=t;for(;n;)e.unshift(n.name),n=n.parent_id?a.find(t=>t.id===n.parent_id):null;return e.join(" > ")}(i);document.getElementById("modal-category-name").textContent=t,document.getElementById("modal-post-content").focus();try{const t=window.currentSettings,e=document.getElementById("modal-retroactive-section"),n=document.getElementById("modal-attachments-section");if(t&&t.retroactivePostingEnabled){e.style.setProperty("display","block","important");const n=t.retroactivePostingTimeFormat||"24h",o=new Date;let i;if("12h"===n){const t=String(o.getMonth()+1).padStart(2,"0"),e=String(o.getDate()).padStart(2,"0"),n=o.getFullYear();let a=o.getHours();const s=String(o.getMinutes()).padStart(2,"0"),r=a>=12?window.AppConstants.TIME_FORMAT.pm:window.AppConstants.TIME_FORMAT.am;a=a%12||12,i=`${t}/${e}/${n} ${String(a).padStart(2,"0")}:${s} ${r}`}else{const t=String(o.getDate()).padStart(2,"0"),e=String(o.getMonth()+1).padStart(2,"0"),n=o.getFullYear(),a=String(o.getHours()).padStart(2,"0");i=`${t}/${e}/${n} ${a}:${String(o.getMinutes()).padStart(2,"0")}`}const a=document.getElementById("modal-post-datetime");a.value=i,a.dataset.originalValue=i,a.dataset.timeFormat=n}else e.style.setProperty("display","none","important");t&&!1!==t.fileUploadEnabled?n.style.display="block":n.style.display="none"}catch(t){console.error("Failed to load settings:",t),document.getElementById("modal-retroactive-section").style.setProperty("display","none","important")}setTimeout(()=>{!function(){const t=document.getElementById("modal-post-content");t&&(t.linkPreviewInputHandler&&t.removeEventListener("input",t.linkPreviewInputHandler),t.linkPreviewInputHandler=async e=>{const n=e.target.value;t.linkPreviewTimeout&&clearTimeout(t.linkPreviewTimeout),t.linkPreviewTimeout=setTimeout(async()=>{await bt(n)},window.AppConstants.UI_CONFIG.debounceDelay)},t.addEventListener("input",t.linkPreviewInputHandler),t.value.trim()&&bt(t.value))}()},window.AppConstants.UI_CONFIG.settingsTransitionDelay)}function ee(){document.getElementById("create-post-modal").classList.add("hidden"),document.body.style.overflow="",document.getElementById("modal-create-post-form").reset();const t=document.getElementById("modal-post-datetime");t&&(t.value=""),d.clear(),window.modalPastedFiles=[],ot(),function(){vt=[],Et=0,xt=0;const t=document.getElementById("modal-link-preview-container");t&&(t.style.display="none")}();const e=document.getElementById("modal-char-counter");e&&window.currentSettings&&(e.textContent=`0 / ${window.currentSettings.maxContentLength}`)}function ne(){document.getElementById("category-modal").classList.remove("hidden"),document.body.style.overflow="hidden";const t=document.getElementById("category-parent");i&&i.id!==window.AppConstants.ALL_CATEGORIES_ID?t.value=i.id.toString():t.value="",document.getElementById("category-name").setAttribute("maxlength",window.AppConstants.VALIDATION_LIMITS.maxCategoryNameLength),document.getElementById("category-name").focus()}function oe(){document.getElementById("category-modal").classList.add("hidden"),document.body.style.overflow="",document.getElementById("category-form").reset(),document.getElementById("category-description").value="",ce("category-description","description-counter")}function ie(){(!function(){const t=document.getElementById("category-name").value.trim(),e=document.getElementById("category-description").value.trim();return t.length>0||e.length>0}()||confirm(window.AppConstants.USER_MESSAGES.confirm.unsavedContent))&&oe()}function ae(){if(!i||i.id===window.AppConstants.ALL_CATEGORIES_ID)return void x(window.AppConstants.USER_MESSAGES.error.pleaseSelectCategory);document.getElementById("edit-category-modal").classList.remove("hidden"),document.body.style.overflow="hidden",document.getElementById("edit-category-name").value=i.name,document.getElementById("edit-category-description").value=i.description||"",ce("edit-category-description","edit-description-counter");const t=document.querySelector("#edit-category-modal .mb-4:has(#edit-category-parent)");const e=function t(e){const n=a.filter(t=>t.parent_id===e);if(0===n.length)return 0;let o=0;for(let e of n){const n=1+t(e.id);o=Math.max(o,n)}return o}(i.id),n=new Set([i.id]);!function t(e){a.filter(t=>t.parent_id===e).forEach(e=>{n.add(e.id),t(e.id)})}(i.id);a.some(t=>{if(n.has(t.id))return!1;return t.depth+1+e<=window.AppConstants.MAX_CATEGORY_DEPTH})?(t&&(t.style.display="block"),function(){const t=document.getElementById("edit-category-parent");t.innerHTML='<option value="">None (Root Category)</option>';const e=new Set([i.id]);function n(t){a.filter(e=>e.parent_id===t).forEach(t=>{e.add(t.id),n(t.id)})}function o(t){const e=a.filter(e=>e.parent_id===t);if(0===e.length)return 0;let n=0;for(let t of e){const e=1+o(t.id);n=Math.max(n,e)}return n}n(i.id);const s=o(i.id),r=a.filter(t=>{if(e.has(t.id))return!1;return t.depth+1+s<=window.AppConstants.MAX_CATEGORY_DEPTH});r.forEach(e=>{const n=document.createElement("option");n.value=e.id;const o=le(e.id,!0);n.textContent=o,t.appendChild(n)})}(),i.parent_id?document.getElementById("edit-category-parent").value=i.parent_id.toString():document.getElementById("edit-category-parent").value=""):t&&(t.style.display="none"),document.getElementById("edit-category-name").setAttribute("maxlength",window.AppConstants.VALIDATION_LIMITS.maxCategoryNameLength),document.getElementById("edit-category-name").focus()}function se(){document.getElementById("edit-category-modal").classList.add("hidden"),document.body.style.overflow="",document.getElementById("edit-category-form").reset(),document.getElementById("edit-category-description").value="",ce("edit-category-description","edit-description-counter")}function re(){(!function(){if(!i)return!1;const t=document.getElementById("edit-category-name").value.trim(),e=document.getElementById("edit-category-description").value.trim(),n=document.getElementById("edit-category-parent").value||null,o=i.parent_id?i.parent_id.toString():null,a=n?n.toString():null,s=t!==i.name,r=e!==(i.description||""),d=o!==a;return s||r||d}()||confirm(window.AppConstants.USER_MESSAGES.confirm.unsavedContent))&&se()}function de(){const t=document.getElementById("category-parent");t.innerHTML='<option value="">None (Root Category)</option>';a.filter(t=>t.depth<window.AppConstants.MAX_CATEGORY_DEPTH).forEach(e=>{const n=document.createElement("option");n.value=e.id;const o=le(e.id,!0);n.textContent=o,t.appendChild(n)})}function le(t,e=!1){const n=a.find(e=>e.id===t);if(!n)return"";const o=[];let i=n;for(;i;)o.unshift(i.name),i=i.parent_id?a.find(t=>t.id===i.parent_id):null;if(e&&o.length>1){return`${o.slice(0,-1).join(" > ")} ➤ ${o[o.length-1]}`}return o.join(" > ")}function ce(t,e){const n=document.getElementById(t),o=document.getElementById(e);n&&o&&(o.textContent=n.value.length)}document.addEventListener("DOMContentLoaded",function(){document.getElementById("settings-btn").addEventListener("click",Vt),document.getElementById("settings-back-btn").addEventListener("click",jt),document.getElementById("cancel-settings-btn").addEventListener("click",Xt),document.getElementById("save-settings-btn").addEventListener("click",P),document.getElementById("reset-settings-btn").addEventListener("click",Zt),document.getElementById("retroactivePostingEnabled").addEventListener("change",zt);const t=document.getElementById("fileUploadEnabled");t&&(t.addEventListener("change",Jt),setTimeout(()=>Jt(),100));const e=document.getElementById("siteDescription");e&&e.addEventListener("input",Wt)});class me{constructor(t,e=window.AppConstants.UI_CONFIG.defaultItemHeight){this.container=t,this.itemHeight=e,this.visibleItems=Math.ceil(window.innerHeight/e)+window.AppConstants.UI_CONFIG.virtualScrollBuffer,this.scrollTop=0,this.items=[],this.renderedItems=new Map,this.viewport=document.createElement("div"),this.viewport.style.cssText="position: relative; overflow: auto; height: 100%;",this.content=document.createElement("div"),this.content.style.cssText="position: relative;",this.viewport.appendChild(this.content),this.container.innerHTML="",this.container.appendChild(this.viewport),this.viewport.addEventListener("scroll",this.handleScroll.bind(this)),window.addEventListener("resize",this.handleResize.bind(this))}setItems(t){this.items=t,this.updateContentHeight(),this.render()}addItems(t){this.items=[...this.items,...t],this.updateContentHeight(),this.render()}removeItem(t){this.items=this.items.filter(e=>e.id!==t),this.updateContentHeight(),this.render()}updateContentHeight(){const t=this.items.length*this.itemHeight;this.content.style.height=`${t}px`}handleScroll(){this.scrollTop=this.viewport.scrollTop,this.render()}handleResize(){this.visibleItems=Math.ceil(window.innerHeight/this.itemHeight)+window.AppConstants.UI_CONFIG.virtualScrollBuffer,this.render()}render(){const t=Math.floor(this.scrollTop/this.itemHeight),e=Math.min(t+this.visibleItems,this.items.length);for(const[n,o]of this.renderedItems.entries())(n<t||n>=e)&&(o.parentNode&&o.parentNode.removeChild(o),this.renderedItems.delete(n));for(let n=t;n<e;n++)if(!this.renderedItems.has(n)&&this.items[n]){const t=this.createItemElement(this.items[n]);t.style.cssText=`position: absolute; top: ${n*this.itemHeight}px; left: 0; right: 0;`,this.content.appendChild(t),this.renderedItems.set(n,t)}}createItemElement(t){const e=document.createElement("div");return e.textContent=`Item ${t.id}`,e.style.height=`${this.itemHeight}px`,e}scrollToTop(){this.viewport.scrollTop=0}destroy(){window.removeEventListener("resize",this.handleResize.bind(this)),this.viewport.removeEventListener("scroll",this.handleScroll.bind(this))}}class ue extends me{constructor(t){super(t,window.AppConstants.UI_CONFIG.postsVirtualScrollHeight),this.postHeights=new Map}createItemElement(t){const e=Pt(t);document.body.appendChild(e);const n=e.offsetHeight;return document.body.removeChild(e),this.postHeights.set(t.id,n),e}getItemHeight(t){const e=this.items[t];return this.postHeights.get(e.id)||this.itemHeight}}function pe(){(!function(){const t=document.getElementById("modal-post-content").value.trim(),e=d.size>0||window.modalPastedFiles&&window.modalPastedFiles.length>0,n=vt.length>0;return t.length>0||e||n}()||confirm(window.AppConstants.USER_MESSAGES.confirm.unsavedContent))&&ee()}async function ge(){const t=document.getElementById("modal-file-upload-text");if(!t)return;const e=window.currentSettings;e&&(t.textContent=`Or drag and drop files here (max ${e.maxFilesPerPost} files)`)}async function ye(){const t=document.getElementById("categories-tree");t&&(t.innerHTML='\n<div class="text-center text-gray-500 dark:text-gray-400 py-8">\n<i class="fas fa-spinner fa-spin text-4xl mb-4"></i>\n<p>Loading categories...</p>\n</div>\n');const e=async function(){return A||(A=await T()),A}(),o="/"===window.location.pathname||n.isCategoryPath(window.location.pathname)?k():Promise.resolve();window.currentSettings=await e;const i=window.AppConstants.VALIDATION_LIMITS.maxCategoryDescriptionLength;document.getElementById("category-description").setAttribute("maxlength",i),document.getElementById("edit-category-description").setAttribute("maxlength",i),document.getElementById("description-max-length").textContent=i,document.getElementById("edit-description-max-length").textContent=i,function(){const t=localStorage.getItem(window.AppConstants.STORAGE_KEYS.expandedCategories);t&&(s=new Set(JSON.parse(t)))}(),f(),h(),await o,window.addEventListener("scroll",Qt),async function(){const t=document.getElementById("modal-post-content"),e=document.getElementById("modal-char-counter");function n(){const n=window.currentSettings;if(!n)return;const o=t.value.length;e.textContent=`${o} / ${n.maxContentLength}`,o>.9*n.maxContentLength?(e.classList.remove("text-gray-500","text-yellow-600"),e.classList.add("text-red-600")):o>.7*n.maxContentLength?(e.classList.remove("text-gray-500","text-red-600"),e.classList.add("text-yellow-600")):(e.classList.remove("text-yellow-600","text-red-600"),e.classList.add("text-gray-500"));const i=document.getElementById("modal-submit-post");0===o||o>n.maxContentLength?(i.disabled=!0,i.classList.add("opacity-50","cursor-not-allowed")):(i.disabled=!1,i.classList.remove("opacity-50","cursor-not-allowed"))}t&&e&&(n(),t.addEventListener("input",n))}(),function(){const t=document.getElementById("modal-post-content");if(!t)return;function e(){t.style.height="auto";const e=Math.min(Math.max(t.scrollHeight,100),200);t.style.height=e+"px"}t.addEventListener("input",e),e()}(),ge(),Q()}if(document.addEventListener("DOMContentLoaded",function(){ye(),document.getElementById("add-category-btn").onclick=ne,document.getElementById("cancel-category").onclick=ie,document.getElementById("category-name").addEventListener("input",function(t){const e=t.target.value.trim(),n=document.querySelector('button[form="category-form"]');if(!n)return;e.length>0&&/^[a-zA-Z0-9]+(?:\s[a-zA-Z0-9]+)*$/.test(e)?(n.disabled=!1,n.classList.remove("opacity-50","cursor-not-allowed")):(n.disabled=!0,n.classList.add("opacity-50","cursor-not-allowed"))}),document.getElementById("category-form").onsubmit=async function(t){t.preventDefault();const e=document.getElementById("category-name").value.trim();if(0===e.length)return void x(window.AppConstants.USER_MESSAGES.error.categoryNameEmpty);if(e.length>window.AppConstants.VALIDATION_LIMITS.maxCategoryNameLength)return void x(w(window.AppConstants.USER_MESSAGES.error.categoryNameTooLong,window.AppConstants.VALIDATION_LIMITS.maxCategoryNameLength));if(!/^[a-zA-Z0-9]+(?:\s[a-zA-Z0-9]+)*$/.test(e))return void x(window.AppConstants.USER_MESSAGES.error.categoryNameInvalidChars);const n=document.getElementById("category-parent").value||null,o=document.getElementById("category-description").value.trim();try{const t=await async function(t,e,n=""){try{const o=e?parseInt(e):null,i=await _("/categories",{method:"POST",body:JSON.stringify({name:t,description:n,parent_id:o})});return i&&Array.isArray(a)&&(a.push(i),Y()),i}catch(t){throw console.error("Failed to create category:",t),t}}(e,n,o);if(oe(),t){const e=document.getElementById("posts-container");e&&(e.innerHTML='\n<div class="text-center text-gray-500 dark:text-gray-400 py-8">\n<i class="fas fa-spinner fa-spin text-4xl mb-4"></i>\n<p>Loading posts...</p>\n</div>\n'),de(),z(t),showSuccess("")}}catch(t){x(t.message)}},document.getElementById("new-post-btn").onclick=te,document.getElementById("close-post-modal").onclick=pe,document.getElementById("modal-cancel-post").onclick=pe,document.getElementById("modal-link-prev").onclick=()=>St("prev"),document.getElementById("modal-link-next").onclick=()=>St("next"),document.getElementById("recursive-toggle-btn").addEventListener("click",()=>{i&&j(i)}),document.getElementById("delete-category-btn").addEventListener("click",()=>{i&&Z(i)}),document.getElementById("edit-category-btn").addEventListener("click",()=>{i&&ae()});const t=document.getElementById("category-actions-btn"),e=document.getElementById("category-actions-menu");t.addEventListener("click",t=>{t.stopPropagation(),e.classList.toggle("hidden")}),document.addEventListener("click",n=>{t.contains(n.target)||e.contains(n.target)||e.classList.add("hidden")}),document.getElementById("cancel-edit-category").onclick=re,document.getElementById("category-description").addEventListener("input",function(){ce("category-description","description-counter")}),document.getElementById("edit-category-description").addEventListener("input",function(){ce("edit-category-description","edit-description-counter")}),document.getElementById("edit-category-name").addEventListener("input",function(t){const e=t.target.value.trim(),n=document.querySelector('button[form="edit-category-form"]');if(!n)return;0===e.length||e.length>window.AppConstants.VALIDATION_LIMITS.maxCategoryNameLength||!/^[a-zA-Z0-9]+(?:\s[a-zA-Z0-9]+)*$/.test(e)?(n.disabled=!0,n.classList.add("opacity-50","cursor-not-allowed")):(n.disabled=!1,n.classList.remove("opacity-50","cursor-not-allowed"))}),document.getElementById("edit-category-form").onsubmit=async function(t){t.preventDefault();const e=document.getElementById("edit-category-name").value.trim();if(0===e.length)return void x(window.AppConstants.USER_MESSAGES.error.categoryNameEmpty);if(e.length>window.AppConstants.VALIDATION_LIMITS.maxCategoryNameLength)return void x(w(window.AppConstants.USER_MESSAGES.error.categoryNameTooLong,window.AppConstants.VALIDATION_LIMITS.maxCategoryNameLength));if(!/^[a-zA-Z0-9]+(?:\s[a-zA-Z0-9]+)*$/.test(e))return void x(window.AppConstants.USER_MESSAGES.error.categoryNameInvalidChars);const n=document.getElementById("edit-category-parent").value||null,o=document.getElementById("edit-category-description").value.trim();if(o.length>window.AppConstants.VALIDATION_LIMITS.maxCategoryDescriptionLength)return void x(w(window.AppConstants.USER_MESSAGES.error.categoryDescTooLong,window.AppConstants.VALIDATION_LIMITS.maxCategoryDescriptionLength));const s=i.parent_id?i.parent_id.toString():null,r=n?n.toString():null,d=e!==i.name,l=o!==(i.description||"");if(d||l||s!==r)try{const t=await async function(t,e,n,o){try{const i=o?parseInt(o):null,s=await _(`/categories/${t}`,{method:"PUT",body:JSON.stringify({name:e,description:n,parent_id:i})});if(s&&Array.isArray(a)){const e=a.findIndex(e=>e.id===t);-1!==e&&(a[e]=s),Y()}return s}catch(t){throw console.error("Failed to update category:",t),t}}(i.id,e,o,n);se(),t&&(de(),z(t),showSuccess(""))}catch(t){x(t.message)}else se()},document.getElementById("modal-create-post-form").onsubmit=async function(t){if(t.preventDefault(),!i)return void x(window.AppConstants.USER_MESSAGES.error.noCategorySelected);const e=document.getElementById("modal-post-content").value;if(!e.trim())return void x(window.AppConstants.USER_MESSAGES.error.contentRequired);const n=window.currentSettings;if(n&&e.length>n.maxContentLength)x(window.AppConstants.USER_MESSAGES.error.contentTooLong.replace("{0}",n.maxContentLength));else try{const t={category_id:i.id,content:e,link_previews:At?At():[]},n=document.getElementById("modal-post-datetime");if(n&&n.value){if(n.dataset.originalValue!==n.value){let e;if(e="12h"===(n.dataset.timeFormat||"24h")?function(t){try{const e=t.trim().split(" ");if(3!==e.length)return null;const n=e[0].split("/");if(3!==n.length)return null;const o=e[1].split(":");if(2!==o.length)return null;const i=parseInt(n[0],10)-1,a=parseInt(n[1],10),s=parseInt(n[2],10);let r=parseInt(o[0],10);const d=parseInt(o[1],10),l=e[2].toUpperCase();return l===window.AppConstants.TIME_FORMAT.pm&&12!==r?r+=12:l===window.AppConstants.TIME_FORMAT.am&&12===r&&(r=0),new Date(s,i,a,r,d)}catch(t){return null}}(n.value):function(t){try{const e=t.trim().split(" ");if(2!==e.length)return null;const n=e[0].split("/");if(3!==n.length)return null;const o=e[1].split(":");if(2!==o.length)return null;const i=parseInt(n[0],10),a=parseInt(n[1],10)-1,s=parseInt(n[2],10),r=parseInt(o[0],10),d=parseInt(o[1],10);return new Date(s,a,i,r,d)}catch(t){return null}}(n.value),!e||isNaN(e.getTime()))return void x("Invalid date format");const o=new Date(window.AppConstants.MIN_RETROACTIVE_POST_TIMESTAMP),i=new Date;if(e<o)return void x(`Date cannot be earlier than ${o.toLocaleDateString()}`);if(e>i)return void x("Date cannot be in the future");t.custom_timestamp=e.getTime()}}const o=await _("/posts",{method:"POST",body:JSON.stringify(t)});if(d&&d.size>0)for(let[t,e]of d)await $(o.id,e);if(window.modalPastedFiles&&window.modalPastedFiles.length>0){for(let t of window.modalPastedFiles)await $(o.id,t);window.modalPastedFiles=[]}ee();const a=await _(`/posts/${o.id}`);let s=0;for(let t=0;t<Ct.length;t++){if(a.created>=Ct[t].created){s=t;break}s=t+1}(s<Ct.length||s===Ct.length&&!Lt)&&Ct.splice(s,0,a),$t(Ct,!0),Ut(i.id,1),Nt(),showSuccess(""),setTimeout(N,100)}catch(t){x(t.message)}},document.getElementById("modal-post-content").addEventListener("paste",function(t){const e=t.clipboardData.items;for(let n of e)if(n.type.startsWith("image/")){t.preventDefault();const e=n.getAsFile();if(e){window.modalPastedFiles||(window.modalPastedFiles=[]);const t=(new Date).toISOString().replace(/[:.]/g,"-"),n=e.type.split("/")[1]||"png",o=new File([e],`pasted-image-${t}.${n}`,{type:e.type});window.modalPastedFiles.push(o),st()}}});const n=document.getElementById("modal-post-files");n.addEventListener("change",async function(t){for(let e of t.target.files)await nt(e);t.target.value=""});const o=n.parentElement;o.addEventListener("dragover",function(t){t.preventDefault(),o.classList.add("bg-blue-50","border-blue-300")}),o.addEventListener("dragleave",function(t){t.preventDefault(),o.classList.remove("bg-blue-50","border-blue-300")}),o.addEventListener("drop",async function(t){t.preventDefault(),o.classList.remove("bg-blue-50","border-blue-300");for(let e of t.dataTransfer.files)await nt(e)});const s=document.getElementById("modal-set-current-time");s&&s.addEventListener("click",function(){const t=document.getElementById("modal-post-datetime"),e=t.dataset.timeFormat||"24h",n=new Date;let o;if("12h"===e){const t=String(n.getMonth()+1).padStart(2,"0"),e=String(n.getDate()).padStart(2,"0"),i=n.getFullYear();let a=n.getHours();const s=String(n.getMinutes()).padStart(2,"0"),r=a>=12?window.AppConstants.TIME_FORMAT.pm:window.AppConstants.TIME_FORMAT.am;a=a%12||12,o=`${t}/${e}/${i} ${String(a).padStart(2,"0")}:${s} ${r}`}else{o=`${String(n.getDate()).padStart(2,"0")}/${String(n.getMonth()+1).padStart(2,"0")}/${n.getFullYear()} ${String(n.getHours()).padStart(2,"0")}:${String(n.getMinutes()).padStart(2,"0")}`}t.value=o,t.dataset.originalValue=o}),document.getElementById("viewer-close").onclick=lt,document.getElementById("viewer-prev").onclick=()=>ct("prev"),document.getElementById("viewer-next").onclick=()=>ct("next"),document.addEventListener("keydown",function(t){const e=document.getElementById("image-viewer-modal"),n=document.getElementById("create-post-modal"),o=document.getElementById("category-modal"),i=document.getElementById("edit-category-modal"),a=document.getElementById("move-modal"),s=document.getElementById("confirmation-modal");if(e.classList.contains("hidden")){if(n.classList.contains("hidden")){if(o.classList.contains("hidden")){if(i.classList.contains("hidden")){if(a.classList.contains("hidden")){if(!s.classList.contains("hidden")&&"Escape"===t.key)document.getElementById("confirmation-cancel").click()}else if("Escape"===t.key)Dt()}else if("Escape"===t.key)re()}else if("Escape"===t.key)ie()}else if("Escape"===t.key)pe()}else switch(t.key){case"Escape":lt();break;case"ArrowLeft":ct("prev");break;case"ArrowRight":ct("next")}}),document.getElementById("category-modal").onclick=function(t){t.target===this&&ie()},document.getElementById("edit-category-modal").onclick=function(t){t.target===this&&re()},document.getElementById("image-viewer-modal").onclick=function(t){const e=t.target===this||t.target.classList.contains("absolute"),n="viewer-image"===t.target.id,o=t.target.closest("button");!e||n||o||lt()},document.getElementById("create-post-modal").onclick=function(t){t.target===this&&pe()},document.getElementById("move-modal").onclick=function(t){t.target===this&&Dt()},document.getElementById("confirmation-modal").onclick=function(t){t.target===this&&document.getElementById("confirmation-cancel").click()}}),"undefined"!=typeof window&&window.visualViewport){window.visualViewport.addEventListener("resize",function(){const t=window.visualViewport;document.querySelectorAll(".modal-mobile-full").forEach(e=>{if(!e.closest(".hidden")){const n=window.innerHeight-t.height;n>0?(e.style.setProperty("--keyboard-height",`${n}px`),e.classList.add("keyboard-open")):(e.style.removeProperty("--keyboard-height"),e.classList.remove("keyboard-open"))}})})}let fe=window.innerHeight;document.addEventListener("focusin",function(t){t.target.matches(".modal-mobile-full input, .modal-mobile-full textarea")&&setTimeout(()=>{t.target.scrollIntoView({behavior:"smooth",block:"center"})},300)}),window.addEventListener("resize",function(){clearTimeout(window.resizeTimeout),window.resizeTimeout=setTimeout(function(){i&&"none"!==document.getElementById("activity-container").style.display&&F&&O(F),i&&i.id!==window.AppConstants.ALL_CATEGORIES_ID&&Nt(),window.visualViewport||function(){const t=window.innerHeight,e=fe-t;document.querySelectorAll(".modal-mobile-full").forEach(t=>{if(!t.closest(".hidden"))if(e>150){t.classList.add("keyboard-open");const e=t.querySelector("input:focus, textarea:focus");e&&setTimeout(()=>{e.scrollIntoView({behavior:"smooth",block:"center"})},300)}else t.classList.remove("keyboard-open")})}()},300)});