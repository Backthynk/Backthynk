function updateFavicon(e){const t=e?"dark":"light",n=document.getElementById("favicon-ico"),s=document.getElementById("favicon-16"),o=document.getElementById("favicon-32");n&&(n.href=`/static/images/${t}/favicon.ico`),s&&(s.href=`/static/images/${t}/favicon-16x16.png`),o&&(o.href=`/static/images/${t}/favicon-32x32.png`)}function initDarkMode(){const e=localStorage.getItem("darkMode")==="true";e?document.documentElement.classList.add("dark"):document.documentElement.classList.remove("dark"),updateFavicon(e)}function toggleDarkMode(){const e=document.documentElement.classList.toggle("dark");localStorage.setItem("darkMode",e),updateFavicon(e),typeof updateActivityHeatmapColors=="function"&&updateActivityHeatmapColors()}initDarkMode(),document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("theme-toggle-btn");e&&e.addEventListener("click",toggleDarkMode)});const APP_NAME="Backthynk",APP_TAGLINE="Personal Micro Blog",APP_DESCRIPTION="Personal micro blog platform",RESERVED_ROUTES=["api","static","uploads","settings"],ALL_CATEGORIES_ID=0,MAX_CATEGORY_DEPTH=2,DEFAULT_SETTINGS={maxFileSizeMB:100,maxContentLength:15e3,maxFilesPerPost:20,activityEnabled:!0,fileStatsEnabled:!0,retroactivePostingEnabled:!1,retroactivePostingTimeFormat:"24h"},VALIDATION_LIMITS={minFileSizeMB:1,maxFileSizeMB:10240,minContentLength:100,maxContentLength:5e4,minFilesPerPost:1,maxFilesPerPost:50,maxCategoryNameLength:30,maxCategoryDescriptionLength:280,maxSiteTitleLength:100,maxSiteDescriptionLength:160},USER_MESSAGES={success:{categoryDeleted:"deleted successfully!",postMoved:"Post successfully moved to",settingsSaved:"Settings saved successfully!"},error:{categoryNameEmpty:"Category name cannot be empty",categoryNameTooLong:"Category name must be {0} characters or less",categoryNameInvalidChars:"Category name can only contain letters, numbers, and single spaces",categoryDescTooLong:"Description cannot exceed {0} characters",noCategorySelected:"No category selected",pleaseSelectCategory:"Please select a category first",contentRequired:"Content is required",contentTooLong:"Content exceeds maximum length of {0} characters",contentExceedsMax:"Content exceeds maximum length",maxFilesExceeded:"Maximum {0} files allowed per post",fileSizeExceeded:'File "{0}" exceeds maximum file size of {1}MB',failedToLoadSettings:"Failed to load settings: {0}",failedToSaveSettings:"Failed to save settings: {0}",failedToDeleteCategory:"Failed to delete category: {0}",failedToDeletePost:"Failed to delete post: {0}",selectCategoryToMove:"Please select a category to move the post to."},validation:{fileSizeValidation:"Maximum file size must be between {0}MB and {1}MB ({2}GB)",contentLengthValidation:"Maximum content length must be between {0} and {1} characters",filesPerPostValidation:"Maximum files per post must be between {0} and {1}"},info:{savingSettings:"Saving settings...",settingsResetInfo:"Settings reset to defaults (not saved yet). Storage path is not changed as it requires server restart.",resetSettingsConfirm:"Are you sure you want to reset all settings to their default values?",loadingMorePosts:"Loading more posts...",noActivityData:"No activity data available"},confirm:{unsavedContent:"You have unsaved content. Are you sure you want to close?",deleteCategory:"Are you sure you want to delete",undoWarning:`

This action cannot be undone.`},fileUpload:{dragDropText:"Or drag and drop files here (max {0} files)"}},UI_CONFIG={defaultPostLimit:20,maxPostLimit:100,defaultOffset:0,virtualScrollBuffer:5,defaultItemHeight:200,postsVirtualScrollHeight:250,heatmapSquaresPerRow:10,currentActivityPeriod:0,defaultPostsPerPage:20,infiniteScrollThreshold:1e3,virtualScrollThreshold:50,categoryBatchLimit:100,maxFilenameDisplay:200,maxUrlDisplayLength:30,defaultImageIndex:0,debounceDelay:500,successMessageDelay:1500,scrollThreshold:50,settingsTransitionDelay:100,fileSizeUnit:1024,minutesInMs:60*1e3,hoursInMs:60*60*1e3,daysInMs:24*60*60*1e3,weekInDays:7},ACTIVITY_LEVELS={none:0,low:1,medium:2,high:3,veryHigh:4},ACTIVITY_THRESHOLDS={low:1,medium:3,high:5},ACTIVITY_CLASSES=["bg-gray-100","bg-green-200","bg-green-300","bg-green-400","bg-green-500"],ACTIVITY_CLASSES_DARK=["dark:bg-gray-700","dark:bg-[#0e4429]","dark:bg-[#006d32]","dark:bg-[#26a641]","dark:bg-[#39d353]"],UI_TEXT={post:"post",posts:"posts",day:"day",days:"days",on:"on",less:"Less",more:"More",all:"All",categories:"Categories",allCategories:"All Categories",settings:"Settings",now:"now",ago:"ago",minutesAgo:"m ago",hoursAgo:"h ago",daysAgo:"d ago",bytes:"Bytes",kb:"KB",mb:"MB",gb:"GB",zeroBytes:"0 Bytes",save:"Save",cancel:"Cancel",delete:"Delete",edit:"Edit",create:"Create",update:"Update",loading:"Loading",error:"Error",failed:"Failed",success:"Success",next:"Next",previous:"Previous",file:"file",files:"files",upload:"Upload",download:"Download",content:"Content",attachments:"Attachments",createNewPost:"Create New Post",fileUploadSettings:"File Upload Settings",contentSettings:"Content Settings",performanceSettings:"Performance Settings",activityTracking:"Activity Tracking",fileStatistics:"Category Detailed",noPostsYet:"No posts yet. Create your first post!",noCategoriesYet:"No categories yet. Create your first category!",noFilesSelected:"No files selected",chooseFiles:"Choose Files",ellipsis:"...",colon:":",dash:"-"},MIN_RETROACTIVE_POST_TIMESTAMP=9466848e5,LOCALE_SETTINGS={default:"en-US"},DATE_FORMAT={monthStyle:"short",timezone:"UTC",format12h:"MM/DD/YYYY HH:MM AM/PM",format24h:"DD/MM/YYYY HH:MM"},TIME_FORMAT={am:"AM",pm:"PM"},STORAGE_KEYS={lastCategory:"lastSelectedCategory",expandedCategories:"expandedCategories",recursiveStates:"recursiveToggleStates",categorySortPref:"categorySortPreference"},FILE_EXTENSIONS={code:[".js",".py",".java",".cpp",".c",".cs",".php",".rb",".go",".rs",".ts",".jsx",".tsx",".vue",".swift",".kt",".scala",".sh",".bat",".ps1",".r",".m",".h",".hpp",".css",".scss",".sass",".less",".html",".xml",".json",".yaml",".yml",".toml",".ini",".cfg",".conf",".sql"],archive:[".zip",".rar",".7z",".tar",".gz",".bz2",".xz",".tgz"],document:[".pdf",".doc",".docx",".xls",".xlsx",".ppt",".pptx",".txt",".rtf",".odt",".ods",".odp"],image:[".jpg",".jpeg",".png",".gif",".webp",".bmp",".svg",".ico",".tiff",".tif"],video:[".mp4",".webm",".avi",".mov",".mkv",".flv",".wmv",".m4v"],audio:[".mp3",".wav",".ogg",".m4a",".flac",".aac",".wma"]},DEFAULT_ALLOWED_EXTENSIONS="jpg, jpeg, png, gif, webp, pdf, doc, docx, xls, xlsx, txt, zip, mp4, mov, avi",FILE_LANGUAGE_MAP={js:"JavaScript",py:"Python",java:"Java",cpp:"C++",c:"C",cs:"C#",go:"Go",rs:"Rust"},VIDEO_FORMAT_MAP={mp4:"MP4",webm:"WEBM",avi:"AVI",mov:"MOV",mkv:"MKV",flv:"FLV",wmv:"WMV",m4v:"M4V"},AUDIO_FORMAT_MAP={mp3:"MP3",wav:"WAV",ogg:"OGG",m4a:"M4A",flac:"FLAC",aac:"AAC",wma:"WMA"},FILE_ICON_MAP={code:{extensions:["js","ts","jsx","tsx","vue","react","html","htm","xml","py","python","c","cpp","cc","h","hpp","cs","csharp","php","go","rs","rust","swift","kt","kotlin","dart","m","mm","scala","clj","clojure","hs","haskell","lua","perl","pl"],icon:"fa-code"},palette:{extensions:["css","scss","sass","less"],icon:"fa-palette"},coffee:{extensions:["java","jar"],icon:"fa-coffee"},gem:{extensions:["rb","ruby"],icon:"fa-gem"},chartLine:{extensions:["r"],icon:"fa-chart-line"},terminal:{extensions:["sh","bash","zsh","fish","bat","cmd","ps1","powershell"],icon:"fa-terminal"},pdf:{extensions:["pdf"],icon:"fa-file-pdf"},word:{extensions:["doc","docx"],icon:"fa-file-word"},excel:{extensions:["xls","xlsx"],icon:"fa-file-excel"},powerpoint:{extensions:["ppt","pptx"],icon:"fa-file-powerpoint"},text:{extensions:["txt","text","rtf","odt","ods","odp","md","markdown","rst"],icon:"fa-file-alt"},image:{extensions:["jpg","jpeg","png","gif","bmp","svg","webp","ico","tiff","tif"],icon:"fa-image"},audio:{extensions:["mp3","wav","flac","aac","ogg","wma","m4a"],icon:"fa-file-audio"},video:{extensions:["mp4","avi","mkv","mov","wmv","flv","webm","m4v"],icon:"fa-file-video"},archive:{extensions:["zip","rar","7z","tar","gz","bz2","xz"],icon:"fa-file-archive"},config:{extensions:["json","xml","yaml","yml","toml","ini","cfg","conf"],icon:"fa-cog"},table:{extensions:["csv","tsv"],icon:"fa-table"},database:{extensions:["sql","db","sqlite"],icon:"fa-database"}};window.AppConstants={APP_NAME,APP_TAGLINE,APP_DESCRIPTION,RESERVED_ROUTES,ALL_CATEGORIES_ID,MAX_CATEGORY_DEPTH,DEFAULT_SETTINGS,VALIDATION_LIMITS,ERROR_MESSAGES:USER_MESSAGES.validation,USER_MESSAGES,UI_CONFIG,ACTIVITY_LEVELS,ACTIVITY_THRESHOLDS,ACTIVITY_CLASSES,ACTIVITY_CLASSES_DARK,UI_TEXT,LOCALE_SETTINGS,DATE_FORMAT,TIME_FORMAT,STORAGE_KEYS,FILE_EXTENSIONS,DEFAULT_ALLOWED_EXTENSIONS,FILE_LANGUAGE_MAP,VIDEO_FORMAT_MAP,AUDIO_FORMAT_MAP,FILE_ICON_MAP,MIN_RETROACTIVE_POST_TIMESTAMP};class Router{constructor(){this.routes=new Map,this.currentRoute=null,this.currentCategoryPath=null,window.addEventListener("popstate",e=>{this.handleRoute(window.location.pathname,!1)})}addRoute(e,t){this.routes.set(e,t)}navigate(e,t=!0){t&&window.history.pushState({},"",e),this.handleRoute(e,!1)}handleRoute(e){const n=e==="/"?"/":e.replace(/\/$/,"");if(this.routes.has(n)){this.currentRoute=n,this.currentCategoryPath=null;const e=this.routes.get(n);e()}else this.isCategoryPath(n)?(this.currentRoute="category",this.currentCategoryPath=n,this.handleCategoryRoute(n)):(this.currentRoute="/",this.currentCategoryPath=null,this.routes.has("/")&&this.routes.get("/")())}init(){if(this.isCategoryPath(window.location.pathname))return;this.handleRoute(window.location.pathname,!1)}getCurrentRoute(){return this.currentRoute}getCurrentCategoryPath(){return this.currentCategoryPath}isCategoryPath(e){if(e==="/")return!1;for(const t of window.AppConstants.RESERVED_ROUTES)if(e==="/"+t)return!1;return/^\/[a-zA-Z0-9\s/%]+$/.test(e)&&!e.includes("//")}async handleCategoryRoute(e){if(typeof categories=="undefined"||!categories||categories.length===0){setTimeout(()=>this.handleCategoryRoute(e),100);return}const t=this.findCategoryByPath(e);t?await this.showCategoryPage(t):this.navigate("/",!0)}findCategoryByPath(e){const n=e.split("/").filter(e=>e.length>0);if(n.length===0)return null;let t=null,s=categories.filter(e=>!e.parent_id);for(let e=0;e<n.length;e++){const o=n[e],i=decodeURIComponent(o);if(t=s.find(e=>e.name.toLowerCase()===i.toLowerCase()),!t)return null;s=categories.filter(e=>e.parent_id===t.id)}return t}buildCategoryPath(e){const n=[];let t=e;for(;t;)n.unshift(encodeURIComponent(t.name)),t.parent_id?t=categories.find(e=>e.id===t.parent_id):t=null;return"/"+n.join("/")}async showCategoryPage(e){const t=document.querySelector(".container"),n=document.getElementById("settings-page");t&&(t.style.display="block"),n&&n.classList.add("hidden"),typeof selectCategory=="function"&&selectCategory(e,!1);const s=await loadAppSettings(),o=s?.siteTitle||window.AppConstants.APP_NAME;if(e&&e.id){const t=typeof getCategoryBreadcrumb=="function"?getCategoryBreadcrumb(e.id):e.name;document.title=`${t}`}}navigateToCategory(e){if(!e){this.navigate("/");return}const t=this.buildCategoryPath(e);this.navigate(t)}checkCachedCategoryRedirect(){if(window.location.pathname!=="/")return!1;const e=localStorage.getItem(window.AppConstants.STORAGE_KEYS.lastCategory);if(e&&categories&&categories.length>0){const t=categories.find(t=>t.id===parseInt(e));if(t){const e=this.buildCategoryPath(t);return this.navigate(e,!0),!0}}return!1}}const router=new Router;async function showHomePage(){const e=document.querySelector(".container"),t=document.getElementById("settings-page");e&&(e.style.display="block"),t&&t.classList.add("hidden");const n=await loadAppSettings(),s=n?.siteTitle||window.AppConstants.APP_NAME;document.title=`${s}`,typeof currentCategory!="undefined"&&currentCategory&&currentCategory.id!==window.AppConstants?.ALL_CATEGORIES_ID&&typeof deselectCategory=="function"&&deselectCategory()}async function showSettingsPage(){const e=document.querySelector(".container"),t=document.getElementById("settings-page");e&&(e.style.display="none"),t&&t.classList.remove("hidden");try{typeof loadSettings=="function"&&await loadSettings(),typeof populateSettingsForm=="function"&&populateSettingsForm();const e=await loadAppSettings(),t=e?.siteTitle||window.AppConstants.APP_NAME;document.title=`${t} - Settings`}catch(e){console.error("Failed to load settings:",e),typeof showError=="function"&&showError(formatMessage(window.AppConstants.USER_MESSAGES.error.failedToLoadSettings,e.message))}}router.addRoute("/",showHomePage),router.addRoute("/settings",showSettingsPage),document.addEventListener("DOMContentLoaded",function(){router.init()}),window.router=router;let currentCategory=null,categories=[],expandedCategories=new Set,selectedFiles=new Map,fileCounter=0,modalSelectedFiles=new Map,modalFileCounter=0,currentImageGallery=[],currentImageIndex=window.AppConstants.UI_CONFIG.defaultImageIndex,categoryStats={},globalStats={totalPosts:0,totalFiles:0,totalSize:0},categoryActivity={},currentActivityPeriod=window.AppConstants.UI_CONFIG.currentActivityPeriod,activityEnabled=!0,fileStatsEnabled=!0;function saveLastCategory(e){localStorage.setItem(window.AppConstants.STORAGE_KEYS.lastCategory,e)}function getLastCategory(){return localStorage.getItem(window.AppConstants.STORAGE_KEYS.lastCategory)}function saveExpandedCategories(){localStorage.setItem(window.AppConstants.STORAGE_KEYS.expandedCategories,JSON.stringify([...expandedCategories]))}function loadExpandedCategories(){const e=localStorage.getItem(window.AppConstants.STORAGE_KEYS.expandedCategories);e&&(expandedCategories=new Set(JSON.parse(e)))}async function checkActivityEnabled(){try{const e=window.currentSettings||await loadAppSettings();activityEnabled=e.activityEnabled!==0[0]?e.activityEnabled:window.AppConstants.DEFAULT_SETTINGS.activityEnabled}catch(e){console.warn("Failed to check activity status, using default:",e),activityEnabled=window.AppConstants.DEFAULT_SETTINGS.activityEnabled}updateActivityVisibility()}async function checkFileStatsEnabled(){try{const e=window.currentSettings||await loadAppSettings();fileStatsEnabled=e.fileStatsEnabled!==0[0]?e.fileStatsEnabled:window.AppConstants.DEFAULT_SETTINGS.fileStatsEnabled}catch(e){console.warn("Failed to check file stats status, using default:",e),fileStatsEnabled=window.AppConstants.DEFAULT_SETTINGS.fileStatsEnabled}}function updateActivityVisibility(){const e=document.getElementById("activity-container");e&&(activityEnabled?e.style.display="":e.style.display="none")}function formatMessage(t,...e){return t.replace(/{(\d+)}/g,(t,n)=>typeof e[n]!="undefined"?e[n]:t)}function escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function formatFileSize(e){if(e===0)return window.AppConstants.UI_TEXT.zeroBytes;const t=window.AppConstants.UI_CONFIG.fileSizeUnit,s=[window.AppConstants.UI_TEXT.bytes,window.AppConstants.UI_TEXT.kb,window.AppConstants.UI_TEXT.mb,window.AppConstants.UI_TEXT.gb],n=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/t**n).toFixed(2))+" "+s[n]}function formatRelativeDate(e){const t=new Date(e),i=new Date,n=i-t,s=Math.floor(n/window.AppConstants.UI_CONFIG.daysInMs),a=Math.floor(n/window.AppConstants.UI_CONFIG.hoursInMs),o=Math.floor(n/window.AppConstants.UI_CONFIG.minutesInMs);return o<1?"now":o<60?`${o}m`:a<24?`${a}h`:s<7?s===1?"1d":`${s}d`:t.getFullYear()===i.getFullYear()?t.toLocaleDateString(window.AppConstants.LOCALE_SETTINGS.default,{month:"short",day:"numeric"}):t.toLocaleDateString(window.AppConstants.LOCALE_SETTINGS.default,{month:"short",day:"numeric",year:"numeric"})}function formatFullDateTime(e){const t=new Date(e),n=t.toLocaleTimeString(window.AppConstants.LOCALE_SETTINGS.default),s=!n.match(/AM|PM/i),o=s?{hour:"2-digit",minute:"2-digit",hour12:!1}:{hour:"numeric",minute:"2-digit",hour12:!0},i={month:"short",day:"numeric",year:"numeric"},a=t.toLocaleTimeString(window.AppConstants.LOCALE_SETTINGS.default,o),r=t.toLocaleDateString(window.AppConstants.LOCALE_SETTINGS.default,i);return`${a} - ${r}`}function formatDateTimeMMDDYY(e){const t=new Date(e),n=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getDate()).padStart(2,"0"),o=String(t.getFullYear()).slice(-2),i=String(t.getHours()).padStart(2,"0"),a=String(t.getMinutes()).padStart(2,"0"),r=String(t.getSeconds()).padStart(2,"0");return`${n}/${s}/${o} ${i}:${a}:${r}`}function parseDateTime12h(e){try{const n=e.trim().split(" ");if(n.length!==3)return null;const s=n[0].split("/");if(s.length!==3)return null;const o=n[1].split(":");if(o.length!==2)return null;const a=parseInt(s[0],10)-1,r=parseInt(s[1],10),c=parseInt(s[2],10);let t=parseInt(o[0],10);const l=parseInt(o[1],10),i=n[2].toUpperCase();return i===window.AppConstants.TIME_FORMAT.pm&&t!==12?t+=12:i===window.AppConstants.TIME_FORMAT.am&&t===12&&(t=0),new Date(c,a,r,t,l)}catch{return null}}function parseDateTime24h(e){try{const n=e.trim().split(" ");if(n.length!==2)return null;const t=n[0].split("/");if(t.length!==3)return null;const s=n[1].split(":");if(s.length!==2)return null;const o=parseInt(t[0],10),i=parseInt(t[1],10)-1,a=parseInt(t[2],10),r=parseInt(s[0],10),c=parseInt(s[1],10);return new Date(a,i,o,r,c)}catch{return null}}function showError(e){window.showError&&window.showError!==showError?window.showError(e):alert(e)}function showConfirmation(e,t,n=null){return new Promise(s=>{const a=document.getElementById("confirmation-modal"),h=document.getElementById("confirmation-title"),m=document.getElementById("confirmation-message"),o=document.getElementById("confirmation-details"),r=document.getElementById("confirmation-confirm"),c=document.getElementById("confirmation-cancel");h.textContent=e;const f=t.replace(/\*\*(.*?)\*\*/g,'<strong class="font-bold text-black">$1</strong>');m.innerHTML=f.replace(/\n/g,"<br>"),n?(o.innerHTML=n,o.style.display="block"):(o.innerHTML="",o.style.display="none"),a.classList.remove("hidden"),document.body.style.overflow="hidden";const l=()=>{i(),s(!0)},d=()=>{i(),s(!1)},u=e=>{e.key==="Escape"&&(i(),s(!1))},i=()=>{a.classList.add("hidden"),document.body.style.overflow="",r.removeEventListener("click",l),c.removeEventListener("click",d),document.removeEventListener("keydown",u)};r.addEventListener("click",l),c.addEventListener("click",d),document.addEventListener("keydown",u)})}function shortenUrl(e,t=window.AppConstants.UI_CONFIG.maxUrlDisplayLength){try{const n=new URL(e);let s=n.hostname;if(n.port&&!(n.protocol==="http:"&&n.port==="80"||n.protocol==="https:"&&n.port==="443")&&(s+=":"+n.port),n.pathname!=="/"&&s.length<t-5){const e=n.pathname.substring(0,t-s.length-3);s+=e,n.pathname.length>e.length&&(s+="...")}return s.length>t&&(s=s.substring(0,t-3)+"..."),s}catch{return e.length>t?e.substring(0,t-3)+window.AppConstants.UI_TEXT.ellipsis:e}}function formatTextWithUrls(e){const t=[];let n=e;const o=/(https?:\/\/[^\s<>"]+)/g;n=n.replace(o,e=>{const n=`__URL_PLACEHOLDER_${t.length}__`,s=shortenUrl(e);return t.push(`<a href="${escapeHtml(e)}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 font-semibold hover:underline transition-colors">${escapeHtml(s)}</a>`),n});const i=/\b([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})\b/g;n=n.replace(i,e=>{const n=`__URL_PLACEHOLDER_${t.length}__`;return t.push(`<a href="mailto:${escapeHtml(e)}" class="text-blue-600 hover:text-blue-800 font-semibold hover:underline transition-colors">${escapeHtml(e)}</a>`),n});const a=/\b(?<![@/])(?:www\.)?([a-zA-Z0-9][-a-zA-Z0-9]{0,62}\.)+[a-zA-Z]{2,}\b(?!["\s]*@)/g;n=n.replace(a,e=>{const n=`__URL_PLACEHOLDER_${t.length}__`,s=e.startsWith("www.")?`https://${e}`:`https://${e}`;return t.push(`<a href="${escapeHtml(s)}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 font-semibold hover:underline transition-colors">${escapeHtml(e)}</a>`),n});let s=escapeHtml(n);return t.forEach((e,t)=>{s=s.replace(`__URL_PLACEHOLDER_${t}__`,e)}),s}function getFileIcon(e){const t=e.toLowerCase();for(const e of Object.values(window.AppConstants.FILE_ICON_MAP))if(e.extensions.includes(t))return e.icon;return"fa-file"}class DropdownAlert{constructor(){this.timeout=null,this.isActive=!1,this.container=null,this.initializeContainer()}initializeContainer(){this.container=document.createElement("div"),this.container.className="alert-container",this.container.innerHTML=`
            <div class="alert-dropdown">
                <span class="alert-text"></span>
            </div>
        `,document.body.appendChild(this.container),this.addStyles()}addStyles(){}show(e,t="success"){return new Promise(n=>{this.clearTimeout(),this.isActive?this.hideImmediate().then(()=>{setTimeout(()=>this.displayMessage(e,t,n),50)}):this.displayMessage(e,t,n)})}displayMessage(e,t,n){const s=this.container.querySelector(".alert-dropdown"),o=s.querySelector(".alert-text");s.className="alert-dropdown",s.classList.add(t),o.textContent=e,this.isActive=!0,s.offsetHeight,requestAnimationFrame(()=>{s.classList.add("show");const e=t==="success"?2e3:4e3;this.timeout=setTimeout(()=>{this.hide().then(n)},e)})}hide(){return new Promise(e=>{if(!this.isActive){e();return}const t=this.container.querySelector(".alert-dropdown");t.classList.remove("show"),t.classList.add("hide"),setTimeout(()=>{this.isActive=!1,t.classList.remove("hide"),e()},250)})}hideImmediate(){return new Promise(e=>{if(!this.isActive){e();return}const t=this.container.querySelector(".alert-dropdown");t.classList.remove("show"),t.classList.add("hide"),setTimeout(()=>{this.isActive=!1,t.classList.remove("hide"),e()},100)})}clearTimeout(){this.timeout&&(clearTimeout(this.timeout),this.timeout=null)}}window.alertSystem=new DropdownAlert,window.showSuccess=e=>window.alertSystem.show(e,"success"),window.showError=e=>window.alertSystem.show(e,"error"),window.showWarning=e=>window.alertSystem.show(e,"warning"),window.showInfo=e=>window.alertSystem.show(e,"info");let appSettings=null,settingsPromise=null;async function loadAppSettings(e=!1){if(appSettings&&!e)return appSettings;if(settingsPromise&&!e)return await settingsPromise;settingsPromise=loadSettingsInternal();try{return appSettings=await settingsPromise,appSettings}finally{settingsPromise=null}}async function loadSettingsInternal(){try{const e=await fetch("/api/settings");return e.ok?await e.json():{...window.AppConstants.DEFAULT_SETTINGS}}catch(e){return console.error("Failed to load settings, using defaults:",e),{...window.AppConstants.DEFAULT_SETTINGS}}}async function initializeAppSettings(){return appSettings||(appSettings=await loadAppSettings()),appSettings}function clearSettingsCache(){appSettings=null,settingsPromise=null}async function apiRequest(e,t={}){const n=await fetch(`/api${e}`,{headers:{"Content-Type":"application/json",...t.headers},...t});if(!n.ok){const e=await n.text();throw new Error(e)}const s=await n.text();if(!s||s.trim()==="")return null;try{const e=JSON.parse(s);return e||null}catch(e){return console.error("Failed to parse JSON response:",e),null}}async function fetchCategories(e=!1){try{if(categories=await apiRequest("/categories"),(!categories||!Array.isArray(categories))&&(categories=[]),cleanupRecursiveToggleStates(),e||(renderCategories(),populateCategorySelect()),typeof router!="undefined")window.location.pathname!=="/"&&router.isCategoryPath&&router.isCategoryPath(window.location.pathname)?router.handleRoute(window.location.pathname,!1):router.checkCachedCategoryRedirect&&(router.checkCachedCategoryRedirect()||await deselectCategory());else{const e=getLastCategory();if(e){const t=categories.find(t=>t.id==e);t?selectCategory(t):await deselectCategory()}else await deselectCategory()}}catch(e){console.error("Failed to fetch categories:",e),categories=[],renderCategories(),populateCategorySelect()}}async function createCategory(e,t,n=""){try{const o=t?parseInt(t):null,s=await apiRequest("/categories",{method:"POST",body:JSON.stringify({name:e,description:n,parent_id:o})});return s&&Array.isArray(categories)&&(categories.push(s),cleanupRecursiveToggleStates()),s}catch(e){throw console.error("Failed to create category:",e),e}}async function updateCategory(e,t,n,s){try{const i=s?parseInt(s):null,o=await apiRequest(`/categories/${e}`,{method:"PUT",body:JSON.stringify({name:t,description:n,parent_id:i})});if(o&&Array.isArray(categories)){const t=categories.findIndex(t=>t.id===e);t!==-1&&(categories[t]=o),cleanupRecursiveToggleStates()}return o}catch(e){throw console.error("Failed to update category:",e),e}}async function fetchPosts(e,t=window.AppConstants.UI_CONFIG.defaultPostLimit,n=window.AppConstants.UI_CONFIG.defaultOffset,s=!1,o=!1){try{const i=new URLSearchParams({limit:t.toString(),offset:n.toString()});s&&i.set("with_meta","true"),o&&i.set("recursive","true");const a=await apiRequest(`/categories/${e}/posts?${i.toString()}`);return a||{posts:[],has_more:!1}}catch(e){return console.error("Failed to fetch posts:",e),{posts:[],has_more:!1}}}async function fetchCategoryStats(e,t=!1){try{const s=await loadAppSettings();if(!s.fileStatsEnabled)return{file_count:0,total_size:0,last_updated:0};const o=new URLSearchParams({recursive:t.toString()}),n=await apiRequest(`/category-stats/${e}?${o.toString()}`);return{file_count:n.file_count||0,total_size:n.total_size||0,last_updated:n.last_updated||0}}catch(e){return console.error("Failed to fetch category stats:",e),{file_count:0,total_size:0,last_updated:0}}}async function createPost(e,t,n={}){try{const s={category_id:e,content:t};return n.linkPreviews&&n.linkPreviews.length>0&&(s.link_previews=n.linkPreviews),n.customTimestamp&&(s.custom_timestamp=n.customTimestamp),await apiRequest("/posts",{method:"POST",body:JSON.stringify(s)})}catch(e){throw console.error("Failed to create post:",e),e}}async function deletePost(e){try{await apiRequest(`/posts/${e}`,{method:"DELETE"})}catch(e){throw console.error("Failed to delete post:",e),e}}async function movePost(e,t){try{return await apiRequest(`/posts/${e}/move`,{method:"PUT",body:JSON.stringify({category_id:t})})}catch(e){throw console.error("Failed to move post:",e),e}}async function deleteCategoryApi(e){try{await apiRequest(`/categories/${e}`,{method:"DELETE"})}catch(e){throw console.error("Failed to delete category:",e),e}}async function uploadFile(e,t){try{const n=new FormData;n.append("post_id",e),n.append("file",t);const s=await fetch("/api/upload",{method:"POST",body:n});if(!s.ok)throw new Error(await s.text());return s.json()}catch(e){throw console.error("Failed to load file:",e),e}}async function fetchActivityData(e,t,n){try{const o=window.currentSettings||await loadAppSettings(),i=o.activityPeriodMonths||4,a=new URLSearchParams({recursive:t.toString(),period:n.toString(),period_months:i.toString()}),s=await fetch(`/api/activity/${e}?${a}`,{headers:{"Content-Type":"application/json"}});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);return await s.json()}catch(e){throw console.error("Failed to fetch activity data:",e),e}}async function fetchLinkPreview(e){try{const t=await fetch("/api/link-preview",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:e})});if(!t.ok){const e=await t.text();throw new Error(e)}return t.json().catch(()=>({}))}catch(e){throw console.error("Failed to fetch link preview:",e),e}}async function saveSettings(e){try{const t=await fetch("/api/settings",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){const e=await t.text();throw new Error(e||`HTTP error! status: ${t.status}`)}const n=await t.json();return clearSettingsCache(),n}catch(e){throw console.error("Failed to save settings:",e),e}}let currentActivityCache=null,isGeneratingActivity=!1;async function generateActivityHeatmap(){if(isGeneratingActivity)return;if(!activityEnabled||!currentCategory){document.getElementById("activity-container").style.display="none";return}isGeneratingActivity=!0;const e=document.getElementById("activity-container");e.style.display="",e.innerHTML=`
        <div class="text-center text-gray-500 dark:text-gray-400 py-16">
            <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
            <p>Loading activity...</p>
        </div>
    `;try{const e=await fetchActivityPeriod(currentCategory.id,currentCategory.recursiveMode||!1,currentActivityPeriod);if(!e){document.getElementById("activity-container").style.display="none";return}document.getElementById("activity-container").style.display="",currentActivityCache=e,generateHeatmapFromCache(e)}catch(n){console.error("Failed to generate activity heatmap:",n);const s=window.currentSettings||await loadAppSettings(),o=s.activityPeriodMonths||4,i=o*30,e=new Date,a=e.toISOString().split("T")[0],r=new Date(e.getTime()-i*24*60*60*1e3).toISOString().split("T")[0],t={days:[],start_date:r,end_date:a,stats:{total_posts:0,active_days:0,max_day_activity:0},max_periods:0};currentActivityCache=t,generateHeatmapFromCache(t)}finally{isGeneratingActivity=!1}}async function fetchActivityPeriod(e,t=!1,n=0){return await fetchActivityData(e,t,n)}function updateActivityCategoryBreadcrumb(){const t=document.getElementById("activity-category-breadcrumb");if(!t)return;if(!currentCategory||currentCategory.id===window.AppConstants.ALL_CATEGORIES_ID){t.innerHTML=`<span class="text-xs font-semibold text-gray-700 dark:text-gray-300">${window.AppConstants.UI_TEXT.allCategories}</span>`;return}const n=[];let e=currentCategory;for(;e;)n.unshift(e),e.parent_id&&categories?e=categories.find(t=>t.id===e.parent_id):e=null;const s=n.map((e,t)=>{const s=t===n.length-1;return s?`<span class="text-xs font-semibold text-gray-700 dark:text-gray-300">${e.name}</span>`:`<span class="text-xs font-medium text-gray-600 dark:text-gray-400">${e.name}</span>`}).join(' <span class="text-gray-400 dark:text-gray-500 mx-1">></span> ');t.innerHTML=s}function generateHeatmapFromCache(e){const t=document.getElementById("activity-container");t.querySelector("#activity-category-breadcrumb")||(t.innerHTML=`
            <!-- Category Breadcrumb -->
            <div id="activity-category-breadcrumb" class="mb-4">
                <!-- Breadcrumb will be generated dynamically -->
            </div>
            <div class="flex items-center justify-center mb-4">
                <button id="activity-prev" class="p-1 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 disabled:opacity-30 mr-3" onclick="changeActivityPeriod(-1)">
                    <i class="fas fa-chevron-left text-xs"></i>
                </button>
                <span id="activity-period" class="text-sm text-gray-600 dark:text-gray-400"></span>
                <button id="activity-next" class="p-1 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 disabled:opacity-30 ml-3" onclick="changeActivityPeriod(1)">
                    <i class="fas fa-chevron-right text-xs"></i>
                </button>
            </div>
            <div class="relative mb-6">
                <div class="flex justify-center">
                    <div id="activity-heatmap" class="min-h-16">
                        <!-- Heatmap will be generated here -->
                    </div>
                </div>
            </div>
            <div class="flex items-center justify-between text-xs mt-6">
                <div id="activity-legend" class="flex flex-col space-y-1">
                    <!-- Legend will be generated dynamically -->
                </div>
                <span id="activity-summary" class="text-gray-500 dark:text-gray-400"></span>
            </div>
        `),updateActivityCategoryBreadcrumb();const n={};e.days&&Array.isArray(e.days)&&e.days.forEach(e=>{n[e.date]=e.count});const r=currentActivityPeriod===0?`${e.start_date} - ${e.end_date}`:`${e.start_date} - ${e.end_date}`;document.getElementById("activity-period").textContent=formatPeriodLabel(e.start_date,e.end_date,currentActivityPeriod);const s=generateCalendarDays(e.start_date,e.end_date,n);renderHeatmapGrid(s,e.start_date,e.end_date);const o=e.stats.total_posts===1?window.AppConstants.UI_TEXT.post:window.AppConstants.UI_TEXT.posts,i=e.stats.active_days===1?window.AppConstants.UI_TEXT.day:window.AppConstants.UI_TEXT.days;document.getElementById("activity-summary").textContent=`${e.stats.total_posts} ${o} ${window.AppConstants.UI_TEXT.on} ${e.stats.active_days} ${i}`,document.getElementById("activity-next").disabled=currentActivityPeriod>=0;const a=e.max_periods!==0[0]?e.max_periods:24;document.getElementById("activity-prev").disabled=currentActivityPeriod<=-a,updateActivityLegend(),addHeatmapTooltips()}function generateCalendarDays(e,t,n){const o=[];if(!e||!t)return o;const s=new Date(e+"T00:00:00Z"),i=new Date(t+"T00:00:00Z");if(isNaN(s.getTime())||isNaN(i.getTime()))return o;for(;s<=i;){const e=s.toISOString().split("T")[0],t=n[e]||0,i=getIntensityLevel(t);o.push({date:e,count:t,intensity:i,month:s.getUTCMonth(),day:s.getUTCDate()}),s.setUTCDate(s.getUTCDate()+1)}return o}function renderHeatmapGrid(e,t,n){const i=window.AppConstants.UI_CONFIG.heatmapSquaresPerRow,u=Math.ceil(e.length/i);if(e.length===0){document.getElementById("activity-heatmap").innerHTML='<div class="text-center text-gray-500 dark:text-gray-400 py-4"><p>${window.AppConstants.USER_MESSAGES.info.noActivityData}</p></div>';return}const h=[];if(!t||!n){document.getElementById("activity-heatmap").innerHTML='<div class="text-center text-gray-500 dark:text-gray-400 py-4"><p>${window.AppConstants.USER_MESSAGES.info.noActivityData}</p></div>';return}const a=new Date(t+"T00:00:00Z"),r=new Date(n+"T00:00:00Z");if(isNaN(a.getTime())||isNaN(r.getTime())){document.getElementById("activity-heatmap").innerHTML='<div class="text-center text-gray-500 dark:text-gray-400 py-4"><p>${window.AppConstants.USER_MESSAGES.info.noActivityData}</p></div>';return}const c=new Set,o=new Date(a);for(;o<=r;){const e=o.toLocaleDateString(window.AppConstants.LOCALE_SETTINGS.default,{month:window.AppConstants.DATE_FORMAT.monthStyle,timeZone:window.AppConstants.DATE_FORMAT.timezone});c.add(e),o.setUTCMonth(o.getUTCMonth()+1),o.setUTCDate(1)}const l=Array.from(c);let s='<div class="space-y-1">';const d=Math.round(30/window.AppConstants.UI_CONFIG.heatmapSquaresPerRow);for(let t=0;t<u;t++){const o=t*i,a=Math.min(o+i,e.length);let n="";if(t%d===0){const e=Math.floor(t/d);e<l.length&&(n=l[e])}s+='<div class="flex items-center relative">',n&&(s+=`<div class="absolute -left-10 w-8 text-xs text-gray-400 dark:text-gray-500 text-right">${n}</div>`),s+='<div class="flex gap-1">';for(let t=o;t<a;t++)if(t<e.length){const n=e[t],o=getColorClass(n.intensity),i=new Date(n.date+"T00:00:00Z").toLocaleDateString(window.AppConstants.LOCALE_SETTINGS.default,{weekday:"long",month:"long",day:"numeric",year:"numeric",timeZone:"UTC"});s+=`<div class="heatmap-square ${o} rounded-sm cursor-pointer heatmap-cell hover:ring-1 hover:ring-gray-300 dark:hover:ring-gray-600 transition-all"
                             data-date="${n.date}"
                             data-count="${n.count}"
                             data-day="${i}">
                         </div>`}s+="</div></div>"}s+="</div>",document.getElementById("activity-heatmap").innerHTML=s}function updateActivityLegend(){const e=document.getElementById("activity-legend");if(!e)return;const t=window.AppConstants.ACTIVITY_CLASSES[1],n=window.AppConstants.ACTIVITY_CLASSES_DARK[1],s=window.AppConstants.ACTIVITY_CLASSES[window.AppConstants.ACTIVITY_CLASSES.length-1],o=window.AppConstants.ACTIVITY_CLASSES_DARK[window.AppConstants.ACTIVITY_CLASSES_DARK.length-1];e.innerHTML=`
        <div class="flex items-center space-x-2">
            <div class="w-2 h-2 ${t} ${n} rounded-sm"></div>
            <span class="text-gray-400 dark:text-gray-500">${window.AppConstants.UI_TEXT.less}</span>
        </div>
        <div class="flex items-center space-x-2">
            <div class="w-2 h-2 ${s} ${o} rounded-sm"></div>
            <span class="text-gray-400 dark:text-gray-500">${window.AppConstants.UI_TEXT.more}</span>
        </div>
    `}function formatPeriodLabel(e,t){if(!e||!t)return"No activity period";const s=new Date(e+"T00:00:00Z"),o=new Date(t+"T00:00:00Z");if(isNaN(s.getTime())||isNaN(o.getTime()))return"No activity period";const i=s.toLocaleDateString(window.AppConstants.LOCALE_SETTINGS.default,{month:"short",year:"numeric",timeZone:"UTC"}),a=o.toLocaleDateString(window.AppConstants.LOCALE_SETTINGS.default,{month:"short",year:"numeric",timeZone:"UTC"});return`${i} – ${a}`}async function changeActivityPeriod(e){const t=currentActivityPeriod+e;if(currentActivityCache){{const e=currentActivityCache.max_periods!==0[0]?currentActivityCache.max_periods:24;if(t>0||t<-e)return}}else if(t>0||t<-24)return;currentActivityPeriod=t;const n=document.getElementById("activity-heatmap");n&&(n.innerHTML=`
            <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p class="text-sm">Loading...</p>
            </div>
        `),await generateActivityHeatmap()}window.changeActivityPeriod=changeActivityPeriod;function getIntensityLevel(e){return e===0?window.AppConstants.ACTIVITY_LEVELS.none:e===window.AppConstants.ACTIVITY_THRESHOLDS.low?window.AppConstants.ACTIVITY_LEVELS.low:e<=window.AppConstants.ACTIVITY_THRESHOLDS.medium?window.AppConstants.ACTIVITY_LEVELS.medium:e<=window.AppConstants.ACTIVITY_THRESHOLDS.high?window.AppConstants.ACTIVITY_LEVELS.high:window.AppConstants.ACTIVITY_LEVELS.veryHigh}function getColorClass(e){const t=window.AppConstants.ACTIVITY_CLASSES[e]||window.AppConstants.ACTIVITY_CLASSES[0],n=window.AppConstants.ACTIVITY_CLASSES_DARK[e]||window.AppConstants.ACTIVITY_CLASSES_DARK[0];return`${t} ${n}`}function addHeatmapTooltips(){const t=document.querySelectorAll(".heatmap-cell");let e=null;t.forEach(t=>{t.addEventListener("mouseenter",t=>{const i=t.target.getAttribute("data-count"),a=t.target.getAttribute("data-day");e=document.createElement("div"),e.className="absolute bg-gray-900 text-white text-xs px-3 py-2 rounded shadow-lg pointer-events-none z-50 max-w-xs";const r=i==="1"?window.AppConstants.UI_TEXT.post:window.AppConstants.UI_TEXT.posts;e.innerHTML=`
                <div class="font-medium">${i} ${r}</div>
                <div class="text-gray-300">${a}</div>
            `,document.body.appendChild(e);const n=t.target.getBoundingClientRect(),s=e.getBoundingClientRect();let o=n.right+10;o+s.width>window.innerWidth&&(o=n.left-s.width-10),e.style.left=`${o}px`,e.style.top=`${n.top+window.scrollY-s.height-5}px`}),t.addEventListener("mouseleave",()=>{e&&(document.body.removeChild(e),e=null)})})}function renderCategories(){const e=document.getElementById("categories-tree");e.innerHTML="";const t=categories.filter(e=>!e.parent_id);if(t.length===0){e.innerHTML=`
            <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                <i class="fas fa-folder-plus text-4xl mb-4"></i>
                <p>${window.AppConstants.UI_TEXT.noCategoriesYet}</p>
            </div>
        `,updateSortFooterVisibility();return}const n=sortCategories(t);n.forEach(t=>{const n=createCategoryElement(t);e.appendChild(n)}),updateSortFooterVisibility()}function createCategoryElement(e,t=0){const o=document.createElement("div");o.className="category-item mb-1";const r=categories.some(t=>t.parent_id===e.id),c=expandedCategories.has(e.id),d=c,n=document.createElement("div");n.className="flex items-center group";let i="";r?i=`
            <button class="expand-btn flex-shrink-0 w-5 h-5 flex items-center justify-center text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-all duration-200 mr-1" style="margin-left: ${t*14}px;">
                <i class="fas fa-chevron-${c?"down":"right"} text-xs"></i>
            </button>
        `:i=`<div class="w-5 h-5 mr-1" style="margin-left: ${t*14}px;"></div>`;const s=document.createElement("button"),a=currentCategory?.id===e.id;s.className=`category-btn flex-1 text-left px-2 py-1.5 rounded-md transition-all duration-200 min-w-0 group-hover:bg-gray-50 dark:group-hover:bg-gray-700 ${a?"bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-400 border-l-2 border-blue-500 dark:border-blue-400 font-medium":"text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-gray-100"}`,s.dataset.categoryId=e.id,s.innerHTML=`
        <div class="flex items-center min-w-0">
            <i class="fas fa-folder${a?"-open":""} mr-2 flex-shrink-0 text-xs ${a?"text-blue-500 dark:text-blue-400":"text-gray-400 dark:text-gray-500"}"></i>
            <span class="text-sm truncate" title="${e.name}">${e.name}</span>
        </div>
    `,n.innerHTML=i,n.appendChild(s),o.appendChild(n);const l=n.querySelector(".expand-btn");if(l&&l.addEventListener("click",t=>{t.stopPropagation(),toggleCategory(e.id)}),s.addEventListener("click",t=>{t.stopPropagation(),currentCategory&&currentCategory.id===e.id?typeof router!="undefined"&&router.navigate?router.navigate("/"):selectCategory(e,!0):typeof router!="undefined"&&router.navigateToCategory?router.navigateToCategory(e):selectCategory(e,!0)}),r&&d){const n=categories.filter(t=>t.parent_id===e.id),s=sortCategories(n);s.forEach(e=>{const n=createCategoryElement(e,t+1);o.appendChild(n)})}return o}function toggleCategory(e){expandedCategories.has(e)?expandedCategories.delete(e):expandedCategories.add(e),saveExpandedCategories(),renderCategories()}function selectCategory(e,t=!1){if(t&&currentCategory&&currentCategory.id===e.id){deselectCategory();return}isLoadingPosts=!1;const n=document.getElementById("posts-container");n&&(n.innerHTML=`
            <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                <p>Loading posts...</p>
            </div>
        `),currentCategory=e,currentCategory.recursiveMode=loadRecursiveToggleState(e.id),saveLastCategory(e.id),document.getElementById("new-post-btn").style.display="block",document.getElementById("settings-btn").style.display="none",document.getElementById("theme-toggle-btn").style.display="none",document.getElementById("category-actions-dropdown").style.display="block",expandCategoryPath(e.id),renderCategories(),scrollToCategoryElement(e.id),updateCategoryStatsDisplay(),loadPosts(e.id,currentCategory.recursiveMode),currentActivityPeriod=0,window.scrollTo(0,0),fileStatsEnabled&&fetchCategoryStats(e.id,currentCategory.recursiveMode).then(e=>{updateCategoryStatsDisplay(e)}).catch(e=>{console.error("Failed to fetch file stats:",e)}),generateActivityHeatmap()}function expandCategoryPath(e){const t=categories.find(t=>t.id===e);if(!t)return;function n(e){if(e.parent_id){const t=categories.find(t=>t.id===e.parent_id);t&&(expandedCategories.add(t.id),n(t))}}n(t),saveExpandedCategories()}function scrollToCategoryElement(e){setTimeout(()=>{const t=document.querySelector(`[data-category-id="${e}"]`);if(t){const e=document.getElementById("categories-tree"),n=e?.closest(".overflow-auto, .overflow-y-auto, .overflow-scroll, .overflow-y-scroll")||e?.parentElement;if(n){const e=n.getBoundingClientRect(),s=t.getBoundingClientRect(),o=s.top<e.top,i=s.bottom>e.bottom;(o||i)&&t.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})}else t.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})}},100)}function deselectCategory(){isLoadingPosts=!1;const e=document.getElementById("posts-container");e&&(e.innerHTML=`
            <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                <p>Loading posts...</p>
            </div>
        `),currentCategory={id:window.AppConstants.ALL_CATEGORIES_ID,name:window.AppConstants.UI_TEXT.allCategories,recursiveMode:!1},localStorage.removeItem(window.AppConstants.STORAGE_KEYS.lastCategory),renderCategories(),document.getElementById("new-post-btn").style.display="none",document.getElementById("settings-btn").style.display="block",document.getElementById("theme-toggle-btn").style.display="block",document.getElementById("category-actions-dropdown").style.display="none",updateAllCategoriesDisplay(),loadPosts(0,!1),currentActivityPeriod=0,window.scrollTo(0,0),fileStatsEnabled&&fetchCategoryStats(0,!1).then(e=>{updateAllCategoriesDisplay(e)}).catch(e=>{console.error("Failed to fetch file stats:",e)}),generateActivityHeatmap()}function toggleRecursiveMode(e){if(!currentCategory||currentCategory.id!==e.id)return;currentCategory.recursiveMode=!currentCategory.recursiveMode,saveRecursiveToggleState(e.id,currentCategory.recursiveMode),window.scrollTo(0,0),renderCategories(),updateCategoryStatsDisplay(),loadPosts(e.id,currentCategory.recursiveMode),fileStatsEnabled&&fetchCategoryStats(e.id,currentCategory.recursiveMode).then(e=>{updateCategoryStatsDisplay(e)}).catch(e=>{console.error("Failed to fetch file stats:",e)}),generateActivityHeatmap()}function saveRecursiveToggleState(e,t){const n=JSON.parse(localStorage.getItem(window.AppConstants.STORAGE_KEYS.recursiveStates)||"{}");n[e]=t,localStorage.setItem(window.AppConstants.STORAGE_KEYS.recursiveStates,JSON.stringify(n))}function loadRecursiveToggleState(e){const t=JSON.parse(localStorage.getItem(window.AppConstants.STORAGE_KEYS.recursiveStates)||"{}");return t[e]||!1}function removeRecursiveToggleState(e){const t=JSON.parse(localStorage.getItem(window.AppConstants.STORAGE_KEYS.recursiveStates)||"{}");delete t[e],localStorage.setItem(window.AppConstants.STORAGE_KEYS.recursiveStates,JSON.stringify(t))}function cleanupRecursiveToggleStates(){const t=JSON.parse(localStorage.getItem(window.AppConstants.STORAGE_KEYS.recursiveStates)||"{}"),n=new Set(categories.map(e=>e.id.toString())),e={};for(const[s,o]of Object.entries(t))n.has(s)&&(e[s]=o);localStorage.setItem(window.AppConstants.STORAGE_KEYS.recursiveStates,JSON.stringify(e))}function getCategoryBreadcrumb(e){const n=categories.find(t=>t.id===e);if(!n)return"";const s=[];let t=n;for(;t;)s.unshift(t.name),t.parent_id?t=categories.find(e=>e.id===t.parent_id):t=null;return s.join(" > ")}function getInteractiveCategoryBreadcrumb(e){const s=categories.find(t=>t.id===e);if(!s)return"";const t=[];let n=s;for(;n;)t.unshift({id:n.id,name:n.name}),n.parent_id?n=categories.find(e=>e.id===n.parent_id):n=null;const o=window.innerWidth<=768;if(o){const e=t[t.length-1];if(t.length>1){const n=t[t.length-2];return`<span class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 cursor-pointer transition-colors" onclick="navigateToCategory(${n.id})">...</span> <span class="text-gray-400 dark:text-gray-500">></span> <span class="text-gray-900 dark:text-gray-100">${e.name}</span>`}return`<span class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 cursor-pointer transition-colors" onclick="navigateToAllCategories()">...</span> <span class="text-gray-400 dark:text-gray-500">></span> <span class="text-gray-900 dark:text-gray-100">${e.name}</span>`}return t.map((e,n)=>n===t.length-1?`<span class="text-gray-900 dark:text-gray-100">${e.name}</span>`:`<span class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 cursor-pointer transition-colors" onclick="navigateToCategory(${e.id})">${e.name}</span>`).join(' <span class="text-gray-400 dark:text-gray-500">></span> ')}function navigateToCategory(e){const t=categories.find(t=>t.id===e);t&&(typeof router!="undefined"&&router.navigateToCategory?router.navigateToCategory(t):selectCategory(t))}function navigateToAllCategories(){typeof router!="undefined"&&router.navigate?router.navigate("/"):deselectCategory()}window.navigateToCategory=navigateToCategory,window.navigateToAllCategories=navigateToAllCategories;async function getAllDescendantCategories(e){const t=[],n=categories.filter(t=>t.parent_id===e);for(const e of n){t.push(e);const s=await getAllDescendantCategories(e.id);t.push(...s)}return t}async function getAllPostsRecursively(e){let n=[],s=0;const o=window.AppConstants.UI_CONFIG.categoryBatchLimit;let t=!0;for(;t;)try{const a=await fetchPosts(e,o,s,!0,!0);if(!a){t=!1;continue}const i=a.posts||a;!i||!Array.isArray(i)||i.length===0?t=!1:(n=[...n,...i],s+=i.length,a.has_more!==0[0]?t=a.has_more:t=i.length===o)}catch(e){console.error("Error fetching posts for deletion preview:",e);break}return n}async function deleteCategory(e){const o=e.recursive_post_count||0,s=await getAllDescendantCategories(e.id),i=s.length;let t=`${window.AppConstants.USER_MESSAGES.confirm.deleteCategory} "${e.name}"?`;i>0&&(t+=`

This will also delete **${i}** subcategory(ies)`),o>0&&(t+=` and **${o}** post(s)`,t+="."),t+=window.AppConstants.USER_MESSAGES.confirm.undoWarning;let n="";s.length>0&&(n+='<div class="mb-4"><h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Subcategories to be deleted:</h4>',n+='<div class="bg-gray-50 dark:bg-gray-800 rounded p-3 max-h-32 overflow-y-auto"><ul class="text-sm text-gray-600 dark:text-gray-400 space-y-1">',s.forEach(e=>{const t=getCategoryBreadcrumb(e.id);n+=`<li>• ${t}</li>`}),n+="</ul></div></div>");const a=await showConfirmation("Delete Category",t,n);if(a)try{await deleteCategoryApi(e.id),removeRecursiveToggleState(e.id),await fetchCategories(),showSuccess(`Category "${e.name}" ${window.AppConstants.USER_MESSAGES.success.categoryDeleted}`),cleanupRecursiveToggleStates(),currentCategory&&currentCategory.id===e.id&&(currentCategory=null,localStorage.removeItem(window.AppConstants.STORAGE_KEYS.lastCategory),document.getElementById("timeline-title").textContent="",document.getElementById("new-post-btn").style.display="none",document.getElementById("settings-btn").style.display="block",document.getElementById("theme-toggle-btn").style.display="block",document.getElementById("recursive-toggle-btn").style.display="none",document.getElementById("category-actions-dropdown").style.display="none",document.getElementById("posts-container").innerHTML="")}catch(e){showError(formatMessage(window.AppConstants.USER_MESSAGES.error.failedToDeleteCategory,e.message))}}function getSortPreference(){const e=localStorage.getItem(window.AppConstants.STORAGE_KEYS.categorySortPref);return e?JSON.parse(e):{field:"name",ascending:!0}}function setSortPreference(e,t){const n={field:e,ascending:t};localStorage.setItem(window.AppConstants.STORAGE_KEYS.categorySortPref,JSON.stringify(n))}function sortCategories(e){const t=getSortPreference(),n=[...e];return n.sort((e,n)=>{let s,o;switch(t.field){case"name":s=e.name.toLowerCase(),o=n.name.toLowerCase();break;case"posts":s=e.recursive_post_count||0,o=n.recursive_post_count||0;break;case"created":s=e.created||0,o=n.created||0;break;default:return 0}let i=0;return s<o?i=-1:s>o&&(i=1),t.ascending?i:-i}),n}function updateSortFooterVisibility(){const t=document.getElementById("category-sort-footer");if(!t)return;const n=categories.filter(e=>!e.parent_id);let e=n.length>=2;if(!e)for(const t of categories)if(expandedCategories.has(t.id)){const n=categories.filter(e=>e.parent_id===t.id);if(n.length>=2){e=!0;break}}t.style.display=e?"block":"none"}function initializeSortFooter(){const e=document.getElementById("category-sort-footer");if(!e)return;const t=e.querySelectorAll(".sort-option"),n=getSortPreference();updateSortButtonStates(),t.forEach(e=>{e.addEventListener("click",()=>{const t=e.dataset.sort,n=getSortPreference();let s=!0;n.field===t&&(s=!n.ascending),setSortPreference(t,s),updateSortButtonStates(),renderCategories()})})}function updateSortButtonStates(){const e=document.getElementById("category-sort-footer");if(!e)return;const n=e.querySelectorAll(".sort-option"),t=getSortPreference();n.forEach(e=>{const o=e.dataset.sort,s=t.field===o,n=e.querySelector(".sort-icon");if(s?(e.classList.remove("text-gray-600"),e.classList.add("text-blue-600","font-medium")):(e.classList.remove("text-blue-600","font-medium"),e.classList.add("text-gray-600")),n&&s){const e=n.dataset.asc,s=n.dataset.desc;n.className=`fas ${t.ascending?e:s} ml-1 sort-icon`}})}async function addFileToSelection(e){const t=window.currentSettings||await loadAppSettings();if(selectedFiles.size>=t.maxFilesPerPost)return showError(formatMessage(window.AppConstants.USER_MESSAGES.error.maxFilesExceeded,t.maxFilesPerPost)),!1;const n=t.maxFileSizeMB*window.AppConstants.UI_CONFIG.fileSizeUnit*window.AppConstants.UI_CONFIG.fileSizeUnit;if(e.size>n)return showError(formatMessage(window.AppConstants.USER_MESSAGES.error.fileSizeExceeded,e.name,t.maxFileSizeMB)),!1;const s=++fileCounter;return selectedFiles.set(s,e),updateFilePreview(),!0}function removeFileFromSelection(e){selectedFiles.delete(e),updateFilePreview()}window.removeFileFromSelection=removeFileFromSelection;function updateFilePreview(){const e=document.getElementById("file-preview-container");if(e.innerHTML="",selectedFiles.size===0)return;const t=Array.from(selectedFiles.entries());t.forEach(([t,n])=>{const s=document.createElement("div");s.className="flex items-center justify-between bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded p-3";const i=n.type.startsWith("image/");let o="";if(i){const e=URL.createObjectURL(n);o=`<img src="${e}" class="w-12 h-12 object-cover rounded mr-3">`}else o=`<div class="w-12 h-12 bg-gray-200 dark:bg-gray-700 rounded mr-3 flex items-center justify-center">
                <i class="fas fa-file text-gray-500 dark:text-gray-400"></i>
            </div>`;s.innerHTML=`
            <div class="flex items-center">
                ${o}
                <div>
                    <p class="text-sm font-medium text-gray-900 dark:text-gray-100 truncate" style="max-width: ${window.AppConstants.UI_CONFIG.maxFilenameDisplay}px;">${n.name}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">${formatFileSize(n.size)}</p>
                </div>
            </div>
            <button type="button" onclick="removeFileFromSelection(${t})" class="text-red-600 hover:text-red-800 p-1">
                <i class="fas fa-times"></i>
            </button>
        `,e.appendChild(s)})}function updatePastedFilesDisplay(){const e=document.getElementById("pasted-files-display");if(e.innerHTML="",window.pastedFiles&&window.pastedFiles.length>0){const t=document.createElement("div");t.className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",t.textContent="Pasted Images:",e.appendChild(t),window.pastedFiles.forEach((t,n)=>{const s=document.createElement("div");s.className="flex items-center justify-between bg-blue-50 border border-blue-200 rounded p-2 mb-1",s.innerHTML=`
                <span class="text-sm text-blue-700">
                    <i class="fas fa-image mr-2"></i>${t.name}
                </span>
                <button type="button" onclick="removePastedFile(${n})" class="text-red-600 hover:text-red-800">
                    <i class="fas fa-times"></i>
                </button>
            `,e.appendChild(s)})}}function removePastedFile(e){window.pastedFiles&&window.pastedFiles.length>e&&(window.pastedFiles.splice(e,1),updatePastedFilesDisplay())}window.removePastedFile=removePastedFile;async function addModalFileToSelection(e){const t=window.currentSettings||await loadAppSettings();if(modalSelectedFiles.size>=t.maxFilesPerPost)return showError(formatMessage(window.AppConstants.USER_MESSAGES.error.maxFilesExceeded,t.maxFilesPerPost)),!1;const n=t.maxFileSizeMB*window.AppConstants.UI_CONFIG.fileSizeUnit*window.AppConstants.UI_CONFIG.fileSizeUnit;if(e.size>n)return showError(formatMessage(window.AppConstants.USER_MESSAGES.error.fileSizeExceeded,e.name,t.maxFileSizeMB)),!1;const s=++modalFileCounter;return modalSelectedFiles.set(s,e),updateModalFilePreview(),!0}function removeModalFileFromSelection(e){modalSelectedFiles.delete(e),updateModalFilePreview()}window.removeModalFileFromSelection=removeModalFileFromSelection;function updateModalFilePreview(){const t=document.getElementById("modal-file-preview-container"),e=document.getElementById("modal-file-preview-list");if(modalSelectedFiles.size===0&&(!window.modalPastedFiles||window.modalPastedFiles.length===0)){t.style.display="none",updateModalFileSizeDisplay();return}t.style.display="block",e.innerHTML="";const n=Array.from(modalSelectedFiles.entries());n.forEach(([t,n])=>{const s=createModalFilePreviewElement(t,n,"file");e.appendChild(s)}),window.modalPastedFiles&&window.modalPastedFiles.length>0&&window.modalPastedFiles.forEach((t,n)=>{const s=createModalFilePreviewElement(n,t,"pasted");e.appendChild(s)}),updateModalFileSizeDisplay(),updateModalNavigationButtons()}function createModalFilePreviewElement(e,t,n){const s=document.createElement("div"),o=formatFileSize(t.size),i=`${t.name} • ${o}`,a=t.type.startsWith("image/"),r=n==="pasted"?`removeModalPastedFile(${e})`:`removeModalFileFromSelection(${e})`,c=t.name.split(".").pop()||"FILE";if(s.className="flex flex-col flex-shrink-0",a){const e=URL.createObjectURL(t);s.innerHTML=`
            <div class="relative w-20 h-20 group cursor-pointer" onclick="openModalImagePreview('${t.name}', '${e}'); event.stopPropagation();" title="${i}">
                <img src="${e}"
                     alt="${t.name}"
                     class="w-full h-full object-cover rounded-lg border hover:opacity-90 transition-opacity"
                     onload="window.URL.revokeObjectURL(this.src)">
                <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 hover:opacity-100 transition-opacity rounded-lg pointer-events-none">
                    <div class="absolute bottom-0 left-0 right-0 p-1">
                        <p class="text-white text-xs truncate leading-tight">${t.name}</p>
                        <p class="text-white/80 text-xs">${o}</p>
                    </div>
                </div>
            </div>
            <button type="button" onclick="${r}; event.stopPropagation();"
                    class="text-xs text-red-600 hover:text-red-800 mt-1 block text-center">
                Delete
            </button>
        `}else{const e=getFileIcon(c);s.innerHTML=`
            <div class="relative w-20 h-20 group cursor-pointer" title="${i}">
                <div class="w-full h-full bg-gray-100 dark:bg-gray-800 border dark:border-gray-700 rounded-lg flex flex-col items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                    <i class="fas ${e} text-2xl text-gray-600 dark:text-gray-400 mb-1"></i>
                    <span class="text-xs text-gray-500 dark:text-gray-400 font-medium">${c.toUpperCase()}</span>
                </div>
                <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 hover:opacity-100 transition-opacity rounded-lg pointer-events-none">
                    <div class="absolute bottom-0 left-0 right-0 p-1">
                        <p class="text-white text-xs truncate leading-tight">${t.name}</p>
                        <p class="text-white/80 text-xs">${o}</p>
                    </div>
                </div>
            </div>
            <button type="button" onclick="${r}; event.stopPropagation();"
                    class="text-xs text-red-600 hover:text-red-800 mt-1 block text-center">
                Delete
            </button>
        `}return a&&s.addEventListener("click",function(e){if(!e.target.closest("button")){const e=URL.createObjectURL(t);openModalImagePreview(t.name,e)}}),s}function generateFilePreview(e){const t=e.type.startsWith("image/"),n=e.type==="application/pdf",s=e.type.startsWith("video/"),o=e.type.startsWith("audio/"),i=isCodeFile(e.name),a=isArchiveFile(e.type),r=isDocumentFile(e.type);if(t){const t=URL.createObjectURL(e);return`<img src="${t}" class="w-full h-full object-cover rounded-lg border" onload="window.URL.revokeObjectURL(this.src)">`}if(n)return`<div class="w-full h-full bg-red-50 flex flex-col items-center justify-center">
            <i class="fas fa-file-pdf text-red-500 text-lg mb-1"></i>
            <span class="text-xs text-red-600 font-medium">PDF</span>
        </div>`;if(s)return`<div class="w-full h-full bg-purple-50 flex flex-col items-center justify-center">
            <i class="fas fa-play-circle text-purple-500 text-lg mb-1"></i>
            <span class="text-xs text-purple-600 font-medium">${getVideoFormat(e.type)}</span>
        </div>`;if(o)return`<div class="w-full h-full bg-green-50 flex flex-col items-center justify-center">
            <i class="fas fa-music text-green-500 text-lg mb-1"></i>
            <span class="text-xs text-green-600 font-medium">${getAudioFormat(e.type)}</span>
        </div>`;if(i){const t=getCodeLanguage(e.name);return`<div class="w-full h-full bg-blue-50 flex flex-col items-center justify-center">
            <i class="fas fa-code text-blue-500 text-lg mb-1"></i>
            <span class="text-xs text-blue-600 font-medium">${t}</span>
        </div>`}return a?`<div class="w-full h-full bg-orange-50 flex flex-col items-center justify-center">
            <i class="fas fa-file-archive text-orange-500 text-lg mb-1"></i>
            <span class="text-xs text-orange-600 font-medium">ZIP</span>
        </div>`:r?`<div class="w-full h-full bg-indigo-50 flex flex-col items-center justify-center">
            <i class="fas fa-file-alt text-indigo-500 text-lg mb-1"></i>
            <span class="text-xs text-indigo-600 font-medium">DOC</span>
        </div>`:`<div class="w-full h-full bg-gray-50 dark:bg-gray-800 flex flex-col items-center justify-center">
            <i class="fas fa-file text-gray-500 dark:text-gray-400 text-lg mb-1"></i>
            <span class="text-xs text-gray-600 dark:text-gray-400 font-medium">FILE</span>
        </div>`}function isCodeFile(e){return window.AppConstants.FILE_EXTENSIONS.code.some(t=>e.toLowerCase().endsWith(t))}function isArchiveFile(e){return["application/zip","application/x-rar-compressed","application/x-7z-compressed","application/x-tar","application/gzip"].includes(e)}function isDocumentFile(e){return["application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"].includes(e)}function getCodeLanguage(e){const t=e.toLowerCase().split(".").pop(),n={js:"JS",ts:"TS",jsx:"JSX",tsx:"TSX",py:"PY",java:"JAVA",cpp:"C++",c:"C",h:"C/H",css:"CSS",html:"HTML",php:"PHP",rb:"RUBY",go:"GO",rs:"RUST",swift:"SWIFT",kt:"KOTLIN",scala:"SCALA",sql:"SQL",json:"JSON",xml:"XML",yaml:"YAML",yml:"YAML",sh:"BASH",bash:"BASH",ps1:"PS",r:"R",m:"MATLAB",vue:"VUE",svelte:"SVELTE"};return n[t]||"CODE"}function getVideoFormat(e){const t=e.toLowerCase();for(const[e,n]of Object.entries(window.AppConstants.VIDEO_FORMAT_MAP))if(t.includes(e))return n;return"VIDEO"}function getAudioFormat(e){const t=e.toLowerCase();for(const[e,n]of Object.entries(window.AppConstants.AUDIO_FORMAT_MAP))if(t.includes(e))return n;return"AUDIO"}function updateModalFileSizeDisplay(){const t=document.getElementById("modal-file-size-display");let n=0,e=0;if(modalSelectedFiles.forEach(t=>{n+=t.size,e++}),window.modalPastedFiles&&window.modalPastedFiles.length>0&&window.modalPastedFiles.forEach(t=>{n+=t.size,e++}),e===0)t.style.display="none";else{t.style.display="block";const s=formatFileSize(n);t.innerHTML=`<i class="fas fa-paperclip text-xs mr-1"></i>${e} file${e>1?"s":""} • ${s}`}}function updateModalPastedFilesDisplay(){updateModalFilePreview()}function removeModalPastedFile(e){window.modalPastedFiles&&window.modalPastedFiles.length>e&&(window.modalPastedFiles.splice(e,1),updateModalFilePreview())}function updateModalNavigationButtons(){const e=document.getElementById("modal-file-preview-list"),t=document.getElementById("modal-file-prev"),n=document.getElementById("modal-file-next"),s=document.getElementById("modal-file-counter");if(!e||!t||!n||!s)return;const o=modalSelectedFiles.size+(window.modalPastedFiles?window.modalPastedFiles.length:0);if(o===0){s.textContent="0 / 0",t.disabled=!0,n.disabled=!0;return}s.textContent=`${o} / ${o}`;function i(){const s=e.scrollLeft>0,o=e.scrollLeft<e.scrollWidth-e.clientWidth;t.disabled=!s,n.disabled=!o}e.removeEventListener("scroll",e.updateButtonVisibility),e.updateButtonVisibility=i,e.addEventListener("scroll",i),i()}function scrollModalAttachments(e){const t=document.getElementById("modal-file-preview-list");if(!t)return;const n=200;t.scrollBy({left:e*n,behavior:"smooth"})}window.scrollModalAttachments=scrollModalAttachments;function openModalImagePreview(e,t){window.currentImageGallery=[{url:t,filename:e}],window.currentImageIndex=0;const n=document.getElementById("image-viewer-modal");n.classList.remove("hidden"),document.body.style.overflow="hidden";const s=document.getElementById("viewer-image"),o=document.getElementById("viewer-filename"),i=document.getElementById("viewer-counter");s.src=t,o.textContent=e,i.textContent="",document.getElementById("viewer-prev").style.display="none",document.getElementById("viewer-next").style.display="none"}window.openModalImagePreview=openModalImagePreview;function openImageGallery(e=0){const t=event.target.closest("[data-images]"),n=t.getAttribute("data-images");if(n)currentImageGallery=JSON.parse(n);else{const e=t.querySelector("img");currentImageGallery=[{url:e.src,filename:e.alt}]}currentImageIndex=e;const s=document.getElementById("image-viewer-modal");s.classList.remove("hidden"),document.body.style.overflow="hidden",updateImageViewer();const o=document.getElementById("viewer-prev"),i=document.getElementById("viewer-next");o.style.display=currentImageGallery.length>1?"block":"none",i.style.display=currentImageGallery.length>1?"block":"none"}window.openImageGallery=openImageGallery;function updateImageViewer(){const n=document.getElementById("viewer-image"),s=document.getElementById("viewer-filename"),e=document.getElementById("viewer-counter"),t=currentImageGallery[currentImageIndex];n.src=t.url,s.textContent=t.filename,currentImageGallery.length>1?e.textContent=`${currentImageIndex+1} / ${currentImageGallery.length}`:e.textContent=""}function closeImageViewer(){const e=document.getElementById("image-viewer-modal");e.classList.add("hidden"),document.body.style.overflow=""}function navigateImage(e){if(currentImageGallery.length<=1)return;e==="prev"?currentImageIndex=currentImageIndex>0?currentImageIndex-1:currentImageGallery.length-1:currentImageIndex=currentImageIndex<currentImageGallery.length-1?currentImageIndex+1:0,updateImageViewer()}let currentLinkPreviews=[],linkPreviewCounter=0;const URL_WITH_PROTOCOL=/https?:\/\/[^\s]+/g,URL_WITHOUT_PROTOCOL=/(?:^|\s)((?:[a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}(?:\/[^\s]*)?)/g;function extractURLsFromText(e){const n=new Set,s=e.match(URL_WITH_PROTOCOL);s&&s.forEach(e=>n.add(e));let t;const o=new RegExp(URL_WITHOUT_PROTOCOL);for(;(t=o.exec(e))!==null;){const s=t[1],o=t.index+t[0].indexOf(s),i=e.substring(Math.max(0,o-8),o);i.match(/https?:\/\/$/)||n.add("https://"+s)}return Array.from(n)}async function fetchLinkPreviewLocal(e){return await fetchLinkPreview(e)}function updateLinkPreviewDisplay(){const e=document.getElementById("link-preview-container");if(!e)return;if(currentLinkPreviews.length===0){e.innerHTML="",e.style.display="none";return}e.style.display="block";try{e.innerHTML=`
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Link Previews</label>
            <div class="space-y-3">
                ${currentLinkPreviews.map(e=>createLinkPreviewElement(e)).join("")}
            </div>
        `}catch{}}function createLinkPreviewElement(e){const t=e.image_url&&e.image_url.trim()!=="";return`
        <div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden hover:border-gray-300 dark:hover:border-gray-600 transition-colors" data-preview-id="${e.id}">
            <div class="flex">
                ${t?`
                    <div class="flex-shrink-0 w-24 h-24">
                        <img src="${escapeHtml(e.image_url)}"
                             alt=""
                             class="w-full h-full object-cover"
                             onerror="this.parentElement.style.display='none'">
                    </div>
                `:""}
                <div class="flex-1 p-3 min-w-0">
                    <div class="flex items-start justify-between">
                        <div class="flex-1 min-w-0">
                            <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 line-clamp-2 mb-1">
                                ${escapeHtml(e.title)}
                            </h4>
                            ${e.description?`
                                <p class="text-xs text-gray-600 dark:text-gray-400 line-clamp-2 mb-2">
                                    ${escapeHtml(e.description)}
                                </p>
                            `:""}
                            <div class="flex items-center text-xs text-gray-500 dark:text-gray-400">
                                <i class="fas fa-link mr-1"></i>
                                <span class="truncate">
                                    ${e.site_name?escapeHtml(e.site_name):new URL(e.url).hostname}
                                </span>
                            </div>
                        </div>
                        <button type="button"
                                onclick="removeLinkPreview(${e.id})"
                                class="ml-2 p-1 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 rounded">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `}function removeLinkPreview(e){currentLinkPreviews=currentLinkPreviews.filter(t=>t.id!==e),updateLinkPreviewDisplay()}window.removeLinkPreview=removeLinkPreview;function createPostLinkPreviewElement(e){const t=e.image_url&&e.image_url.trim()!=="";return`
        <a href="${escapeHtml(e.url)}"
           target="_blank"
           rel="noopener noreferrer"
           class="block border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden hover:border-gray-300 dark:hover:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-800 transition-all flex-shrink-0 w-full">
            <div class="flex">
                ${t?`
                    <div class="flex-shrink-0 w-32 h-24">
                        <img src="${escapeHtml(e.image_url)}"
                             alt=""
                             class="w-full h-full object-cover"
                             onerror="this.parentElement.style.display='none'">
                    </div>
                `:""}
                <div class="flex-1 p-4 min-w-0">
                    <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 line-clamp-2 mb-2">
                        ${escapeHtml(e.title)}
                    </h4>
                    ${e.description?`
                        <p class="text-xs text-gray-600 dark:text-gray-400 line-clamp-3 mb-2">
                            ${escapeHtml(e.description)}
                        </p>
                    `:""}
                    <div class="flex items-center text-xs text-gray-500 dark:text-gray-400">
                        <i class="fas fa-external-link-alt mr-1"></i>
                        <span class="truncate">
                            ${e.site_name?escapeHtml(e.site_name):new URL(e.url).hostname}
                        </span>
                    </div>
                </div>
            </div>
        </a>
    `}function createPostLinkPreviewsContainer(e,t){return!e||e.length===0?"":`
        <div class="mb-4 mt-4">
            <div class="flex items-center justify-between mb-2">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Link Previews</label>
                <div class="flex items-center space-x-2">
                    <button type="button" class="post-link-prev p-1 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 disabled:opacity-30" disabled onclick="navigatePostLinkPreview(${t}, -1)">
                        <i class="fas fa-chevron-left text-xs"></i>
                    </button>
                    <span class="post-link-counter text-xs text-gray-500 dark:text-gray-400">1 / ${e.length}</span>
                    <button type="button" class="post-link-next p-1 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 disabled:opacity-30" ${e.length===1?"disabled":""} onclick="navigatePostLinkPreview(${t}, 1)">
                        <i class="fas fa-chevron-right text-xs"></i>
                    </button>
                </div>
            </div>
            <div class="relative overflow-hidden">
                <div class="flex transition-transform duration-300 ease-in-out" data-post-link-list>
                    ${e.map(e=>createPostLinkPreviewElement(e)).join("")}
                </div>
            </div>
        </div>
    `}const postLinkPreviewState={};function navigatePostLinkPreview(e,t){const s=document.querySelector(`[data-post-id="${e}"]`);if(!s)return;const i=s.querySelector("[data-post-link-list]"),a=s.querySelector(".post-link-counter"),r=s.querySelector(".post-link-prev"),c=s.querySelector(".post-link-next");if(!i||!a)return;const o=i.children.length;if(o===0)return;postLinkPreviewState[e]||(postLinkPreviewState[e]={currentIndex:0});const n=postLinkPreviewState[e];t===-1&&n.currentIndex>0?n.currentIndex--:t===1&&n.currentIndex<o-1&&n.currentIndex++;const l=-n.currentIndex*100;i.style.transform=`translateX(${l}%)`,a.textContent=`${n.currentIndex+1} / ${o}`,r&&(r.disabled=n.currentIndex===0),c&&(c.disabled=n.currentIndex===o-1)}window.navigatePostLinkPreview=navigatePostLinkPreview;function initializeLinkPreview(){const e=document.getElementById("post-content");if(!e)return;e.linkPreviewInputHandler&&e.removeEventListener("input",e.linkPreviewInputHandler),e.linkPreviewInputHandler=async t=>{const n=t.target.value;e.linkPreviewTimeout&&clearTimeout(e.linkPreviewTimeout),e.linkPreviewTimeout=setTimeout(async()=>{await processTextForLinks(n)},window.AppConstants.UI_CONFIG.debounceDelay)},e.addEventListener("input",e.linkPreviewInputHandler),e.value.trim()&&processTextForLinks(e.value)}async function processTextForLinks(e){const t=extractURLsFromText(e);if(t.length===0){currentLinkPreviews=[],updateLinkPreviewDisplay();return}const n=currentLinkPreviews.map(e=>e.url),s=t.filter(e=>!n.includes(e));currentLinkPreviews=currentLinkPreviews.filter(e=>t.includes(e.url));for(const e of s)try{const t=await fetchLinkPreviewLocal(e);t.error||currentLinkPreviews.push({id:++linkPreviewCounter,url:t.url,title:t.title||e,description:t.description||"",image_url:t.image_url||"",site_name:t.site_name||""})}catch{}updateLinkPreviewDisplay()}function resetLinkPreviews(){currentLinkPreviews=[],linkPreviewCounter=0;const e=document.getElementById("link-preview-container");e&&(e.style.display="none",e.innerHTML="")}function getCurrentLinkPreviews(){return currentLinkPreviews.map(e=>({url:e.url,title:e.title,description:e.description,image_url:e.image_url,site_name:e.site_name}))}let modalCurrentLinkPreviews=[],modalLinkPreviewCounter=0,modalCurrentLinkIndex=0;function updateModalLinkPreviewDisplay(){const e=document.getElementById("modal-link-preview-container"),t=document.getElementById("modal-link-preview-list"),n=document.getElementById("modal-link-counter"),s=document.getElementById("modal-link-prev"),o=document.getElementById("modal-link-next");if(!e||!t)return;if(modalCurrentLinkPreviews.length===0){e.style.display="none";return}e.style.display="block";try{t.innerHTML=modalCurrentLinkPreviews.map(e=>createModalLinkPreviewElement(e)).join(""),n.textContent=`${modalCurrentLinkIndex+1} / ${modalCurrentLinkPreviews.length}`,s.disabled=modalCurrentLinkIndex===0,o.disabled=modalCurrentLinkIndex===modalCurrentLinkPreviews.length-1;const e=-modalCurrentLinkIndex*100;t.style.transform=`translateX(${e}%)`}catch{}}function createModalLinkPreviewElement(e){const t=e.image_url&&e.image_url.trim()!=="";return`
        <div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden hover:border-gray-300 dark:hover:border-gray-600 transition-colors flex-shrink-0 w-full" data-preview-id="${e.id}">
            <div class="flex">
                ${t?`
                    <div class="flex-shrink-0 w-24 h-24">
                        <img src="${escapeHtml(e.image_url)}"
                             alt=""
                             class="w-full h-full object-cover"
                             onerror="this.parentElement.style.display='none'">
                    </div>
                `:""}
                <div class="flex-1 p-3 min-w-0">
                    <div class="flex items-start justify-between">
                        <div class="flex-1 min-w-0">
                            <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 line-clamp-2 mb-1">
                                ${escapeHtml(e.title)}
                            </h4>
                            ${e.description?`
                                <p class="text-xs text-gray-600 dark:text-gray-400 line-clamp-2 mb-2">
                                    ${escapeHtml(e.description)}
                                </p>
                            `:""}
                            <div class="flex items-center text-xs text-gray-500 dark:text-gray-400">
                                <i class="fas fa-link mr-1"></i>
                                <span class="truncate">
                                    ${e.site_name?escapeHtml(e.site_name):new URL(e.url).hostname}
                                </span>
                            </div>
                        </div>
                        <button type="button"
                                onclick="removeModalLinkPreview(${e.id})"
                                class="ml-2 p-1 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 rounded">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `}function removeModalLinkPreview(e){modalCurrentLinkPreviews=modalCurrentLinkPreviews.filter(t=>t.id!==e),modalCurrentLinkIndex>=modalCurrentLinkPreviews.length&&modalCurrentLinkPreviews.length>0?modalCurrentLinkIndex=modalCurrentLinkPreviews.length-1:modalCurrentLinkPreviews.length===0&&(modalCurrentLinkIndex=0),updateModalLinkPreviewDisplay()}window.removeModalLinkPreview=removeModalLinkPreview;function navigateModalLinkPreview(e){e==="prev"&&modalCurrentLinkIndex>0?modalCurrentLinkIndex--:e==="next"&&modalCurrentLinkIndex<modalCurrentLinkPreviews.length-1&&modalCurrentLinkIndex++,updateModalLinkPreviewDisplay()}function initializeModalLinkPreview(){const e=document.getElementById("modal-post-content");if(!e)return;e.linkPreviewInputHandler&&e.removeEventListener("input",e.linkPreviewInputHandler),e.linkPreviewInputHandler=async t=>{const n=t.target.value;e.linkPreviewTimeout&&clearTimeout(e.linkPreviewTimeout),e.linkPreviewTimeout=setTimeout(async()=>{await processModalTextForLinks(n)},window.AppConstants.UI_CONFIG.debounceDelay)},e.addEventListener("input",e.linkPreviewInputHandler),e.value.trim()&&processModalTextForLinks(e.value)}async function processModalTextForLinks(e){const t=extractURLsFromText(e);if(t.length===0){modalCurrentLinkPreviews=[],updateModalLinkPreviewDisplay();return}const n=modalCurrentLinkPreviews.map(e=>e.url),s=t.filter(e=>!n.includes(e));modalCurrentLinkPreviews=modalCurrentLinkPreviews.filter(e=>t.includes(e.url));for(const e of s)try{const t=await fetchLinkPreviewLocal(e);t.error||modalCurrentLinkPreviews.push({id:++modalLinkPreviewCounter,url:t.url,title:t.title||e,description:t.description||"",image_url:t.image_url||"",site_name:t.site_name||""})}catch{}updateModalLinkPreviewDisplay()}function resetModalLinkPreviews(){modalCurrentLinkPreviews=[],modalLinkPreviewCounter=0,modalCurrentLinkIndex=0;const e=document.getElementById("modal-link-preview-container");e&&(e.style.display="none")}function getCurrentModalLinkPreviews(){return modalCurrentLinkPreviews.map(e=>({url:e.url,title:e.title,description:e.description,image_url:e.image_url,site_name:e.site_name}))}let currentPosts=[],currentOffset=0,hasMorePosts=!0,isLoadingPosts=!1,virtualScroller=null;const VIRTUAL_SCROLL_THRESHOLD=window.AppConstants.UI_CONFIG.virtualScrollThreshold;async function loadPosts(e,t=!1,n=!0){if(isLoadingPosts)return;try{isLoadingPosts=!0,n&&(currentPosts=[],currentOffset=0,hasMorePosts=!0);const o=await fetchPosts(e,window.AppConstants.UI_CONFIG.defaultPostsPerPage,currentOffset,!1,t);let s=o.posts||o;(!s||!Array.isArray(s))&&(s=[]),n?currentPosts=s:currentPosts=[...currentPosts,...s],o&&o.has_more!==0[0]?hasMorePosts=o.has_more:hasMorePosts=s.length===window.AppConstants.UI_CONFIG.defaultPostsPerPage,currentOffset+=s.length,renderPosts(currentPosts,n),n&&setupInfiniteScroll(e,t)}catch(e){console.error("Failed to fetch posts:",e),n&&renderPosts([])}finally{isLoadingPosts=!1}}async function loadMorePosts(e,t=!1){if(!hasMorePosts||isLoadingPosts)return;await loadPosts(e,t,!1)}function setupInfiniteScroll(e,t=!1){const n=document.getElementById("posts-container");window.removeEventListener("scroll",window.infiniteScrollHandler),window.infiniteScrollHandler=()=>{if(!hasMorePosts||isLoadingPosts)return;const n=window.innerHeight+window.scrollY,s=document.documentElement.offsetHeight-window.AppConstants.UI_CONFIG.infiniteScrollThreshold;n>=s&&loadMorePosts(e,t)},window.addEventListener("scroll",window.infiniteScrollHandler)}function renderPosts(e,t=!0){const n=document.getElementById("posts-container");if((!e||!Array.isArray(e))&&(e=[]),t){if(virtualScroller&&(virtualScroller.destroy(),virtualScroller=null),e.length===0){n.innerHTML=`
                <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                    <i class="fas fa-inbox text-4xl mb-4"></i>
                    <p>${window.AppConstants.UI_TEXT.noPostsYet}</p>
                </div>
            `;return}if(e.length>VIRTUAL_SCROLL_THRESHOLD){virtualScroller||(virtualScroller=new PostVirtualScroller(n)),virtualScroller.setItems(e);return}n.innerHTML=""}if(virtualScroller&&e.length>VIRTUAL_SCROLL_THRESHOLD)if(t)virtualScroller.setItems(e);else{const t=e.slice(currentPosts.length-(e.length-currentPosts.length));virtualScroller.addItems(t)}else{if(t)e.forEach(e=>{const t=createPostElement(e);n.appendChild(t)});else{const t=new Set(Array.from(n.querySelectorAll("[data-post-id]")).map(e=>parseInt(e.dataset.postId)));e.forEach(e=>{if(!t.has(e.id)){const t=createPostElement(e);n.appendChild(t)}})}hasMorePosts&&!isLoadingPosts&&!virtualScroller&&addLoadingIndicator(n)}}function addLoadingIndicator(e){const t=e.querySelector(".loading-indicator");if(t&&t.remove(),hasMorePosts){const t=document.createElement("div");t.className="loading-indicator text-center py-4",t.innerHTML=`
            <div class="text-gray-500 dark:text-gray-400">
                <i class="fas fa-spinner fa-spin mr-2"></i>
                ${window.AppConstants.USER_MESSAGES.info.loadingMorePosts}
            </div>
        `,e.appendChild(t)}}function createPostElement(e){const n=document.createElement("div");n.className="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6 mb-6 hover:shadow-md transition-shadow group max-w-full",n.setAttribute("data-post-id",e.id);const o=e.attachments?e.attachments.filter(e=>e.file_type.startsWith("image/")):[],d=e.attachments?e.attachments.filter(e=>!e.file_type.startsWith("image/")):[],t=o.length+d.length,l=e.link_previews||[],c=!currentCategory||currentCategory.id===window.AppConstants.ALL_CATEGORIES_ID||currentCategory&&currentCategory.recursiveMode&&e.category_id!==currentCategory.id,g=c?getCategoryBreadcrumb(e.category_id):"",m=c?`<span class="text-xs font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 px-2 py-1 rounded cursor-pointer hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors" onclick="navigateToCategoryFromPost(${e.category_id})">${g}</span>`:"",u=`
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-2">
                ${m}
                <span class="relative group/time text-sm text-gray-600 dark:text-gray-400 font-sans cursor-default">
                    ${formatRelativeDate(e.created)}
                    <div class="absolute left-0 top-full mt-1 px-2 py-1 bg-gray-900 text-white text-xs rounded-md shadow-lg opacity-0 group-hover/time:opacity-100 transition-opacity duration-200 pointer-events-none z-50 whitespace-nowrap">
                        ${formatFullDateTime(e.created)}
                    </div>
                </span>
            </div>
            <div class="relative opacity-0 group-hover:opacity-100 transition-all">
                <button onclick="togglePostActionMenu(${e.id})" class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 p-1 rounded transition-all">
                    <i class="fas fa-ellipsis-h text-sm"></i>
                </button>
                <div id="post-action-menu-${e.id}" class="absolute right-0 top-full mt-1 w-32 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-md shadow-lg z-50 hidden">
                    <div class="py-1">
                        <button onclick="showMoveModal(${e.id})" class="flex items-center w-full px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                            <i class="fas fa-exchange-alt text-xs mr-2"></i>
                            Move
                        </button>
                        <button onclick="confirmDeletePost(${e.id})" class="flex items-center w-full px-3 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                            <i class="fas fa-trash-alt text-xs mr-2"></i>
                            Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `,h=/https?:\/\/\S+/g,a=e.content.match(h),f=a&&a.length===1&&e.content.trim()===a[0],p=f&&l.length>0,s=document.createElement("div");s.className="mb-4 post-content font-content text-gray-900 dark:text-gray-100",p&&(s.style.display="none");const v=document.getElementById("markdown-css"),b=v!==null;let r=e.content;b?s.innerHTML=`<div class="markdown-body text-gray-900 dark:text-gray-100">${r}</div>`:(r=formatTextWithUrls(e.content),s.innerHTML=`<div class="text-gray-900 dark:text-gray-100">${r}</div>`);const j=s.innerHTML,y=t>0?"":createPostLinkPreviewsContainer(l,e.id);let i="";if(t>0){i='<div class="border-t pt-3 mt-4">';const e=[...o,...d],n=o.map(e=>({url:"/uploads/"+e.file_path,filename:e.filename}));i+=`
            <div>
                <div class="flex items-center justify-between mb-2">
                    <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Attachments</h4>
                    <div class="flex items-center space-x-2">
                        <button type="button" class="post-attachment-prev p-1 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 disabled:opacity-30" disabled onclick="scrollAttachments(this, -1)">
                            <i class="fas fa-chevron-left text-xs"></i>
                        </button>
                        <span class="post-attachment-counter text-xs text-gray-500 dark:text-gray-400">${t} / ${t}</span>
                        <button type="button" class="post-attachment-next p-1 text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-300 disabled:opacity-30" disabled onclick="scrollAttachments(this, 1)">
                            <i class="fas fa-chevron-right text-xs"></i>
                        </button>
                    </div>
                </div>
                <div class="relative overflow-hidden">
                    <div class="flex items-center space-x-3 overflow-x-auto pb-2 scroll-smooth" data-attachment-container>
                        ${e.map((e)=>{const r=e.file_type.startsWith("image/"),i=e.filename.split(".").pop().toLowerCase(),s=e.file_size?formatFileSize(e.file_size):"",a=`${e.filename}${s?" • "+s:""}`;if(r){const t=o.findIndex(t=>t.filename===e.filename);return`
                                    <div class="relative flex-shrink-0 w-20 h-20 group cursor-pointer" onclick="openImageGallery(${t})" data-images='${JSON.stringify(n)}' title="${a}">
                                        <img src="/uploads/${e.file_path}"
                                             alt="${e.filename}"
                                             class="w-full h-full object-cover rounded-lg border hover:opacity-90 transition-opacity">
                                        <div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/60 to-transparent p-1 rounded-b-lg opacity-0 hover:opacity-100 transition-opacity">
                                            <p class="text-white text-xs truncate leading-tight">${e.filename}</p>
                                            ${s?`<p class="text-white/80 text-xs">${s}</p>`:""}
                                        </div>
                                    </div>
                                `}return`
                                    <div class="relative flex-shrink-0 w-20 h-20 group cursor-pointer" onclick="window.open('/uploads/${e.file_path}', '_blank')" title="${a}">
                                        <div class="w-full h-full bg-gray-100 dark:bg-gray-800 border dark:border-gray-700 rounded-lg flex flex-col items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                                            <i class="fas ${getFileIcon(i)} text-2xl text-gray-600 dark:text-gray-400 mb-1"></i>
                                            <span class="text-xs text-gray-500 dark:text-gray-400 font-medium">${i.toUpperCase()}</span>
                                        </div>
                                        <div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/60 to-transparent p-1 rounded-b-lg opacity-0 hover:opacity-100 transition-opacity">
                                            <p class="text-white text-xs truncate leading-tight">${e.filename}</p>
                                            ${s?`<p class="text-white/80 text-xs">${s}</p>`:""}
                                        </div>
                                    </div>
                                `}).join("")}
                    </div>
                </div>
            </div>
        `,i+="</div>"}return n.innerHTML=u+j+y+i,t>0&&setTimeout(()=>setupAttachmentNavigation(n),0),n}function togglePostActionMenu(e){document.querySelectorAll('[id^="post-action-menu-"]').forEach(t=>{t.id!==`post-action-menu-${e}`&&t.classList.add("hidden")});const t=document.getElementById(`post-action-menu-${e}`);t&&t.classList.toggle("hidden")}window.togglePostActionMenu=togglePostActionMenu,document.addEventListener("click",function(e){!e.target.closest('[id^="post-action-menu-"]')&&!e.target.closest('button[onclick*="togglePostActionMenu"]')&&document.querySelectorAll('[id^="post-action-menu-"]').forEach(e=>{e.classList.add("hidden")})});let currentMovePostId=null;function showMoveModal(e){currentMovePostId=e;const t=currentPosts.find(t=>t.id===e);if(!t)return;const n=categories.find(e=>e.id===t.category_id),s=n?getCategoryBreadcrumb(t.category_id):"Unknown Category";document.getElementById("current-category-display").textContent=s,populateMoveCategoryDropdown(t.category_id),document.getElementById("move-modal").classList.remove("hidden"),document.querySelectorAll('[id^="post-action-menu-"]').forEach(e=>{e.classList.add("hidden")})}window.showMoveModal=showMoveModal;function populateMoveCategoryDropdown(e){const t=document.getElementById("move-category");t.innerHTML='<option value="">Select a category...</option>',categories.forEach(n=>{if(n.id!==e){const s=getCategoryBreadcrumb(n.id),e=document.createElement("option");e.value=n.id,e.textContent=s,t.appendChild(e)}})}function hideMoveModal(){document.getElementById("move-modal").classList.add("hidden"),document.getElementById("move-category").value="",currentMovePostId=null}document.getElementById("cancel-move").addEventListener("click",hideMoveModal),document.getElementById("move-form").addEventListener("submit",async function(e){if(e.preventDefault(),!currentMovePostId)return;const t=parseInt(document.getElementById("move-category").value);if(!t){showError(window.AppConstants.USER_MESSAGES.error.selectCategoryToMove);return}try{const n=currentPosts.find(e=>e.id===currentMovePostId),s=n?n.category_id:null;await movePost(currentMovePostId,t),s&&incrementCategoryPostCount(s,-1),incrementCategoryPostCount(t,1);const o=categories.find(e=>e.id===t),i=o?o.name:"selected category";showSuccess(`${window.AppConstants.USER_MESSAGES.success.postMoved} ${i}`);let e=!1;if(currentCategory&&currentCategory.id!==window.AppConstants.ALL_CATEGORIES_ID)if(currentCategory.recursiveMode){const n=categories.find(e=>e.id===t);if(n){const n=isDescendantCategory(t,currentCategory.id);e=t!==currentCategory.id&&!n}else e=!0}else e=t!==currentCategory.id;if(e)currentPosts=currentPosts.filter(e=>e.id!==currentMovePostId),virtualScroller&&virtualScroller.removeItem(currentMovePostId);else{const e=currentPosts.findIndex(e=>e.id===currentMovePostId);e!==-1&&(currentPosts[e].category_id=t)}renderPosts(currentPosts,!0),currentCategory&&updateCategoryStatsDisplay(),setTimeout(generateActivityHeatmap,100),hideMoveModal()}catch(e){showError(`Failed to move post: ${e.message}`)}});async function confirmDeletePost(e){const t=currentPosts.find(t=>t.id===e),s=t&&t.attachments?t.attachments:[];let o="Are you sure you want to delete this post?";s.length>0&&(o+=`

This will also delete **${s.length}** attached file(s).`),o+=`

This action cannot be undone.`;let n="";s.length>0&&(n+='<div class="mb-4"><h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Files to be deleted:</h4>',n+='<div class="bg-gray-50 dark:bg-gray-800 rounded p-3 max-h-32 overflow-y-auto"><ul class="text-sm text-gray-600 dark:text-gray-400 space-y-1">',s.forEach(e=>{n+=`<li class="flex justify-between items-center">
                <span>• ${e.filename}</span>
                <span class="text-xs text-gray-400 dark:text-gray-500">${formatFileSize(e.file_size)}</span>
            </li>`}),n+="</ul></div></div>");const i=await showConfirmation("Delete Post",o,n);if(i)try{await deletePost(e),showSuccess(""),t&&t.category_id&&incrementCategoryPostCount(t.category_id,-1),updateCategoryStatsDisplay(),setTimeout(generateActivityHeatmap,100),currentPosts=currentPosts.filter(t=>t.id!==e),virtualScroller?virtualScroller.removeItem(e):renderPosts(currentPosts,!0)}catch(e){console.error(e),showError(formatMessage(window.AppConstants.USER_MESSAGES.error.failedToDeletePost,e.message))}}window.confirmDeletePost=confirmDeletePost;function updateCategoryStatsDisplay(e){if(!currentCategory)return;if(currentCategory.id===window.AppConstants.ALL_CATEGORIES_ID){updateAllCategoriesDisplay();return}const t=categories.find(e=>e.id===currentCategory.id);if(t){const e=currentCategory.recursiveMode;currentCategory={...t},currentCategory.recursiveMode=e}const n=currentCategory.recursiveMode?currentCategory.recursive_post_count||0:currentCategory.post_count||0;let s=`${n} post${n!==1?"s":""}`;fileStatsEnabled&&e&&e.file_count>0&&(s+=` • ${e.file_count} file${e.file_count!==1?"s":""} • ${formatFileSize(e.total_size)}`);const i=getInteractiveCategoryBreadcrumb(currentCategory.id),o=currentCategory.created?new Date(currentCategory.created).toLocaleDateString(window.AppConstants.LOCALE_SETTINGS.default,{year:"numeric",month:"long",day:"numeric"}):"Date unavailable",a=currentCategory.description&&currentCategory.description.trim()?currentCategory.description:`Created ${o}`;document.getElementById("timeline-title").innerHTML=`
        <div class="group relative">
            <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">${i}</h2>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5 relative">
                <span class="transition-opacity group-hover:opacity-0">${s}</span>
                <span class="absolute top-0 left-0 opacity-0 group-hover:opacity-100 transition-opacity">${o}</span>
            </p>
            ${currentCategory.description&&currentCategory.description.trim()?`
                <div class="absolute left-0 top-full mt-1 px-3 py-2 bg-gray-900 text-white text-sm rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none z-50 max-w-md">
                    ${currentCategory.description.trim().replace(/</g,"&lt;").replace(/>/g,"&gt;")}
                </div>
            `:""}
        </div>
    `,updateHeaderButtons()}function updateHeaderButtons(){if(!currentCategory){document.getElementById("recursive-toggle-btn").style.display="none",document.getElementById("category-actions-dropdown").style.display="none",document.getElementById("settings-btn").style.display="block";return}const t=categories.some(e=>e.parent_id===currentCategory.id),e=document.getElementById("recursive-toggle-btn");t?(e.style.display="block",currentCategory.recursiveMode?e.className="flex items-center justify-center h-8 px-3 text-sm font-medium text-white bg-blue-600 border border-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors":e.className="flex items-center justify-center h-8 px-3 text-sm font-medium text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 dark:focus:ring-gray-400 focus:border-gray-500 transition-colors"):e.style.display="none",document.getElementById("category-actions-dropdown").style.display="block",document.getElementById("settings-btn").style.display="none"}function navigateToCategoryFromPost(e){const t=categories.find(t=>t.id===e);t&&selectCategory(t)}window.navigateToCategoryFromPost=navigateToCategoryFromPost;function updateAllCategoriesDisplay(e){const t=categories.reduce((e,t)=>t.parent_id?e:e+(t.recursive_post_count||t.post_count||0),0),n=categories.reduce((e,t)=>!e||t.created<e.created?t:e,null),o=n?new Date(n.created).toLocaleDateString(window.AppConstants.LOCALE_SETTINGS.default,{year:"numeric",month:"long",day:"numeric"}):"Date unavailable";let s=`${t} post${t!==1?"s":""}`;fileStatsEnabled&&e&&e.file_count>0&&(s+=` • ${e.file_count} file${e.file_count!==1?"s":""} • ${formatFileSize(e.total_size)}`),document.getElementById("timeline-title").innerHTML=`
        <div class="group">
            <h2 class="text-xl font-bold text-gray-900 dark:text-gray-100">${window.AppConstants.UI_TEXT.allCategories}</h2>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5 relative">
                <span class="transition-opacity group-hover:opacity-0">${s}</span>
                <span class="absolute top-0 left-0 opacity-0 group-hover:opacity-100 transition-opacity">${o}</span>
            </p>
        </div>
    `,document.getElementById("recursive-toggle-btn").style.display="none",document.getElementById("category-actions-dropdown").style.display="none",document.getElementById("settings-btn").style.display="block"}function isDescendantCategory(e,t){const n=categories.find(t=>t.id===e);return!!n&&!!n.parent_id&&(n.parent_id===t||isDescendantCategory(n.parent_id,t))}function incrementCategoryPostCount(e,t){const n=categories.find(t=>t.id===e);n&&(n.post_count=(n.post_count||0)+t,n.recursive_post_count=(n.recursive_post_count||0)+t);let s=n;const o=[e];for(;s&&s.parent_id;){const e=categories.find(e=>e.id===s.parent_id);if(e)e.recursive_post_count=(e.recursive_post_count||0)+t,o.push(e.id),s=e;else break}currentCategory&&o.includes(currentCategory.id)&&(currentCategory.id===e?(currentCategory.post_count=(currentCategory.post_count||0)+t,currentCategory.recursive_post_count=(currentCategory.recursive_post_count||0)+t):currentCategory.recursive_post_count=(currentCategory.recursive_post_count||0)+t),renderCategories()}function setupAttachmentNavigation(e){const t=e.querySelector("[data-attachment-container]"),n=e.querySelector(".post-attachment-prev"),s=e.querySelector(".post-attachment-next");if(!t||!n||!s)return;function o(){const e=t.scrollLeft>0,o=t.scrollLeft<t.scrollWidth-t.clientWidth;n.disabled=!e,s.disabled=!o}t.addEventListener("scroll",o),o()}function scrollAttachments(e,t){const n=e.closest("div").parentNode.querySelector("[data-attachment-container]");if(!n)return;const s=200;n.scrollBy({left:t*s,behavior:"smooth"})}window.scrollAttachments=scrollAttachments;let currentSettings={},originalSettings={};function initializeSettings(){document.getElementById("settings-btn").addEventListener("click",showSettingsPageEvent),document.getElementById("settings-back-btn").addEventListener("click",hideSettingsPage),document.getElementById("cancel-settings-btn").addEventListener("click",cancelSettings),document.getElementById("save-settings-btn").addEventListener("click",saveSettings),document.getElementById("retroactivePostingEnabled").addEventListener("change",toggleRetroactiveTimeFormatVisibility)}function toggleRetroactiveTimeFormatVisibility(){const t=document.getElementById("retroactivePostingEnabled").checked,e=document.getElementById("retroactivePostingTimeFormatContainer");e&&(e.style.display=t?"block":"none")}async function showSettingsPageEvent(){window.router.navigate("/settings"),showSettingsPage()}function hideSettingsPage(){window.router?typeof categories=="undefined"||!categories||categories.length===0?(window.router.navigate("/"),initializeApp()):router.handleCategoryRoute("/"):(document.getElementById("settings-page").classList.add("hidden"),document.querySelector(".container").style.display="block",clearSettingsStatus())}async function loadSettings(){try{currentSettings=await loadAppSettings(),originalSettings={...currentSettings}}catch(e){throw console.error("Error loading settings:",e),e}}function populateSettingsForm(){document.getElementById("maxContentLength").value=currentSettings.maxContentLength||window.AppConstants.DEFAULT_SETTINGS.maxContentLength,document.getElementById("siteTitle").value=currentSettings.siteTitle||window.AppConstants.APP_NAME,document.getElementById("siteDescription").value=currentSettings.siteDescription||window.AppConstants.APP_DESCRIPTION,document.getElementById("activityEnabled").checked=currentSettings.activityEnabled!==0[0]?currentSettings.activityEnabled:window.AppConstants.DEFAULT_SETTINGS.activityEnabled,document.getElementById("fileStatsEnabled").checked=currentSettings.fileStatsEnabled!==0[0]?currentSettings.fileStatsEnabled:window.AppConstants.DEFAULT_SETTINGS.fileStatsEnabled,document.getElementById("retroactivePostingEnabled").checked=currentSettings.retroactivePostingEnabled!==0[0]&&currentSettings.retroactivePostingEnabled,document.getElementById("fileUploadEnabled").checked=currentSettings.fileUploadEnabled===0[0]||currentSettings.fileUploadEnabled,document.getElementById("maxFileSizeMB").value=currentSettings.maxFileSizeMB||window.AppConstants.DEFAULT_SETTINGS.maxFileSizeMB,document.getElementById("maxFilesPerPost").value=currentSettings.maxFilesPerPost||window.AppConstants.DEFAULT_SETTINGS.maxFilesPerPost,currentSettings.allowedFileExtensions&&Array.isArray(currentSettings.allowedFileExtensions)?document.getElementById("allowedFileExtensions").value=currentSettings.allowedFileExtensions.join(", "):document.getElementById("allowedFileExtensions").value=window.AppConstants.DEFAULT_ALLOWED_EXTENSIONS;const e=currentSettings.retroactivePostingTimeFormat||window.AppConstants.DEFAULT_SETTINGS.retroactivePostingTimeFormat;document.getElementById("retroactivePostingTimeFormat").value=e,updateSiteDescriptionCounter(),toggleRetroactiveTimeFormatVisibility(),toggleFileUploadDetails()}function getSettingsFromForm(){const e=document.getElementById("allowedFileExtensions").value,t=e.split(",").map(e=>e.trim().toLowerCase()).filter(e=>e.length>0);return{maxContentLength:parseInt(document.getElementById("maxContentLength").value),siteTitle:document.getElementById("siteTitle").value.trim(),siteDescription:document.getElementById("siteDescription").value.trim(),activityEnabled:document.getElementById("activityEnabled").checked,fileStatsEnabled:document.getElementById("fileStatsEnabled").checked,retroactivePostingEnabled:document.getElementById("retroactivePostingEnabled").checked,retroactivePostingTimeFormat:document.getElementById("retroactivePostingTimeFormat").value,fileUploadEnabled:document.getElementById("fileUploadEnabled").checked,maxFileSizeMB:parseInt(document.getElementById("maxFileSizeMB").value),maxFilesPerPost:parseInt(document.getElementById("maxFilesPerPost").value),allowedFileExtensions:t}}function validateSettings(e){const t=[];return(e.maxFileSizeMB<window.AppConstants.VALIDATION_LIMITS.minFileSizeMB||e.maxFileSizeMB>window.AppConstants.VALIDATION_LIMITS.maxFileSizeMB)&&t.push(formatMessage(window.AppConstants.USER_MESSAGES.validation.fileSizeValidation,window.AppConstants.VALIDATION_LIMITS.minFileSizeMB,window.AppConstants.VALIDATION_LIMITS.maxFileSizeMB,window.AppConstants.VALIDATION_LIMITS.maxFileSizeMB/1024)),(e.maxContentLength<window.AppConstants.VALIDATION_LIMITS.minContentLength||e.maxContentLength>window.AppConstants.VALIDATION_LIMITS.maxContentLength)&&t.push(formatMessage(window.AppConstants.USER_MESSAGES.validation.contentLengthValidation,window.AppConstants.VALIDATION_LIMITS.minContentLength,window.AppConstants.VALIDATION_LIMITS.maxContentLength)),(e.maxFilesPerPost<window.AppConstants.VALIDATION_LIMITS.minFilesPerPost||e.maxFilesPerPost>window.AppConstants.VALIDATION_LIMITS.maxFilesPerPost)&&t.push(formatMessage(window.AppConstants.USER_MESSAGES.validation.filesPerPostValidation,window.AppConstants.VALIDATION_LIMITS.minFilesPerPost,window.AppConstants.VALIDATION_LIMITS.maxFilesPerPost)),(!e.siteTitle||e.siteTitle.length===0||e.siteTitle.length>window.AppConstants.VALIDATION_LIMITS.maxSiteTitleLength)&&t.push(`Site title must be between 1 and ${window.AppConstants.VALIDATION_LIMITS.maxSiteTitleLength} characters`),e.siteDescription.length>window.AppConstants.VALIDATION_LIMITS.maxSiteDescriptionLength&&t.push(`Site description must not exceed ${window.AppConstants.VALIDATION_LIMITS.maxSiteDescriptionLength} characters`),t}async function saveSettings(){const e=getSettingsFromForm(),t=validateSettings(e);if(t.length>0){showSettingsStatus(t.join("<br>"),"error");return}try{showSettingsStatus(window.AppConstants.USER_MESSAGES.info.savingSettings,"info");const t=await fetch("/api/settings",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){const e=await t.text();throw new Error(e||`HTTP error! status: ${t.status}`)}const n=await t.json();typeof clearSettingsCache=="function"&&clearSettingsCache(),currentSettings=n,originalSettings={...n},refreshUIWithNewSettings(),typeof checkActivityEnabled=="function"&&await checkActivityEnabled(),typeof checkFileStatsEnabled=="function"&&await checkFileStatsEnabled(),n.siteTitle&&updatePageTitle(n.siteTitle),showSuccess(window.AppConstants.USER_MESSAGES.success.settingsSaved),setTimeout(()=>{window.router?window.router.navigate("/"):hideSettingsPage()},window.AppConstants.UI_CONFIG.successMessageDelay)}catch(e){console.error("Error saving settings:",e),showError(formatMessage(window.AppConstants.USER_MESSAGES.error.failedToSaveSettings,e.message))}}function cancelSettings(){populateSettingsForm(),window.router?window.router.navigate("/"):hideSettingsPage()}function showSettingsStatus(e,t="info"){const n=document.getElementById("settings-status");switch(n.classList.remove("hidden"),n.classList.remove("text-green-600","text-red-600","text-blue-600","text-gray-600"),t){case"success":n.classList.add("text-green-600");break;case"error":n.classList.add("text-red-600");break;case"info":n.classList.add("text-blue-600");break;default:n.classList.add("text-gray-600")}n.innerHTML=e}function clearSettingsStatus(){const e=document.getElementById("settings-status");e.classList.add("hidden"),e.innerHTML=""}async function refreshUIWithNewSettings(){typeof refreshCharacterCounter=="function"&&await refreshCharacterCounter(),typeof updateFileUploadText=="function"&&await updateFileUploadText()}function updateMarkdownCSS(e){const t=document.getElementById("markdown-css");e?(document.body.classList.remove("markdown-disabled"),t&&t.removeAttribute("disabled")):(document.body.classList.add("markdown-disabled"),t&&t.setAttribute("disabled","disabled"))}function toggleFileUploadDetails(){const t=document.getElementById("fileUploadEnabled").checked,e=document.getElementById("fileUploadDetails");t?e.style.display="block":e.style.display="none"}function updateSiteDescriptionCounter(){const e=document.getElementById("siteDescription"),t=document.getElementById("site-description-counter");e&&t&&(t.textContent=e.value.length)}function updatePageTitle(e){const t=window.router?.getCurrentRoute();t==="/settings"?document.title=`${e} - Settings`:(t==="/"||!t)&&(document.title=`${e} - Personal Micro Blog`)}document.addEventListener("DOMContentLoaded",function(){initializeSettings();const e=document.getElementById("fileUploadEnabled");e&&(e.addEventListener("change",toggleFileUploadDetails),setTimeout(()=>toggleFileUploadDetails(),100));const t=document.getElementById("siteDescription");t&&t.addEventListener("input",updateSiteDescriptionCounter)});function initializeStickyHeader(){window.addEventListener("scroll",handleStickyHeaderScroll)}function handleStickyHeaderScroll(){const e=document.getElementById("timeline-header");if(!e)return;const n=window.scrollY,t=n>window.AppConstants.UI_CONFIG.scrollThreshold;t&&!e.classList.contains("scrolled")?(e.classList.add("scrolled"),document.body.classList.add("header-scrolled")):!t&&e.classList.contains("scrolled")&&(e.classList.remove("scrolled"),document.body.classList.remove("header-scrolled"))}async function showCreatePost(){if(!currentCategory){showError(window.AppConstants.USER_MESSAGES.error.pleaseSelectCategory);return}document.getElementById("create-post-modal").classList.remove("hidden"),document.body.style.overflow="hidden";const e=getCategoryFullBreadcrumb(currentCategory);document.getElementById("modal-category-name").textContent=e,document.getElementById("modal-post-content").focus();try{const e=window.currentSettings,t=document.getElementById("modal-retroactive-section"),n=document.getElementById("modal-attachments-section");if(e&&e.retroactivePostingEnabled){t.style.setProperty("display","block","important");const i=e.retroactivePostingTimeFormat||"24h",n=new Date;let s;if(i==="12h"){const t=String(n.getMonth()+1).padStart(2,"0"),o=String(n.getDate()).padStart(2,"0"),i=n.getFullYear();let e=n.getHours();const a=String(n.getMinutes()).padStart(2,"0"),r=e>=12?window.AppConstants.TIME_FORMAT.pm:window.AppConstants.TIME_FORMAT.am;e=e%12||12,s=`${t}/${o}/${i} ${String(e).padStart(2,"0")}:${a} ${r}`}else{const e=String(n.getDate()).padStart(2,"0"),t=String(n.getMonth()+1).padStart(2,"0"),o=n.getFullYear(),i=String(n.getHours()).padStart(2,"0"),a=String(n.getMinutes()).padStart(2,"0");s=`${e}/${t}/${o} ${i}:${a}`}const o=document.getElementById("modal-post-datetime");o.value=s,o.dataset.originalValue=s,o.dataset.timeFormat=i}else t.style.setProperty("display","none","important");e&&e.fileUploadEnabled!==!1?n.style.display="block":n.style.display="none"}catch(e){console.error("Failed to load settings:",e),document.getElementById("modal-retroactive-section").style.setProperty("display","none","important")}setTimeout(()=>{initializeModalLinkPreview()},window.AppConstants.UI_CONFIG.settingsTransitionDelay)}function hideCreatePost(){document.getElementById("create-post-modal").classList.add("hidden"),document.body.style.overflow="",document.getElementById("modal-create-post-form").reset();const e=document.getElementById("modal-post-datetime");e&&(e.value=""),modalSelectedFiles.clear(),window.modalPastedFiles=[],updateModalFilePreview(),resetModalLinkPreviews();const t=document.getElementById("modal-char-counter");t&&window.currentSettings&&(t.textContent=`0 / ${window.currentSettings.maxContentLength}`)}function showCategoryModal(){document.getElementById("category-modal").classList.remove("hidden"),document.body.style.overflow="hidden";const e=document.getElementById("category-parent");currentCategory&&currentCategory.id!==window.AppConstants.ALL_CATEGORIES_ID?e.value=currentCategory.id.toString():e.value="",document.getElementById("category-name").setAttribute("maxlength",window.AppConstants.VALIDATION_LIMITS.maxCategoryNameLength),document.getElementById("category-name").focus()}function hideCategoryModal(){document.getElementById("category-modal").classList.add("hidden"),document.body.style.overflow="",document.getElementById("category-form").reset(),document.getElementById("category-description").value="",updateDescriptionCounter("category-description","description-counter")}function handleCategoryModalClose(){hasCategoryContent()?confirm(window.AppConstants.USER_MESSAGES.confirm.unsavedContent)&&hideCategoryModal():hideCategoryModal()}function hasCategoryContent(){const e=document.getElementById("category-name").value.trim(),t=document.getElementById("category-description").value.trim();return e.length>0||t.length>0}function showEditCategoryModal(){if(!currentCategory||currentCategory.id===window.AppConstants.ALL_CATEGORIES_ID){showError(window.AppConstants.USER_MESSAGES.error.pleaseSelectCategory);return}document.getElementById("edit-category-modal").classList.remove("hidden"),document.body.style.overflow="hidden",document.getElementById("edit-category-name").value=currentCategory.name,document.getElementById("edit-category-description").value=currentCategory.description||"",updateDescriptionCounter("edit-category-description","edit-description-counter");const e=document.querySelector("#edit-category-modal .mb-4:has(#edit-category-parent)");function t(e){const s=categories.filter(t=>t.parent_id===e);if(s.length===0)return 0;let n=0;for(let e of s){const o=1+t(e.id);n=Math.max(n,o)}return n}const o=t(currentCategory.id),n=new Set([currentCategory.id]);function s(e){const t=categories.filter(t=>t.parent_id===e);t.forEach(e=>{n.add(e.id),s(e.id)})}s(currentCategory.id);const i=categories.some(e=>{if(n.has(e.id))return!1;const t=e.depth+1+o;return t<=window.AppConstants.MAX_CATEGORY_DEPTH});i?(e&&(e.style.display="block"),populateEditCategorySelect(),currentCategory.parent_id?document.getElementById("edit-category-parent").value=currentCategory.parent_id.toString():document.getElementById("edit-category-parent").value=""):e&&(e.style.display="none"),document.getElementById("edit-category-name").setAttribute("maxlength",window.AppConstants.VALIDATION_LIMITS.maxCategoryNameLength),document.getElementById("edit-category-name").focus()}function hideEditCategoryModal(){document.getElementById("edit-category-modal").classList.add("hidden"),document.body.style.overflow="",document.getElementById("edit-category-form").reset(),document.getElementById("edit-category-description").value="",updateDescriptionCounter("edit-category-description","edit-description-counter")}function handleEditCategoryModalClose(){hasEditCategoryContentChanged()?confirm(window.AppConstants.USER_MESSAGES.confirm.unsavedContent)&&hideEditCategoryModal():hideEditCategoryModal()}function hasEditCategoryContentChanged(){if(!currentCategory)return!1;const t=document.getElementById("edit-category-name").value.trim(),n=document.getElementById("edit-category-description").value.trim(),e=document.getElementById("edit-category-parent").value||null,s=currentCategory.parent_id?currentCategory.parent_id.toString():null,o=e?e.toString():null,i=t!==currentCategory.name,a=n!==(currentCategory.description||""),r=s!==o;return i||a||r}function populateCategorySelect(){const e=document.getElementById("category-parent");e.innerHTML='<option value="">None (Root Category)</option>';const t=categories.filter(e=>e.depth<window.AppConstants.MAX_CATEGORY_DEPTH);t.forEach(t=>{const n=document.createElement("option");n.value=t.id;const s=getCategoryBreadcrumbPath(t.id,!0);n.textContent=s,e.appendChild(n)})}function populateEditCategorySelect(){const e=document.getElementById("edit-category-parent");e.innerHTML='<option value="">None (Root Category)</option>';const t=new Set([currentCategory.id]);function n(e){const s=categories.filter(t=>t.parent_id===e);s.forEach(e=>{t.add(e.id),n(e.id)})}n(currentCategory.id);function s(e){const n=categories.filter(t=>t.parent_id===e);if(n.length===0)return 0;let t=0;for(let e of n){const o=1+s(e.id);t=Math.max(t,o)}return t}const o=s(currentCategory.id),i=categories.filter(e=>{if(t.has(e.id))return!1;const n=e.depth+1+o;return n<=window.AppConstants.MAX_CATEGORY_DEPTH});i.forEach(t=>{const n=document.createElement("option");n.value=t.id;const s=getCategoryBreadcrumbPath(t.id,!0);n.textContent=s,e.appendChild(n)})}function getCategoryBreadcrumbPath(e,t=!1){const o=categories.find(t=>t.id===e);if(!o)return"";const n=[];let s=o;for(;s;)n.unshift(s.name),s.parent_id?s=categories.find(e=>e.id===s.parent_id):s=null;if(t&&n.length>1){const e=n.slice(0,-1).join(" > "),t=n[n.length-1];return`${e} ➤ ${t}`}return n.join(" > ")}function updateDescriptionCounter(e,t){const n=document.getElementById(e),s=document.getElementById(t);n&&s&&(s.textContent=n.value.length)}function getCategoryFullBreadcrumb(e){if(!e||e.id===window.AppConstants.ALL_CATEGORIES_ID)return window.AppConstants.UI_TEXT.allCategories;const n=[];let t=e;for(;t;)n.unshift(t.name),t.parent_id?t=categories.find(e=>e.id===t.parent_id):t=null;return n.join(" > ")}class VirtualScroller{constructor(e,t=window.AppConstants.UI_CONFIG.defaultItemHeight){this.container=e,this.itemHeight=t,this.visibleItems=Math.ceil(window.innerHeight/t)+window.AppConstants.UI_CONFIG.virtualScrollBuffer,this.scrollTop=0,this.items=[],this.renderedItems=new Map,this.viewport=document.createElement("div"),this.viewport.style.cssText="position: relative; overflow: auto; height: 100%;",this.content=document.createElement("div"),this.content.style.cssText="position: relative;",this.viewport.appendChild(this.content),this.container.innerHTML="",this.container.appendChild(this.viewport),this.viewport.addEventListener("scroll",this.handleScroll.bind(this)),window.addEventListener("resize",this.handleResize.bind(this))}setItems(e){this.items=e,this.updateContentHeight(),this.render()}addItems(e){this.items=[...this.items,...e],this.updateContentHeight(),this.render()}removeItem(e){this.items=this.items.filter(t=>t.id!==e),this.updateContentHeight(),this.render()}updateContentHeight(){const e=this.items.length*this.itemHeight;this.content.style.height=`${e}px`}handleScroll(){this.scrollTop=this.viewport.scrollTop,this.render()}handleResize(){this.visibleItems=Math.ceil(window.innerHeight/this.itemHeight)+window.AppConstants.UI_CONFIG.virtualScrollBuffer,this.render()}render(){const e=Math.floor(this.scrollTop/this.itemHeight),t=Math.min(e+this.visibleItems,this.items.length);for(const[n,s]of this.renderedItems.entries())(n<e||n>=t)&&(s.parentNode&&s.parentNode.removeChild(s),this.renderedItems.delete(n));for(let n=e;n<t;n++)if(!this.renderedItems.has(n)&&this.items[n]){const e=this.createItemElement(this.items[n]);e.style.cssText=`position: absolute; top: ${n*this.itemHeight}px; left: 0; right: 0;`,this.content.appendChild(e),this.renderedItems.set(n,e)}}createItemElement(e){const t=document.createElement("div");return t.textContent=`Item ${e.id}`,t.style.height=`${this.itemHeight}px`,t}scrollToTop(){this.viewport.scrollTop=0}destroy(){window.removeEventListener("resize",this.handleResize.bind(this)),this.viewport.removeEventListener("scroll",this.handleScroll.bind(this))}}class PostVirtualScroller extends VirtualScroller{constructor(e){super(e,window.AppConstants.UI_CONFIG.postsVirtualScrollHeight),this.postHeights=new Map}createItemElement(e){const t=createPostElement(e);document.body.appendChild(t);const n=t.offsetHeight;return document.body.removeChild(t),this.postHeights.set(e.id,n),t}getItemHeight(e){const t=this.items[e];return this.postHeights.get(t.id)||this.itemHeight}}async function initializeModalCharacterCounter(){const t=document.getElementById("modal-post-content"),e=document.getElementById("modal-char-counter");if(!t||!e)return;function n(){const n=window.currentSettings;if(!n)return;const s=t.value.length;e.textContent=`${s} / ${n.maxContentLength}`,s>n.maxContentLength*.9?(e.classList.remove("text-gray-500","text-yellow-600"),e.classList.add("text-red-600")):s>n.maxContentLength*.7?(e.classList.remove("text-gray-500","text-red-600"),e.classList.add("text-yellow-600")):(e.classList.remove("text-yellow-600","text-red-600"),e.classList.add("text-gray-500"));const o=document.getElementById("modal-submit-post");s===0||s>n.maxContentLength?(o.disabled=!0,o.classList.add("opacity-50","cursor-not-allowed")):(o.disabled=!1,o.classList.remove("opacity-50","cursor-not-allowed"))}n(),t.addEventListener("input",n)}function initializeAutoResizeTextarea(){const e=document.getElementById("modal-post-content");if(!e)return;const n=100,s=200;function t(){e.style.height="auto";const t=Math.min(Math.max(e.scrollHeight,n),s);e.style.height=t+"px"}e.addEventListener("input",t),t()}function handleModalClose(){hasModalContent()?confirm(window.AppConstants.USER_MESSAGES.confirm.unsavedContent)&&hideCreatePost():hideCreatePost()}function hasModalContent(){const e=document.getElementById("modal-post-content").value.trim(),t=modalSelectedFiles.size>0||window.modalPastedFiles&&window.modalPastedFiles.length>0,n=modalCurrentLinkPreviews.length>0;return e.length>0||t||n}async function updateFileUploadText(){const e=document.getElementById("modal-file-upload-text");if(!e)return;const t=window.currentSettings;if(!t)return;e.textContent=`Or drag and drop files here (max ${t.maxFilesPerPost} files)`}function updateCategoryContainerHeight(){const n=document.getElementById("categories-container"),s=document.getElementById("footer-links"),o=document.getElementById("activity-container");if(!n)return;const i=window.innerHeight,a=96;let e=0;o&&o.style.display!=="none"&&(e=330);let t=0;s&&(t=s.offsetHeight);const r=16,c=(e>0?16:0)+(t>0?16:0),l=i-a-r*2-e-t-c,d=Math.min(Math.max(l,200),800);n.style.maxHeight=`${d}px`}async function initializeApp(){const t=initializeAppSettings(),n=window.location.pathname==="/"||router.isCategoryPath(window.location.pathname)?fetchCategories():Promise.resolve();window.currentSettings=await t;const e=window.AppConstants.VALIDATION_LIMITS.maxCategoryDescriptionLength;document.getElementById("category-description").setAttribute("maxlength",e),document.getElementById("edit-category-description").setAttribute("maxlength",e),document.getElementById("description-max-length").textContent=e,document.getElementById("edit-description-max-length").textContent=e,loadExpandedCategories(),checkActivityEnabled(),checkFileStatsEnabled(),await n,initializeStickyHeader(),initializeModalCharacterCounter(),initializeAutoResizeTextarea(),updateFileUploadText(),initializeSortFooter(),updateCategoryContainerHeight()}if(document.addEventListener("DOMContentLoaded",function(){const n=document.getElementById("copyright-year");n&&(n.textContent=(new Date).getFullYear()),initializeApp(),document.getElementById("add-category-btn").onclick=showCategoryModal,document.getElementById("cancel-category").onclick=handleCategoryModalClose,document.getElementById("category-name").addEventListener("input",function(e){const n=e.target.value.trim(),t=document.querySelector('button[form="category-form"]');if(!t)return;const s=/^[a-zA-Z0-9]+(?:\s[a-zA-Z0-9]+)*$/,o=n.length>0&&s.test(n);o?(t.disabled=!1,t.classList.remove("opacity-50","cursor-not-allowed")):(t.disabled=!0,t.classList.add("opacity-50","cursor-not-allowed"))}),document.getElementById("category-form").onsubmit=async function(e){e.preventDefault();const t=document.getElementById("category-name").value.trim();if(t.length===0){showError(window.AppConstants.USER_MESSAGES.error.categoryNameEmpty);return}if(t.length>window.AppConstants.VALIDATION_LIMITS.maxCategoryNameLength){showError(formatMessage(window.AppConstants.USER_MESSAGES.error.categoryNameTooLong,window.AppConstants.VALIDATION_LIMITS.maxCategoryNameLength));return}const n=/^[a-zA-Z0-9]+(?:\s[a-zA-Z0-9]+)*$/;if(!n.test(t)){showError(window.AppConstants.USER_MESSAGES.error.categoryNameInvalidChars);return}const s=document.getElementById("category-parent").value||null,o=document.getElementById("category-description").value.trim();try{const e=await createCategory(t,s,o);if(hideCategoryModal(),e){const t=document.getElementById("posts-container");t&&(t.innerHTML=`
                        <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                            <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                            <p>Loading posts...</p>
                        </div>
                    `),populateCategorySelect(),selectCategory(e),showSuccess("")}}catch(e){showError(e.message)}},document.getElementById("new-post-btn").onclick=showCreatePost,document.getElementById("close-post-modal").onclick=handleModalClose,document.getElementById("modal-cancel-post").onclick=handleModalClose,document.getElementById("modal-link-prev").onclick=()=>navigateModalLinkPreview("prev"),document.getElementById("modal-link-next").onclick=()=>navigateModalLinkPreview("next"),document.getElementById("recursive-toggle-btn").addEventListener("click",()=>{currentCategory&&toggleRecursiveMode(currentCategory)}),document.getElementById("delete-category-btn").addEventListener("click",()=>{currentCategory&&deleteCategory(currentCategory)}),document.getElementById("edit-category-btn").addEventListener("click",()=>{currentCategory&&showEditCategoryModal()});const s=document.getElementById("category-actions-btn"),t=document.getElementById("category-actions-menu");s.addEventListener("click",e=>{e.stopPropagation(),t.classList.toggle("hidden")}),document.addEventListener("click",e=>{!s.contains(e.target)&&!t.contains(e.target)&&t.classList.add("hidden")}),document.getElementById("cancel-edit-category").onclick=handleEditCategoryModalClose,document.getElementById("category-description").addEventListener("input",function(){updateDescriptionCounter("category-description","description-counter")}),document.getElementById("edit-category-description").addEventListener("input",function(){updateDescriptionCounter("edit-category-description","edit-description-counter")}),document.getElementById("edit-category-name").addEventListener("input",function(e){const n=e.target.value.trim(),t=document.querySelector('button[form="edit-category-form"]');if(!t)return;const s=/^[a-zA-Z0-9]+(?:\s[a-zA-Z0-9]+)*$/;n.length===0||n.length>window.AppConstants.VALIDATION_LIMITS.maxCategoryNameLength||!s.test(n)?(t.disabled=!0,t.classList.add("opacity-50","cursor-not-allowed")):(t.disabled=!1,t.classList.remove("opacity-50","cursor-not-allowed"))}),document.getElementById("edit-category-form").onsubmit=async function(e){e.preventDefault();const t=document.getElementById("edit-category-name").value.trim();if(t.length===0){showError(window.AppConstants.USER_MESSAGES.error.categoryNameEmpty);return}if(t.length>window.AppConstants.VALIDATION_LIMITS.maxCategoryNameLength){showError(formatMessage(window.AppConstants.USER_MESSAGES.error.categoryNameTooLong,window.AppConstants.VALIDATION_LIMITS.maxCategoryNameLength));return}const o=/^[a-zA-Z0-9]+(?:\s[a-zA-Z0-9]+)*$/;if(!o.test(t)){showError(window.AppConstants.USER_MESSAGES.error.categoryNameInvalidChars);return}const n=document.getElementById("edit-category-parent").value||null,s=document.getElementById("edit-category-description").value.trim();if(s.length>window.AppConstants.VALIDATION_LIMITS.maxCategoryDescriptionLength){showError(formatMessage(window.AppConstants.USER_MESSAGES.error.categoryDescTooLong,window.AppConstants.VALIDATION_LIMITS.maxCategoryDescriptionLength));return}const i=currentCategory.parent_id?currentCategory.parent_id.toString():null,a=n?n.toString():null,r=t!==currentCategory.name,c=s!==(currentCategory.description||""),l=i!==a;if(!r&&!c&&!l){hideEditCategoryModal();return}try{const e=await updateCategory(currentCategory.id,t,s,n);hideEditCategoryModal(),e&&(populateCategorySelect(),selectCategory(e),showSuccess(``))}catch(e){showError(e.message)}},document.getElementById("modal-create-post-form").onsubmit=async function(e){if(e.preventDefault(),!currentCategory){showError(window.AppConstants.USER_MESSAGES.error.noCategorySelected);return}const t=document.getElementById("modal-post-content").value;if(!t.trim()){showError(window.AppConstants.USER_MESSAGES.error.contentRequired);return}const n=window.currentSettings;if(n&&t.length>n.maxContentLength){showError(window.AppConstants.USER_MESSAGES.error.contentTooLong.replace("{0}",n.maxContentLength));return}try{const o={category_id:currentCategory.id,content:t,link_previews:getCurrentModalLinkPreviews?getCurrentModalLinkPreviews():[]},e=document.getElementById("modal-post-datetime");if(e&&e.value){const t=e.dataset.originalValue!==e.value;if(t){const s=e.dataset.timeFormat||"24h";let t;if(s==="12h"?t=parseDateTime12h(e.value):t=parseDateTime24h(e.value),!t||isNaN(t.getTime())){showError("Invalid date format");return}const n=new Date(window.AppConstants.MIN_RETROACTIVE_POST_TIMESTAMP),i=new Date;if(t<n){showError(`Date cannot be earlier than ${n.toLocaleDateString()}`);return}if(t>i){showError("Date cannot be in the future");return}o.custom_timestamp=t.getTime()}}const s=await apiRequest("/posts",{method:"POST",body:JSON.stringify(o)});if(modalSelectedFiles&&modalSelectedFiles.size>0)for(let[t,e]of modalSelectedFiles)await uploadFile(s.id,e);if(window.modalPastedFiles&&window.modalPastedFiles.length>0){for(let e of window.modalPastedFiles)await uploadFile(s.id,e);window.modalPastedFiles=[]}hideCreatePost();const i=await apiRequest(`/posts/${s.id}`);let n=0;for(let e=0;e<currentPosts.length;e++){if(i.created>=currentPosts[e].created){n=e;break}n=e+1}const a=n<currentPosts.length||n===currentPosts.length&&!hasMorePosts;a&&currentPosts.splice(n,0,i),renderPosts(currentPosts,!0),incrementCategoryPostCount(currentCategory.id,1),updateCategoryStatsDisplay(),showSuccess(""),setTimeout(generateActivityHeatmap,100)}catch(e){showError(e.message)}},document.getElementById("modal-post-content").addEventListener("paste",function(e){const t=e.clipboardData.items;for(let n of t)if(n.type.startsWith("image/")){e.preventDefault();const t=n.getAsFile();if(t){window.modalPastedFiles||(window.modalPastedFiles=[]);const e=(new Date).toISOString().replace(/[:.]/g,"-"),n=t.type.split("/")[1]||"png",s=new File([t],`pasted-image-${e}.${n}`,{type:t.type});window.modalPastedFiles.push(s),updateModalPastedFilesDisplay()}}});const o=document.getElementById("modal-post-files");o.addEventListener("change",async function(e){for(let t of e.target.files)await addModalFileToSelection(t);e.target.value=""});const e=o.parentElement;e.addEventListener("dragover",function(t){t.preventDefault(),e.classList.add("bg-blue-50","border-blue-300")}),e.addEventListener("dragleave",function(t){t.preventDefault(),e.classList.remove("bg-blue-50","border-blue-300")}),e.addEventListener("drop",async function(t){t.preventDefault(),e.classList.remove("bg-blue-50","border-blue-300");for(let e of t.dataTransfer.files)await addModalFileToSelection(e)});const i=document.getElementById("modal-set-current-time");i&&i.addEventListener("click",function(){const n=document.getElementById("modal-post-datetime"),s=n.dataset.timeFormat||"24h",e=new Date;let t;if(s==="12h"){const s=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getDate()).padStart(2,"0"),i=e.getFullYear();let n=e.getHours();const a=String(e.getMinutes()).padStart(2,"0"),r=n>=12?window.AppConstants.TIME_FORMAT.pm:window.AppConstants.TIME_FORMAT.am;n=n%12||12,t=`${s}/${o}/${i} ${String(n).padStart(2,"0")}:${a} ${r}`}else{const n=String(e.getDate()).padStart(2,"0"),s=String(e.getMonth()+1).padStart(2,"0"),o=e.getFullYear(),i=String(e.getHours()).padStart(2,"0"),a=String(e.getMinutes()).padStart(2,"0");t=`${n}/${s}/${o} ${i}:${a}`}n.value=t,n.dataset.originalValue=t}),document.getElementById("viewer-close").onclick=closeImageViewer,document.getElementById("viewer-prev").onclick=()=>navigateImage("prev"),document.getElementById("viewer-next").onclick=()=>navigateImage("next"),document.addEventListener("keydown",function(e){const t=document.getElementById("image-viewer-modal"),n=document.getElementById("create-post-modal"),s=document.getElementById("category-modal"),o=document.getElementById("edit-category-modal"),i=document.getElementById("move-modal"),a=document.getElementById("confirmation-modal");if(t.classList.contains("hidden"))if(n.classList.contains("hidden"))if(s.classList.contains("hidden"))if(o.classList.contains("hidden"))if(i.classList.contains("hidden")){if(!a.classList.contains("hidden"))switch(e.key){case"Escape":document.getElementById("confirmation-cancel").click();break}}else switch(e.key){case"Escape":hideMoveModal();break}else switch(e.key){case"Escape":handleEditCategoryModalClose();break}else switch(e.key){case"Escape":handleCategoryModalClose();break}else switch(e.key){case"Escape":handleModalClose();break}else switch(e.key){case"Escape":closeImageViewer();break;case"ArrowLeft":navigateImage("prev");break;case"ArrowRight":navigateImage("next");break}}),document.getElementById("category-modal").onclick=function(e){e.target===this&&handleCategoryModalClose()},document.getElementById("edit-category-modal").onclick=function(e){e.target===this&&handleEditCategoryModalClose()},document.getElementById("image-viewer-modal").onclick=function(e){const t=e.target===this||e.target.classList.contains("absolute"),n=e.target.id==="viewer-image",s=e.target.closest("button");t&&!n&&!s&&closeImageViewer()},document.getElementById("create-post-modal").onclick=function(e){e.target===this&&handleModalClose()},document.getElementById("move-modal").onclick=function(e){e.target===this&&hideMoveModal()},document.getElementById("confirmation-modal").onclick=function(e){e.target===this&&document.getElementById("confirmation-cancel").click()}}),typeof window!="undefined"&&window.visualViewport){function handleViewportChange(){const e=window.visualViewport,t=document.querySelectorAll(".modal-mobile-full");t.forEach(t=>{if(!t.closest(".hidden")){const n=window.innerHeight-e.height;n>0?(t.style.setProperty("--keyboard-height",`${n}px`),t.classList.add("keyboard-open")):(t.style.removeProperty("--keyboard-height"),t.classList.remove("keyboard-open"))}})}window.visualViewport.addEventListener("resize",handleViewportChange)}let initialViewportHeight=window.innerHeight;function handleLegacyKeyboard(){const e=window.innerHeight,t=initialViewportHeight-e,n=document.querySelectorAll(".modal-mobile-full");n.forEach(e=>{if(!e.closest(".hidden"))if(t>150){e.classList.add("keyboard-open");const t=e.querySelector("input:focus, textarea:focus");t&&setTimeout(()=>{t.scrollIntoView({behavior:"smooth",block:"center"})},300)}else e.classList.remove("keyboard-open")})}document.addEventListener("focusin",function(e){e.target.matches(".modal-mobile-full input, .modal-mobile-full textarea")&&setTimeout(()=>{e.target.scrollIntoView({behavior:"smooth",block:"center"})},300)}),window.addEventListener("resize",function(){clearTimeout(window.resizeTimeout),window.resizeTimeout=setTimeout(function(){currentCategory&&document.getElementById("activity-container").style.display!=="none"&&currentActivityCache&&generateHeatmapFromCache(currentActivityCache),currentCategory&&currentCategory.id!==window.AppConstants.ALL_CATEGORIES_ID&&updateCategoryStatsDisplay(),updateCategoryContainerHeight(),window.visualViewport||handleLegacyKeyboard()},300)})